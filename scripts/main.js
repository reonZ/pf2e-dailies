(()=>{var _n=Object.defineProperty;var a=(e,t)=>_n(e,"name",{value:t,configurable:!0});function ne(e){return e.getFlag("core","sourceId")}a(ne,"getSourceId");function $n(e,t){let n=ne(e);return n?t.includes(n):!1}a($n,"includesSourceId");function xt(e){return Array.isArray(e)?t=>$n(t,e):t=>ne(t)===e}a(xt,"getSourceIdCondition");function kt(e,t,n){let s={};for(let r of e){let o=Array.isArray(r)?r[n??0]:typeof r=="object"&&n!=null?r[n]:r;s[o]=t(r)}return s}a(kt,"arrayToObject");function Re(e,t){let n=[];if(e<=t)for(let s=e;s<=t;s++)n.push(s);else for(let s=e;s>=t;s--)n.push(s);return n}a(Re,"sequenceArray");var Le=(async()=>{}).constructor;function et(e,t){if(typeof e!="object")return!1;let n=Reflect.getPrototypeOf(e);for(;n;){if(n.constructor.name===t)return!0;n=Reflect.getPrototypeOf(n)}return!1}a(et,"isInstanceOf");function se(e,...t){return(Array.isArray(t[0])?t[0]:t).filter(s=>typeof s=="string").join(e)}a(se,"joinStr");function Me(e){return e?e[0].toUpperCase()+e.slice(1):""}a(Me,"capitalize");function jn(...e){return`flags.${S.id}.${se(".",e)}`}a(jn,"flagPath");function T(e,...t){return e.getFlag(S.id,t.join("."))}a(T,"getFlag");function Z(e,...t){let n=t.splice(-1)[0];return e.setFlag(S.id,t.join("."),n)}a(Z,"setFlag");function Et(e,...t){let n=t.splice(-1)[0];return e.updateSource({[jn(...t)]:n})}a(Et,"updateSourceFlag");function It(...e){let t=typeof e.at(-1)=="object"?e.splice(-1)[0]:{},n=me(...e);return renderTemplate(n,t)}a(It,"render");function me(...e){return`modules/${S.id}/templates/${se("/",e)}.hbs`}a(me,"templatePath");function Un(e,t=[]){let n=typeof t=="string"?[t]:t;return n.length?n.flatMap(s=>e.itemTypes[s]):e.items}a(Un,"getItems");function B(e,t,n){return Un(e,n).find(xt(t))}a(B,"getItemWithSourceId");function Ne(e,t,n="WRAPPER"){return libWrapper.register(S.id,e,t,n)}a(Ne,"registerWrapper");function v(...e){e.unshift(S.id);let t=typeof e.at(-1)=="object"?e.splice(-1)[0]:void 0;return game.i18n[t?"format":"localize"](se(".",e),t)}a(v,"localize");function ge(...e){return game.i18n.has(`${S.id}.${e.join(".")}`,!1)}a(ge,"hasLocalization");function tt(...e){return`${S.id}.${e.join(".")}`}a(tt,"localizePath");function N(e){let t=a((...n)=>v(e,...n),"fn");return Object.defineProperties(t,{warn:{value:(n,s,r)=>L(`${e}.${n}`,s,r),enumerable:!1,configurable:!1},info:{value:(n,s,r)=>Ct(`${e}.${n}`,s,r),enumerable:!1,configurable:!1},error:{value:(n,s,r)=>j(`${e}.${n}`,s,r),enumerable:!1,configurable:!1},has:{value:n=>ge(e,n),enumerable:!1,configurable:!1},path:{value:n=>tt(e,n),enumerable:!1,configurable:!1},template:{value:(n,{hash:s})=>t(n,s),enumerable:!1,configurable:!1},i18n:{get(){return{i18n:this.template,i18Path:this.path}},enumerable:!1,configurable:!1}}),t}a(N,"subLocalize");var nt=null,S={get id(){if(!nt)throw new Error("Module id needs to be registered.");return nt},error(e){throw new Error(`[${this.id}] ${e}`)}};function Tt(e){nt=e}a(Tt,"registerModule");function At(e){return game.modules.get(e??S.id)}a(At,"getModule");function st(e,t,n,s){let r=typeof t=="string"?t:"info",o=typeof t=="object"?t:typeof n=="object"?n:void 0,i=typeof t=="boolean"?t:typeof n=="boolean"?n:s??!1;ui.notifications.notify(v(e,o),r,{permanent:i})}a(st,"notify");function L(e,t,n){st(e,"warning",t,n)}a(L,"warn");function Ct(e,t,n){st(e,"info",t,n)}a(Ct,"info");function j(e,t,n){st(e,"error",t,n)}a(j,"error");function ee(e){e.key??=e.name,Array.isArray(e.choices)&&(e.choices=kt(e.choices,t=>re(e.key,"choices",t))),e.name=re(e.key,"name"),e.hint=re(e.key,"hint"),e.scope??="world",e.config??=!0,game.settings.register(S.id,e.key,e)}a(ee,"registerSetting");function Ot(e){e.key??=e.name,e.name=re("menus",e.key,"name"),e.label=re("menus",e.key,"label"),e.hint=re("menus",e.key,"hint"),e.restricted??=!0,e.icon??="fas fa-cogs",game.settings.registerMenu(S.id,e.key,e)}a(Ot,"registerSettingMenu");function re(...e){return`${S.id}.settings.${e.join(".")}`}a(re,"settingPath");function P(e){return game.settings.get(S.id,e)}a(P,"getSetting");function _e(e,t){return game.settings.set(S.id,e,t)}a(_e,"setSetting");var zn=function(e,t,n){if(n||arguments.length===2)for(var s=0,r=t.length,o;s<r;s++)(o||!(s in t))&&(o||(o=Array.prototype.slice.call(t,0,s)),o[s]=t[s]);return e.concat(o||Array.prototype.slice.call(t))};function Ft(e,t,n){var s=e.length-t.length,r=Array.from(t);if(s===0)return e.apply(void 0,r);if(s===1){var o=a(function(i){return e.apply(void 0,zn([i],r,!1))},"ret");return(n||e.lazy)&&(o.lazy=n||e.lazy,o.lazyArgs=t),o}throw new Error("Wrong number of arguments")}a(Ft,"purry");function Dt(e,t,n){for(var s=[],r=0;r<e.length;r++){var o=e[r],i=n?t(o,r,e):t(o);i.hasMany===!0?s.push.apply(s,i.next):i.hasNext&&s.push(i.next)}return s}a(Dt,"_reduceLazy");function oe(){return Ft(Gn,arguments,oe.lazy)}a(oe,"uniq");function Gn(e){return Dt(e,oe.lazy())}a(Gn,"_uniq");(function(e){function t(){var n=new Set;return function(s){return n.has(s)?{done:!1,hasNext:!1}:(n.add(s),{done:!1,hasNext:!0,next:s})}}a(t,"lazy"),e.lazy=t})(oe||(oe={}));function Pt(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}a(Pt,"ordinalString");function ye(e){return Error(`PF2e System | ${e}`)}a(ye,"ErrorPF2e");function H(e,t){return game.pf2e.system.sluggify(e,t)}a(H,"sluggify");function ie(e,t){return e.has(t)}a(ie,"setHasElement");function rt(e){return typeof e=="object"&&e!==null}a(rt,"isObject");function he(e,{async:t=!0,label:n}={}){let s=e instanceof foundry.abstract.Document?e.link:`@UUID[${e}]`;return n&&(s=s.replace(/\{.+?\}$/,""),s=`${s}{${n}}`),TextEditor.enrichHTML(s,{async:t})}a(he,"createFancyLink");var Wn=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),Bn=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function je(e,{pwol:t,rarity:n="common"}={}){t??=game.pf2e.settings.variants.pwol.enabled;let s=Bn.get(e)??14;return $e(t?s-Math.max(e,0):s,n)}a(je,"calculateDC");function $e(e,t="common"){return Hn(e,Vn(t))}a($e,"adjustDCByRarity");function Hn(e,t="normal"){return e+(Wn.get(t)??0)}a(Hn,"adjustDC");function Vn(e="common"){switch(e){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}a(Vn,"rarityToDCAdjustment");var be=new Set(["arcane","divine","occult","primal"]);var Rt=class extends FormApplication{static{a(this,"IdentifyItemPopup")}static get defaultOptions(){return{...FormApplication.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}dcs=Yn(this.object,{pwol:game.pf2e.settings.variants.pwol.enabled,notMatchingTraditionModifier:game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier")});async getData(){let t=this.object;return{...await super.getData(),isMagic:t.isMagical,isAlchemical:t.isAlchemical,dcs:this.dcs}}activateListeners(t){let n=t[0],s=n.querySelector<HTMLButtonElement>"button.update-identification";s?.addEventListener("click",()=>{this.submit({updateData:{status:s.value}})}),n.querySelector("button.post-skill-checks")?.addEventListener("click",async()=>{let r=this.object,o=r.system.identification.identified.name,i=this.dcs,l=r.isMagical?"identify-magic":r.isAlchemical?"identify-alchemy":"recall-knowledge",u=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{identifiedName:o,action:l,skills:R.omit(i,["dc"]),unidentified:r.system.identification.unidentified,uuid:r.uuid});await ChatMessage.implementation.create({user:game.user.id,content:u})})}async _updateObject(t,n){let s=n.status;if(s==="identified")return this.object.setIdentificationStatus(s)}};function Yn(e,{pwol:t=!1,notMatchingTraditionModifier:n}){let s=je(e.level,{pwol:t}),r=Kn(e),o=$e(s,r);return e.isMagical?Xn(e,o,n):{crafting:o}}a(Yn,"getItemIdentificationDCs");function Kn(e){return e.traits.has("cursed")?"unique":e.rarity}a(Kn,"getDcRarity");function Xn(e,t,n){let s={occult:t,primal:t,divine:t,arcane:t},r=Qn(e);for(let o of be)r.size>0&&!r.has(o)&&(s[o]=t+n);return{arcana:s.arcane,nature:s.primal,religion:s.divine,occultism:s.occult}}a(Xn,"getIdentifyMagicDCs");function Qn(e){let t=e.system.traits.value;return new Set(t.filter(n=>ie(be,n)))}a(Qn,"getMagicTraditions");var Pi=["action","check","effect-area"].map(e=>`[data-pf2-${e}]`).join(",");var Lt=class extends FormApplication{static{a(this,"MoveLootPopup")}constructor(t,n,s){super(t,n),this.onSubmitCallback=s}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),quantity:{default:this.options.quantity.default,max:this.options.quantity.max},newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...FormApplication.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",quantity:{default:1,max:1},newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};function Mt(e,...t){return typeof e.name=="string"&&t.some(n=>n==="physical"?ie(PHYSICAL_ITEM_TYPES,e.type):e.type===n)}a(Mt,"itemIsOfType");var Ue=class e extends Array{static{a(this,"PredicatePF2e")}constructor(...t){super(...Array.isArray(t[0])?t[0]:t),this.isValid=e.isValid(this),Object.defineProperty(this,"isValid",{enumerable:!1})}static isValid(t){return Array.isArray(t)}static isArray(t){return Array.isArray(t)&&t.every(n=>V(n))}static test(t=[],n=[]){return t instanceof e?t.test(n):new e(...t).test(n)}test(t){if(this.length===0)return!0;if(!this.isValid)return console.warn("PF2e System | The provided predicate set is malformed."),!1;let n=t instanceof Set?t:new Set(t);return this.every(s=>this.#e(s,n))}toObject(){return deepClone([...this])}clone(){return new e(this.toObject())}#e(t,n){return typeof t=="string"&&n.has(t)||ot(t)&&this.#s(t,n)||Nt(t)&&this.#n(t,n)}#s(t,n){if("eq"in t)return n.has(`${t.eq[0]}:${t.eq[1]}`);let s=Object.keys(t)[0],[r,o]=Object.values(t)[0],i=Array.from(n),l=a(d=>{let p=Number(d);if(!Number.isNaN(p))return[p];let m=new RegExp(String.raw`^${d}:([^:]+)$`),f=i.map(y=>Number(m.exec(y)?.[1]||NaN)).filter(y=>!Number.isNaN(y));return f.length>0?f:[NaN]},"getValues"),u=l(r),c=l(o);switch(s){case"gt":return u.some(d=>c.every(p=>d>p));case"gte":return u.some(d=>c.every(p=>d>=p));case"lt":return u.some(d=>c.every(p=>d<p));case"lte":return u.some(d=>c.every(p=>d<=p));default:return console.warn("PF2e System | Malformed binary operation encountered"),!1}}#n(t,n){return"and"in t&&t.and.every(s=>this.#e(s,n))||"nand"in t&&!t.nand.every(s=>this.#e(s,n))||"or"in t&&t.or.some(s=>this.#e(s,n))||"xor"in t&&t.xor.filter(s=>this.#e(s,n)).length===1||"nor"in t&&!t.nor.some(s=>this.#e(s,n))||"not"in t&&!this.#e(t.not,n)||"if"in t&&!(this.#e(t.if,n)&&!this.#e(t.then,n))}};function V(e){return e instanceof Object?Nt(e)||ot(e):typeof e=="string"?Zn(e):!1}a(V,"isStatement");function Zn(e){return typeof e=="string"&&e.length>0||ot(e)}a(Zn,"isAtomic");var es=new Set(["eq","gt","gte","lt","lte"]);function ot(e){if(!rt(e))return!1;let t=Object.entries(e);if(t.length>1)return!1;let[n,s]=t[0];return es.has(n)&&Array.isArray(s)&&s.length===2&&typeof s[0]=="string"&&["string","number"].includes(typeof s[1])}a(ot,"isBinaryOp");function Nt(e){return rt(e)&&(ts(e)||ss(e)||ns(e)||rs(e)||os(e)||is(e)||as(e))}a(Nt,"isCompound");function ts(e){return Object.keys(e).length===1&&Array.isArray(e.and)&&e.and.every(t=>V(t))}a(ts,"isAnd");function ns(e){return Object.keys(e).length===1&&Array.isArray(e.nand)&&e.nand.every(t=>V(t))}a(ns,"isNand");function ss(e){return Object.keys(e).length===1&&Array.isArray(e.or)&&e.or.every(t=>V(t))}a(ss,"isOr");function rs(e){return Object.keys(e).length===1&&Array.isArray(e.xor)&&e.xor.every(t=>V(t))}a(rs,"isXor");function os(e){return Object.keys(e).length===1&&Array.isArray(e.nor)&&e.nor.every(t=>V(t))}a(os,"isNor");function is(e){return Object.keys(e).length===1&&!!e.not&&V(e.not)}a(is,"isNot");function as(e){return Object.keys(e).length===2&&V(e.if)&&V(e.then)}a(as,"isIf");var cs="tLa4bewBhyqzi6Ow",us={1:"RjuupS9xyXDLgyIr",2:"Y7UD64foDbDMV9sx",3:"ZmefGBXGJF3CFDbn",4:"QSQZJ5BC3DeHv153",5:"tjLvRWklAylFhBHQ",6:"4sGIy77COooxhQuC",7:"fomEZZ4MxVVK3uVu",8:"iPki3yuoucnj7bIt",9:"cFHomF3tty8Wi1e5",10:"o1XIHJ4MJyroAHfF"};var ds={cantripDeck5:"PF2E.Item.Physical.FromSpell.CantripDeck5",scroll:"PF2E.Item.Physical.FromSpell.Scroll",wand:"PF2E.Item.Physical.FromSpell.Wand"},ps={1:"UJWiN0K3jqVjxvKk",2:"vJZ49cgi8szuQXAD",3:"wrDmWkGxmwzYtfiA",4:"Sn7v9SsbEDMUIwrO",5:"5BF7zMnrPYzyigCs",6:"kiXh4SUWKr166ZeM",7:"nmXPj9zuMRQBNT60",8:"Qs8RgNH6thRPv2jt",9:"Fgv722039TVM5JTc"};async function _t(e,{type:t,heightenedLevel:n=e.baseRank,mystified:s=!1,temp:r=!1,itemImg:o,itemName:i=t}){let l=game.packs.find(f=>f.collection==="pf2e.equipment-srd"),u=fs(t,n),c=await l?.getDocument(u??"");if(!et(c,"ConsumablePF2e"))throw ye("Failed to retrieve consumable item");let d={...c.toObject(),_id:null},{traits:p}=d.system;p.value=oe([...p.value,...e.traits]),p.rarity=e.rarity,p.value.includes("magical")&&p.value.some(f=>ie(be,f))&&p.value.splice(p.value.indexOf("magical"),1),p.value.sort(),d.name=ms(i,e.name,n);let m=d.system.description.value;return d.system.description.value=(()=>{let f=document.createElement("p");f.append(e.sourceId?`@UUID[${e.sourceId}]{${e.name}}`:e.description);let y=document.createElement("div"),g=document.createElement("hr");return y.append(f,g),g.insertAdjacentHTML("afterend",m),y.innerHTML})(),t!=="cantripDeck5"&&(d.system.spell=e.clone({_id:randomID(),"system.location.heightenedLevel":n},{keepId:!0}).toObject()),s&&(d.system.identification.status="unidentified"),typeof o=="string"&&(d.img=o),r&&(d.system.temporary=!0),d}a(_t,"createConsumableFromSpell");function fs(e,t){switch(e){case"cantripDeck5":return cs;case"scroll":return us[t]??null;default:return ps[t]??null}}a(fs,"getIdForSpellConsumable");function ms(e,t,n){let s=ds[e]||`${e} of {name} (Level {level})`;return game.i18n.format(s,{name:t,level:n})}a(ms,"getNameForSpellConsumable");function ze(e,t,n,s,r){return{key:e,label:r,item:{uuid:t},rows:[{type:"drop",slug:"spell",filter:{type:"spell",search:n??{}}}],process:async({addSpell:i,utils:l,fields:u,messages:c})=>{let d=u.spell.uuid,p=await l.createSpellSource(d),m=s??p.system.level.value,f=`${p.name} (Level ${m})`;i(p,s),c.add("spells",{uuid:d,label:f})}}}a(ze,"createSpellDaily");function $t(){let e=ze("ace","Compendium.pf2e.feats-srd.Item.POrE3ZgBRdBL9MsW",{category:[],level:4},4),t=e.rows[0];return t.filter.drop=n=>{let s=n.system.time.value;return s.includes("hour")||s.includes("min")&&parseInt(s)>10?{error:tt("interface.error.drop.wrongSpellTime"),data:{time:"10 min"}}:!0},e}a($t,"tricksterAce");var Ut={key:"blade",item:{uuid:"Compendium.pf2e.classfeatures.Item.EtltLdiy9kNfHU0c"},children:[{slug:"good",uuid:"Compendium.pf2e.classfeatures.Item.nxZYP3KGfTSkaW6J"},{slug:"evil",uuid:"Compendium.pf2e.classfeatures.Item.JiY2ZB4FkK8RJm4T"},{slug:"liberator",uuid:"Compendium.pf2e.classfeatures.Item.FCoMFUsth4xB4veC"},{slug:"paladin",uuid:"Compendium.pf2e.classfeatures.Item.peEXunfbSD8WcMFk"},{slug:"antipaladin",uuid:"Compendium.pf2e.classfeatures.Item.EQ6DVIQHAUXUhY6Y"},{slug:"tyrant",uuid:"Compendium.pf2e.classfeatures.Item.HiIvez0TqESbleB5"},{slug:"spirit",uuid:"Compendium.pf2e.feats-srd.Item.h5ksUZlrVGBjq6p4"},{slug:"master",uuid:"Compendium.pf2e.feats-srd.Item.jYEMVfrXJLpXS6aC"}],rows:[{type:"select",slug:"weapon",label:()=>v("label.blade.weapon"),options:({actor:e})=>e.itemTypes.weapon.filter(t=>!t.isAlchemical).map(t=>({value:t.id,label:t.name}))},{type:"select",slug:"rune",label:()=>v("label.blade.rune"),options:({children:e})=>{let t=["returning","shifting"],{antipaladin:n,evil:s,good:r,liberator:o,master:i,paladin:l,spirit:u,tyrant:c}=e;return u&&(t.push("flaming"),r&&t.push("holy"),s&&t.push("unholy"),(o||n)&&t.push("anarchic"),(l||c)&&t.push("axiomatic")),r&&t.push("disrupting","ghost-touch"),i&&t.push("greater-disrupting","keen"),s&&t.push("fearsome"),t.map(d=>({value:d,label:jt(d)}))},condition:({actor:e})=>e.itemTypes.weapon.filter(t=>!t.isAlchemical).length}],process:async({actor:e,fields:t,addRule:n,messages:s})=>{let r=t.weapon.value,o=t.rune.value,i=e.items.get(r);if(!i)return;n({definition:[`item:id:${r}`],key:"AdjustStrike",mode:"add",property:"property-runes",value:o},i),n({key:"CriticalSpecialization",predicate:[{or:[`item:category:${i.category}`,`item:id:${r}`]}]},i);let l=i.name!==i._source.name?`... ${i._source.name}`:i.name;s.addGroup("blade"),s.add("blade",{uuid:i.uuid,label:l,selected:jt(o)})}};function jt(e){let t=e.replace(/-\w/,n=>n[1].toUpperCase());return game.i18n.localize(`PF2E.WeaponPropertyRune.${t}.Name`)}a(jt,"localizeRune");var gs="systems/pf2e/icons/equipment/weapons/wish-knife.webp",zt={key:"ceremonial",item:{uuid:"Compendium.pf2e.feats-srd.Item.78pkCdFaY8hI07Lj",condition:({actor:e})=>e.itemTypes.weapon.some(t=>t.group==="knife")},rows:[{type:"drop",slug:"spell",label:({utils:e,actor:t})=>e.spellRankLabel(it(t)),filter:{type:"spell",search:({actor:e})=>({category:["spell"],level:it(e)})}}],process:async({actor:e,fields:t,utils:n,item:s,addItem:r,messages:o})=>{let i=t.spell.uuid,l=it(e),u=await n.createWandSource({uuid:i,level:l,itemName:s.name,itemImg:gs});r(u),o.addGroup("ceremonial"),o.add("ceremonial",{uuid:i,label:u.name})}};function it(e){return Math.ceil((e.level-5)/2)}a(it,"calculateRank");var ys=["first","second","third","fourth","fifth","sixth","seventh"];function at(e,t,n){return{key:e,label:n,item:{uuid:t[0]},children:[{slug:"expert",uuid:t[1]},{slug:"master",uuid:t[2]}],rows:[te("first",1),te("second",2,8),te("third",3,void 0,"expert"),te("fourth",4,14,"expert"),te("fifth",5,16,"expert"),te("sixth",6,void 0,"master"),te("seventh",7,20,"master")],process:async({utils:r,fields:o,addItem:i,messages:l})=>{for(let u of Object.values(o)){let c=u.uuid,d=ys.indexOf(u.row)+1,p=await r.createSpellScrollSource({uuid:c,level:d});i(p),l.add("scrolls",{uuid:c,label:p.name})}}}}a(at,"createScrollChain");function te(e,t,n,s){let r={type:"drop",slug:e,label:({utils:o})=>o.spellRankLabel(t),filter:{type:"spell",search:{category:["spell"],level:t}}};return n&&(r.condition=({actor:o})=>o.level>=n),s&&(r.childPredicate=[s]),r}a(te,"createRow");var qt={key:"flexibility",item:{uuid:"Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8"},children:[{slug:"improved",uuid:"Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX"}],rows:[Gt("flexibility",8),Gt("improved",14,"improved")],process:async({utils:e,fields:t,addFeat:n,messages:s,children:r})=>{let o=t.flexibility.uuid,i=await e.createFeatSource(o);if(n(i),s.add("feats",{uuid:o}),r.improved){let l=t.improved.uuid,u=await e.createFeatSource(l);n(u,r.improved),s.add("feats",{uuid:l})}}};function Gt(e,t,n){let s={type:"drop",label:`PF2E.Level${t}`,slug:e,filter:{type:"feat",search:{category:["class"],traits:["fighter"],level:t}}};return n&&(s.childPredicate=[n]),s}a(Gt,"createRow");function ve(e,t,n){return{key:e,label:n,item:{uuid:t},rows:[{type:"select",slug:"language",options:({actor:s,utils:r})=>{let o=s.system.details.languages.value;return r.languageNames.filter(i=>!o.includes(i)).sort()},labelizer:({utils:s})=>s.languageLabel}],process:({addRule:s,utils:r,fields:o,messages:i})=>{let l=o.language.value,u=r.createLanguageRuleElement({language:l});s(u),i.add("languages",{uuid:t,selected:r.languageLabel(l),label:n})}}}a(ve,"createLanguageDaily");function ae(e,t,n){return{key:e,label:n,item:{uuid:t},rows:[Ge("skill",0)],process:r=>{lt(r,{uuid:t,label:n})}}}a(ae,"createTrainedSkillDaily");function lt({fields:e,addItem:t,addRule:n,utils:s,messages:r,removeRule:o},{field:i="skill",uuid:l,label:u,rank:c=1,parent:d}){o(m=>m.key==="ActiveEffectLike"&&m.mode==="upgrade"&&m.phase==="beforeDerived"&&m.path?.startsWith("system.skills."),d),o(m=>m.key==="RollOption"&&m.toggleable&&m.alwaysActive&&m.phase==="beforeDerived"&&m.suboptions.some(f=>f.label==="PF2E.SkillAcr"),d);let p=e[i].value;if(e[i].input==="true"){let m=s.createLoreSource({name:p,rank:c});t(m)}else{let m=s.createSkillRuleElement({skill:p,value:c});p=s.skillLabel(p),n(m,d)}r.add("skills",{uuid:l,selected:p,label:u})}a(lt,"processComboSkill");function Ge(e,t,n={}){return{type:"combo",slug:e,options:({actor:s,utils:r})=>{let o=s.skills;return r.skillNames.filter(i=>o[i].rank===t)},labelizer:({utils:s})=>s.skillLabel,...n}}a(Ge,"createComboSkillRow");function qe(e,t,n){return{key:e,label:n,item:{uuid:t},rows:[{type:"input",slug:"skill"}],process:({addItem:r,utils:o,fields:i,messages:l})=>{let u=i.skill.value,c=o.createLoreSource({name:u,rank:1});r(c),l.add("skills",{uuid:t,selected:u,label:n})}}}a(qe,"createTrainedLoreDaily");var Wt={key:"longevities",item:{uuid:"Compendium.pf2e.feats-srd.Item.WoLh16gyDp8y9WOZ"},children:[{slug:"expert",uuid:"Compendium.pf2e.feats-srd.Item.vfuHVSuExvtyajkW"}],rows:[Ge("ancestral",0,{label:({item:e})=>e.name}),Ge("expert",1,{label:({children:e})=>e.expert?.name,childPredicate:["expert"]})],process:async e=>{let t=[{field:"ancestral",rank:1,item:e.item},{field:"expert",rank:2,item:e.children.expert}];for(let{field:n,rank:s,item:r}of t)e.fields[n]&&lt(e,{label:r.name,uuid:r.uuid,field:n,rank:s,parent:r})}};var ct="Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P",Bt="Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky",hs={0:{die:"d4",traits:["finesse","agile"],usage:"held-in-one-hand"},1:{die:"d6",traits:["finesse"],usage:"held-in-one-hand"},2:{die:"d8",traits:[],usage:"held-in-one-hand"},3:{die:"d10",traits:["reach"],usage:"held-in-two-hands"}},Vt={slashing:"sword",piercing:"spear",bludgeoning:"club"},Ht=["grapple","nonlethal","shove","trip","modular"],bs=Object.keys(Vt),vs=["corrosive","disrupting","flaming","frost","shock","thundering"],Ss=["greaterCorrosive","greaterDisrupting","greaterFlaming","greaterFrost","greaterShock","greaterThundering","holy","unholy"],Yt={key:"mindsmith",item:{uuid:"Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY"},children:[{slug:"weapon",uuid:ct},{slug:"mental",uuid:Bt},{slug:"runic",uuid:"Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp"},{slug:"advanced",uuid:"Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD"}],rows:[{type:"alert",slug:"alert",message:()=>v("interface.alert.weapon"),fix:ws,childPredicate:[{not:"weapon"}]},{type:"select",slug:"smith",label:()=>v("label.mindsmith"),options:bs,labelizer:({utils:e})=>e.damageLabel,childPredicate:["weapon"]},...[1,2].map(e=>({type:"select",slug:`mental${e}`,label:()=>v("label.mentalforge",{nb:e}),options:Ht,labelizer:({utils:t})=>t.weaponTraitLabel,unique:"mental",childPredicate:["weapon","mental"]})),{type:"select",slug:"runic",label:()=>v("label.runicmind"),options:vs,labelizer:({utils:e})=>e.weaponPropertyRunesLabel,childPredicate:["weapon","runic",{not:"advanced"}],condition:({children:e,utils:t})=>t.hasFreePropertySlot(e.weapon)},{type:"select",slug:"advanced",label:()=>v("label.runicmind"),options:Ss,labelizer:({utils:e})=>e.weaponPropertyRunesLabel,childPredicate:["weapon","advanced"],condition:({children:e,utils:t})=>t.hasFreePropertySlot(e.weapon)}],process:({children:e,updateItem:t,fields:n,messages:s,item:r,utils:o})=>{let i=e.weapon;if(!i)return;s.addGroup("mindsmith");let l=n.smith.value;if(t({_id:i.id,"system.damage.damageType":l,"system.group":Vt[l]}),s.add("mindsmith",{selected:o.damageLabel(l),uuid:r.uuid,label:"mindsmith"}),e.mental){let u=deepClone(i._source.system.traits?.value??[]);for(let c of[1,2]){let d=n[`mental${c}`].value;u.includes(d)||u.push(d),t({_id:i.id,"system.traits.value":u}),s.add("mindsmith",{selected:o.weaponTraitLabel(d),uuid:e.mental.uuid,label:v("label.mentalforge",{nb:c})})}}if((e.advanced||e.runic)&&o.hasFreePropertySlot(i)){let u=e.advanced??e.runic,c=o.getFreePropertyRuneSlot(i),p=(n.advanced??n.runic).value;c&&!i.system.runes.property.includes(p)&&(t({_id:i.id,[`system.${c}.value`]:p,[`flags.${S.id}.runeSlot`]:c}),s.add("mindsmith",{selected:o.weaponPropertyRunesLabel(p),uuid:u.uuid,label:"runicmind"}))}},rest:({item:e,sourceId:t,updateItem:n,actor:s})=>{if(t!==ct)return;if(B(s,Bt)){let i=e._source.system.traits?.value??[];i=i.filter(l=>!Ht.includes(l)),n({_id:e.id,"system.traits.value":i})}let o=T(e,"runeSlot");o&&n({_id:e.id,[`system.${o}.value`]:null,[`flags.${S.id}.-=runeSlot`]:!0})}};async function ws({actor:e}){let t=N("dialog.weapon"),n=t("flavor");for(let r of["0","1","2","3"]){let o=t(`option.${r}`);n+=`<label><input type="radio" name="type" value="${r}">${o}</label>`}let s=await Dialog.wait({title:t("title"),content:n,buttons:{yes:{icon:'<i class="fas fa-save"></i>',label:t("accept"),callback:xs},no:{icon:'<i class="fas fa-times"></i>',label:t("cancel"),callback:()=>null}},close:()=>null},{},{id:"pf2e-dailies-weapon",width:600});return s?(await e.createEmbeddedDocuments("Item",[s]),!0):!1}a(ws,"fix");async function xs(e){let t=N("dialog.weapon"),n=e.find("[name=type]:checked").val();if(!n){t.warn("error.noSelection");return}let s=(await fromUuid(ct))?.toObject();if(!s){t.warn("error.missing");return}let r=hs[n];return setProperty(s,"system.damage.die",r.die),setProperty(s,"system.traits.value",r.traits.slice()),setProperty(s,"system.usage.value",r.usage),s}a(xs,"onWeaponSelected");var Xt="Compendium.pf2e.equipment-srd.Item.L9ZV076913otGtiB";function Kt(e){return B(e,Xt,"consumable")}a(Kt,"getRations");var Qt={key:"rations",item:{uuid:"Compendium.pf2e.equipment-srd.Item.L9ZV076913otGtiB"},rows:[{type:"select",slug:"rations",save:!1,order:200,options:({actor:e})=>{let t=Kt(e),{value:n,max:s}=t.uses,o=(t.quantity-1)*s+n,i=o<=1;return[{value:"false",label:v("interface.rations.no")},{value:"true",label:i?v("interface.rations.last"):v("interface.rations.yes",{nb:o})}]}}],process:async({fields:e,updateItem:t,messages:n,actor:s})=>{if(e.rations.value!=="true")return;let r=Kt(s);if(!r?.uses.value)return;let o=r.quantity,{value:i,max:l}=r.uses;i<=1?o<=1?r.delete():t({_id:r.id,"system.quantity":Math.max(r.quantity-1,0),"system.uses.value":l}):t({_id:r.id,"system.uses.value":Math.max(i-1,0)});let u=(o-1)*l+i,c=u<=1?await he(Xt,{label:r.name}):await he(r),d=u<=1?v("message.rations.last",{name:c}):u<=3?v("message.rations.almost",{name:c,nb:u-1}):v("message.rations.used",{name:c,nb:u-1});n.addRaw(d,200)}};function Se(e,t,n,s,r,o){return{key:e,label:r,item:{uuid:t},rows:[{type:o?"random":"select",slug:"resistance",options:n,labelizer:({utils:l})=>l.resistanceLabel}],process:async({utils:l,fields:u,actor:c,addRule:d,messages:p})=>{let m=o?await l.randomOption(n):u.resistance.value,f=typeof s=="number"?s:s==="half"?l.halfLevelValue(c):c.level,y=l.createResistanceRuleElement({type:m,value:f});d(y),p.add("resistances",{uuid:t,selected:l.resistanceLabel(m,f),label:r,random:o})}}}a(Se,"createResistancelDaily");var ks="Compendium.pf2e.feat-effects.Item.jO7wMhnjT7yoAtQg",Jt={key:"root",item:{uuid:"Compendium.pf2e.feats-srd.Item.22P7IFyhrF7Fbw8B"},rows:[{type:"select",slug:"target",options:({actor:e,utils:t})=>t.getPlayersActors(e).map(s=>({value:s.id,label:s.name}))}],process:({fields:e,messages:t})=>{let n=e.target.value,s=game.actors.get(n);s&&(t.addGroup("root"),t.add("root",{uuid:ks,selected:s.name}))}};var We=["cantrips?","1st","2nd","3rd","4th","5th","6th","7th","8th","9th","10th"].join("|"),Zt="Compendium.pf2e.feats-srd.Item.NV9H39kbkbjhAK6X";function Y(){return game.modules.get("pf2e-staves")?.active}a(Y,"isPF2eStavesActive");function we(e){if(!e)return;let t=T(e,"staff")??getProperty(e,"flags.pf2e-staves");if(t)return delete t.prevDescription,deepClone(t)}a(we,"getSpellcastingEntryStaffFlags");function xe(e){let t=we(e);if(!t)return;t.overcharge??=0,t.max=Ee(e.actor)+t.overcharge;let n=(()=>{let s=e.actor;return!t.charges||t.overcharge||t.makeshift||!s?{}:s.spellcasting.filter(r=>r.isSpontaneous).reduce((r,o)=>{for(let i=1;i<=10;i++){let l=o.system.slots[`slot${i}`];l.max&&l.value&&(r[i]=!0)}return r},{})})();return t.canPayCost=s=>!!t.charges&&(s<=t.charges||n[s]),t}a(xe,"getSpellcastingEntryStaffData");async function ke(e,t){let n=xe(e);if(!n)return;let s=Math.clamped(t,0,n.max);if(s!==n.charges)return n.charges=s,Z(e,"staff",n)}a(ke,"updateEntryCharges");function en(e){return[{type:"weapon",trait:"magical"},{type:"equipment",trait:"coda"}].flatMap(({type:t,trait:n})=>e.itemTypes[t].filter(s=>{let r=s.system.traits?.value;return r?.includes("staff")&&r.includes(n)}))}a(en,"getStaves");function Ee(e){let t=0,n=Math.ceil(e.level/2),s=Ie(e);for(let o of s){let i=Be(o);i>t&&(t=i)}return B(e,Zt,"feat")&&n>t&&(t=n),Math.min(n,t)}a(Ee,"getMaxSlotRankForStaves");function tn(e){let t=sn(e);if(B(e,Zt,"feat")){let s=t?.mod??0,r=e.classDCs.kineticist??e.classDCs.find(i=>i.mod>=s),o=r.mod;if(o>=s)return{ability:{value:r.attribute},tradition:{value:"primal"},proficiency:{value:r.rank,slug:r.slug},mod:o}}return t}a(tn,"getBestSpellcastingEntryForStaves");function nn(e){let t={};for(let n of e.spellcasting.filter(s=>s.isPrepared)){let s=n.id,r=n.isFlexible;for(let o=1;o<=10;o++){let i=n.system.slots[`slot${o}`];if(!(i.max<1))if(r){if(i.value<1)continue;t[s]??={id:s,name:n.name,slots:[]},t[s].slots.push({rank:o,value:i.value,max:i.max})}else for(let[l,{id:u,prepared:c,expended:d}]of Object.entries(i.prepared)){if(c===!1||d)continue;let p=n.spells.get(u);t[s]??={id:s,name:n.name,spells:[]},t[s].spells.push({name:p?.name??"Empty Slot",rank:o,index:l})}}t[s]?.spells?.sort((o,i)=>o.rank-i.rank)}return Object.values(t)}a(nn,"getPreparedSpellcastingEntriesForStaves");async function rn(e,...t){let[n,{rank:s}]=t;if(n.isCantrip)return e(...t);let r=we(this);if(!r)return e(...t);let o=this.actor;if(!o.items.get(r.staveID)?.isEquipped){L("staves.noStaff");return}let l=n.computeCastRank(s);if(!s||s==="0")return n.toMessage(void 0,{data:{castRank:l}});if(r.charges<1||r.charges<l&&r.overcharge){L("staves.noCharge");return}let u=[];if(!r.overcharge){let c=o.spellcasting.filter(m=>m.isSpontaneous&&m.system.slots[`slot${l}`].value),d=!1,p=a(m=>m.system.slots[`slot${l}`].value,"entryRankValue");if(c.length===1){let m=c[0],f=v("staves.spontaneous.one",{rank:D.spellRankLabel(l),entry:m.name,remaining:p(m)});d=await Dialog.confirm({title:v("staves.spontaneous.title"),defaultYes:!1,content:`<div class="pf2e-dailies-spontaneous">${f}</div>`}),d&&(d=0)}else if(c.length>1){let m=c.map((y,g)=>({index:g,name:y.name,remaining:p(y)})),f=await It("staves-spontaneous",{entries:m,castRank:D.spellRankLabel(l),i18n:(y,{hash:g})=>v(`staves.spontaneous.${y}`,g)});d=await Dialog.wait({title:v("staves.spontaneous.title"),content:f,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Yes"),callback:y=>{let g=y.find("input[name=entry]:checked").val();return Number(g)}},no:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("No"),callback:()=>!1}},close:()=>null})}if(d===null)return;if(typeof d=="number"){let m=c[d],f=m.system.slots[`slot${l}`].value;u.push({_id:m.id,[`system.slots.slot${l}.value`]:f-1}),r.charges-=1}}if(!u.length){if(r.charges<l){L("staves.noCharge");return}r.charges-=l}u.push({_id:this.id,[`flags.${S.id}.staff`]:r}),await o.updateEmbeddedDocuments("Item",u),await n.toMessage(void 0,{data:{castRank:l}})}a(rn,"onSpellcastingEntryCast");function Ie(e,{itemOnly:t,innate:n,focus:s}={}){return e.spellcasting.regular.filter(r=>!(r.flags?.["pf2e-staves"]||T(r,"staff")||!n&&r.isInnate||!s&&r.isFocusPool||r.system.prepared.value==="items"&&(!t||t==="scroll"&&r.system.prepared.validItems!=="scroll")))}a(Ie,"getValidSpellcastingList");function Be(e){let t=0;if(e.system.prepared.value==="items"){let n=Math.ceil(e.actor.level/2);n>t&&(t=n)}else for(let n=0;n<=10;n++)e.system.slots[`slot${n}`].max&&(t=Math.max(t,n));return t}a(Be,"getSpellcastingEntryMaxSlotRank");function sn(e){let t=Ie(e),n=0,s=[];for(let c of t){let d=c.statistic.mod;d>n?(s=[c],n=d):d===n&&s.push(c)}if(s.length===0)return;let r=a(c=>{let{ability:d,tradition:p,proficiency:m}=c.system;return{ability:d,tradition:p,proficiency:m,mod:n}},"returnedEntry");if(s.length===1)return r(s[0]);let o=e.classDC.attribute,i=s.filter(c=>c.attribute===o);if(i===1)return r(i[0]);let l=0,u;for(let c of s){let d=Es(c);d>l&&(l=d,u=c)}return r(u??s[0])}a(sn,"getBestSpellcastingEntry");function Es(e){return e.isSpontaneous?e.spells.size:e.isPrepared?Object.values(e.system.slots).flatMap(s=>Object.values(s.prepared)).filter(s=>s.id).length:0}a(Es,"getPreparedCount");function on(e){let t=0,n=0;for(let s of e.spellcasting)s.sort>n?n=s.sort:s.sort<t&&(t=s.sort);return{min:t,max:n}}a(on,"getSpellcastingEntriesSortBounds");var an={key:"savant",item:{uuid:"Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ"},prepare:({actor:e})=>{let{maxSlot:t,maxTradition:n}=Is(e,"arcane");return{first:{level:t-2,condition:!0},second:{level:t-3,condition:!0},third:{level:t-4,condition:n>=3&&t>=5},fourth:{level:t-5,condition:n>=4&&t>=6}}},rows:["first","second","third","fourth"].map(e=>({type:"drop",slug:e,label:({custom:n,utils:s})=>s.spellRankLabel(n[e].level),filter:{type:"spell",search:({custom:n})=>({category:["spell"],traditions:["arcane"],level:n[e].level})},condition:({custom:n})=>n[e].condition})),process:async({utils:e,fields:t,custom:n,addItem:s,messages:r})=>{for(let o of Object.values(t)){let i=o.uuid,l=await e.createSpellScrollSource({uuid:i,level:n[o.row].level});s(l),r.add("scrolls",{uuid:i,label:l.name})}}};function Is(e,t){let n=1,s=0,r=Ie(e);for(let o of r){let i=Be(o);i>n&&(n=i),o.tradition===t&&(s=Math.max(s,o.rank))}return{maxSlot:Math.min(n,10),maxTradition:s}}a(Is,"getSpellcastingTraditionDetails");var ln={key:"metamagical",item:{uuid:"Compendium.pf2e.classfeatures.Item.89zWKD2CN7nRu2xp",condition:({actor:e})=>e.level>=4},rows:[{type:"drop",slug:"feat",filter:{type:"feat",search:{category:["class"],traits:{selected:["spellshape","wizard"],conjunction:"and"},level:"half"}}}],process:async({utils:e,fields:t,addFeat:n,messages:s})=>{let r=t.feat.uuid,o=await e.createFeatSource(r);n(o),s.add("feats",{uuid:r})}};var cn={key:"tome",item:{uuid:"Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e"},children:[{slug:"adept",uuid:"Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO",condition:ut("adept")},{slug:"second",uuid:"Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5",condition:ut("adept")},{slug:"intense",uuid:"Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC"},{slug:"paragon",uuid:"Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI",condition:ut("paragon")}],prepare:({utils:e,actor:t,children:n})=>{let s=e.skillNames,r=t.level,o=t.skills,i={first:{options:[],rank:1},second:{options:[],rank:1}};if(n.paragon){let l=s.filter(u=>o[u].rank<4);i.first={rank:4,options:l},i.second={rank:4,options:l}}else if(n.intense||n.adept||n.second){let l=s.filter(u=>o[u].rank<3);if(r>=9)i.first={rank:3,options:l},i.second={rank:3,options:l};else{let u=s.filter(c=>o[c].rank<2);i.first={rank:2,options:u},i.second={rank:3,options:l}}}else if(r>=5){let l=s.filter(u=>o[u].rank<2);i.first={rank:2,options:l},i.second={rank:2,options:l}}else if(r>=3){let l=s.filter(c=>o[c].rank<1),u=s.filter(c=>o[c].rank<2);i.first={rank:1,options:l},i.second={rank:2,options:u}}else{let l=s.filter(u=>o[u].rank<1);i.first={rank:1,options:l},i.second={rank:1,options:l}}return i},rows:["first","second"].map(e=>({type:"combo",slug:e,label:({custom:n,utils:s})=>s.proficiencyLabel(n[e].rank),options:({custom:n})=>n[e].options,labelizer:({utils:n})=>n.skillLabel})),process:({custom:e,fields:t,utils:n,messages:s,addItem:r,addRule:o})=>{s.addGroup("tome",65);for(let i of["first","second"]){let l=e[i].rank,u=t[i].value;if(t[i].input==="true"){let c=n.createLoreSource({name:u,rank:l});r(c)}else{let c=n.createSkillRuleElement({skill:u,value:l});u=n.skillLabel(u),o(c)}s.add("tome",{label:n.proficiencyLabel(l),selected:u})}}};function ut(e){return({item:t,utils:n,actor:s})=>{let r=n.getChoiSetRuleSelection(t);return s.items.get(r)?.slug==="tome"}}a(ut,"createChildCondition");var Cs=["root-magic"],un=["familiar","staves"],Ae=[cn,Wt,ae("ageless","Compendium.pf2e.feats-srd.Item.wylnETwIz32Au46y"),ae("memories","Compendium.pf2e.feats-srd.Item.ptEOt3lqjxUnAW62"),ae("studies","Compendium.pf2e.feats-srd.Item.9bgl6qYWKHzqWZj0"),qe("study","Compendium.pf2e.feats-srd.Item.aLJsBBZzlUK3G8MW"),ve("linguistics","Compendium.pf2e.feats-srd.Item.eCWQU16hRLfN1KaX"),ve("borts","Compendium.pf2e.equipment-srd.Item.iS7hAQMAaThHYE8g"),Se("elementalist","Compendium.pf2e.feats-srd.Item.tx9pkrpmtqe4FnvS",["air","earth","fire","water"],"half","elementalist"),Se("ganzi","Compendium.pf2e.heritages.Item.3reGfXH0S82hM7Gp",["acid","electricity","sonic"],"half","ganzi",!0),ln,qt,an,at("esoterica",["Compendium.pf2e.feats-srd.Item.OqObuRB8oVSAEKFR","Compendium.pf2e.feats-srd.Item.nWd7m0yRcIEVUy7O","Compendium.pf2e.feats-srd.Item.LHjPTV5vP3MOsPPJ"]),at("trickster",["Compendium.pf2e.feats-srd.Item.ROAUR1GhC19Pjk9C","Compendium.pf2e.feats-srd.Item.UrOj9TROtn8nuxPf","Compendium.pf2e.feats-srd.Item.lIg5Gzz7W70jfbk1"]),$t(),Yt,Ut,Jt,zt,Qt],le=[],dn,Ce=new Map;function He(e,t){let n=new Map;for(let s of e){let r=deepClone(s);try{let o=`${t}.${r.key}`;if(le.includes(o))continue;if(n.set(r.item.uuid,{daily:r,condition:r.item.condition}),r.key=o,r.children)for(let i=0;i<r.children.length;i++){let{uuid:l,condition:u}=r.children[i];n.set(l,{daily:r,index:i,condition:u})}}catch(o){j("error.unexpected"),console.error(o),console.error(`The error occured during data gathering of ${t}.${r.key}`)}}return n}a(He,"prepareDailies");function Ts(){dn=He(Ae,"dailies")}a(Ts,"prepareBaseDailies");var Te=[];async function dt(){Ce.clear(),Te=[];let e=P("customDailies");for(let{key:n,code:s}of e)try{let o=await new Le(s)();if(!ft(o,!0))continue;Te.push(o)}catch(r){j("error.unexpected"),console.error(r),console.error(`The error occured during call of custom function for ${n}`)}for(let[n,s]of dn.entries())Ce.set(n,s);let t=He(Te,"custom");for(let[n,s]of t.entries())Ce.set(n,s)}a(dt,"parseCustomDailies");function As(){let e=P("filters").trim();e||(le=[]);try{le=e.split(",").map(t=>t.trim()).filter(Boolean)}catch(t){j("error.unexpected"),console.error(t),console.error("The error occured while trying to parse the daily filters")}}a(As,"prepareDailyFilters");async function pt(){As(),Ts(),await dt()}a(pt,"prepareAllDailies");function ft(e,t=!1){return Cs.includes(e.key)?(t&&game.user.isGM&&L("deprecated.custom.key",{name:e.label.trim()||e.key},!0),!1):!0}a(ft,"checkCustomDaily");function pn(e){let t={};for(let n of e.items){let s=ne(n);if(!s||n.isOfType("physical")&&n.isInvested===!1)continue;let r=Ce.get(s);if(!r)continue;let{daily:o,index:i,condition:l}=r;try{if(typeof l=="function"&&!l({actor:e,item:n,utils:D}))continue;t[o.key]??=deepClone(o),i===void 0?t[o.key].item=n:t[o.key].children[i].item=n}catch(u){j("error.unexpected"),console.error(u),console.error(`The error occured during data gathering of ${o.key}`)}}return Object.values(t).filter(n=>n.item&&n.item instanceof Item)}a(pn,"getDailies");function fn(e){return Ce.get(e)?.daily}a(fn,"getDailyFromSourceId");function Ve(){return game.packs.get("pf2e.familiar-abilities")}a(Ve,"getFamiliarPack");function mn(e){return`Compendium.pf2e.familiar-abilities.Item.${e}`}a(mn,"familiarUUID");var Os={select:100,combo:80,random:60,alert:40,input:20,drop:0};async function yn({children:e=[],key:t,item:n,prepare:s,label:r,rows:o=[]}){let i=this.actor;this.saved[t]=T(i,t)??{},this.rows[t]={},this.children[t]=e.reduce((f,{slug:y,item:g})=>(f[y]=g,f),{});let l={actor:i,item:n,children:this.children[t],utils:D};this.custom[t]=await s?.(l)||{};let u=this.custom[t];this.dailyArgs[t]={...l,custom:u};let c=this.dailyArgs[t],d=await mt(r,c),p=d?`label.${d}`:t.startsWith("dailies.")?`label.${t.slice(8)}`:void 0;p&&ge(p)&&(d=v(p)),this.predicate[t]=e.filter(f=>f.item).map(f=>f.slug);let m={label:d?game.i18n.localize(d):n.name,rows:[]};for(let f of o){this.rows[t][f.slug]=f;let{type:y,slug:g,childPredicate:b=[],condition:x,label:I,save:h,unique:k,order:w}=f;if(b.length&&!Ue.test(b,this.predicate[t])||x&&!await x(c))continue;let E=h===!1||y==="random"?void 0:this.saved[t][g],C=await mt(I,c),G=E===void 0?"":typeof E!="object"?E:"name"in E?E.name:E.selected,O={label:C?game.i18n.localize(C):"",value:G,order:w??Os[y],data:{type:y,daily:t,row:g,...k?{unique:k}:""}};if(gn(f)||Fs(f)||Ds(f)){let Q=await mt(f.options,c)??[];if(y!=="combo"&&!Q.length)continue;let q=typeof f.labelizer=="function"&&f.labelizer(c)||(M=>Me(M));O.options=Q.map(M=>typeof M=="string"?{value:M,label:q(M)}:M),gn(f)&&(O.selected=O.value,O.data.input=E?.input??!0,!O.data.input&&Q.includes(O.selected)&&(O.value=q(O.selected)))}else Ps(f)?O.data.uuid=E?.uuid??"":Rs(f)&&(O.value=typeof f.message=="function"?await f.message(c):f.message);m.rows.push(O)}return m}a(yn,"getTemplate");async function mt(e,t){return typeof e=="function"?await e(t):e}a(mt,"getProcessedValue");function gn(e){return e.type==="combo"}a(gn,"isComboRow");function Fs(e){return e.type==="select"}a(Fs,"isSelectRow");function Ds(e){return e.type==="random"}a(Ds,"isRandomRow");function Ps(e){return e.type==="drop"}a(Ps,"isDropRow");function Rs(e){return e.type==="alert"}a(Rs,"isAlerRow");function Ye(e,t,n){if(t===void 0)return n;if(typeof t=="number")return t;if(t==="level")return e.level;if(t==="half")return Math.max(1,Math.floor(e.level/2));let s=Number(t);return Number.isNaN(s)?n:s}a(Ye,"getSimplifiableValue");async function hn(e){return{type:e.type,search:await(e.type==="feat"?Ms(this.actor,e.search):Ls(this.actor,e.search)),drop:e.drop}}a(hn,"parseFilter");function z(e,t){if(e?.length){t.selected=e,t.isExpanded=!0;for(let n of e)t.options[n].selected=!0}}a(z,"checkFilter");function bn(e,t){let n=Ke(e);n?.selected.length&&(t.conjunction=n.conjunction,t.selected=n.selected)}a(bn,"setTraits");function Ke(e){if(!e)return;let t=Array.isArray(e)?e:e.selected;if(t?.length)return{selected:t.map(n=>typeof n=="string"?{value:n}:n),conjunction:!Array.isArray(e)&&e.conjunction||"and"}}a(Ke,"getFilterTraits");async function Ls(e,t){let n=await game.pf2e.compendiumBrowser.tabs.spell.getFilterData();z(t.category,n.checkboxes.category),z(t.school,n.checkboxes.school),z(t.traditions,n.checkboxes.traditions),z(t.rarity,n.checkboxes.rarity),z(t.source,n.checkboxes.source),bn(t.traits,n.multiselects.traits);let s=gt(e,t.level);return s?.length&&z(s,n.checkboxes.rank),n}a(Ls,"parseSpellFilter");async function Ms(e,t){let n=await game.pf2e.compendiumBrowser.tabs.feat.getFilterData();z(t.category,n.checkboxes.category),z(t.skills,n.checkboxes.skills),z(t.rarity,n.checkboxes.rarity),z(t.source,n.checkboxes.source),bn(t.traits,n.multiselects.traits);let s=yt(e,t.level);return s&&(n.sliders.level.values.min=s.min,n.sliders.level.values.max=s.max,n.sliders.level.isExpanded=!0),n}a(Ms,"parseFeatFilter");function gt(e,t){if(Array.isArray(t))return t;let n=Ye(e,t);if(n)return Re(1,n)}a(gt,"getSpellFilterLevel");function yt(e,t){if(t!==void 0)return typeof t=="object"?{min:Ye(e,t.min,0),max:Ye(e,t.min,20)}:{min:0,max:Ye(e,t,20)}}a(yt,"getFeatFilterLevel");var A=N("interface.error.drop");async function vn(e,t,n){if(!e.isOfType("feat"))return A("notFeat");let{search:s,drop:r}=n;if(s.category?.length&&!s.category.includes(e.category))return A.warn("wrongType",{types:ce("featCategories",s.category)});if(s.traits){let i=Ke(s.traits);if(i?.selected.length){let l=i.conjunction==="or"?"some":"every";if(!i.selected[l](c=>Number(c.not??!1)-Number(e.traits.has(c.value))))return A.warn("wrongTraits")}}if(s.skills?.length){let i=D.getTranslatedSkills(!0),l=e.system.prerequisites.value.map(c=>c.value.toLocaleLowerCase());if(!s.skills.some(c=>l.some(d=>d.includes(c)||d.includes(i[c]))))return A.warn("wrongSkill",{skills:ce("skillList",s.skills)})}if(s.rarity?.length&&!s.rarity.includes(e.system.traits.rarity))return A.warn("wrongRarity",{rarities:ce("rarityTraits",s.rarity)});if(s.source?.length&&!s.source.includes(H(e.system.source.value)))return A.warn("wrongSource",{sources:s.source.join(", ")});let o=yt(this.actor,s.level);if(o){let i=e.level;if(i<o.min)return A.warn("wrongLevelLow",{level:`min: ${o.min}`});if(i>o.max)return A.warn("wrongLevelHigh",{level:`max: ${o.max}`})}if(r){let i=this.dailyArgs[t.dataset.daily];if(i){let l=await r(e,i);if(typeof l=="object")return l.data?game.i18n.format(l.error,l.data):game.i18n.localize(l.error);if(l===!1)return A.warn("wrongCustom")}}Oe(e,t)}a(vn,"onDropFeat");async function Sn(e,t,n){if(!e.isOfType("spell"))return A("notSpell");let{search:s,drop:r}=n;if(s.category?.length){let i=s.category.map(l=>game.i18n.localize(l==="cantrip"?"PF2E.SpellCantripLabel":CONFIG.PF2E.preparationType[l])).join(", ");if(e.isCantrip&&!s.category.includes("cantrip")||e.isFocusSpell&&!s.category.includes("focus")||e.isRitual&&!s.category.includes("ritual")||!e.isCantrip&&!e.isFocusSpell&&!e.isRitual&&!s.category.includes("spell"))return A.warn("wrongCategory",{categories:i})}if(s.traits){let i=Ke(s.traits);if(i?.selected.length){let l=i.conjunction==="or"?"some":"every";if(!i.selected[l](c=>Number(c.not??!1)-Number(e.traits.has(c.value))))return A.warn("wrongTraits")}}if(s.traditions?.length&&!s.traditions.some(i=>e.traditions.has(i)))return A.warn("wrongTradition",{traditions:ce("magicTraditions",s.traditions)});let o=gt(this.actor,s.level);if(o?.length&&!o.includes(e.level))return A.warn("wrongLevel",{levels:o.join(", ")});if(s.school?.length&&!s.school.includes(e.school))return A.warn("wrongSchool",{schools:ce("magicSchools",s.school)});if(s.rarity?.length&&!s.rarity.includes(e.system.traits.rarity))return A.warn("wrongRarity",{rarities:ce("rarityTraits",s.rarity)});if(s.source?.length&&!s.source.includes(H(e.system.source.value)))return A.warn("wrongSource",{sources:s.source.join(", ")});if(r){let i=this.dailyArgs[t.dataset.daily];if(i){let l=await r(e,i);if(typeof l=="object")return l.data?ui.notifications.warn(game.i18n.format(l.error,l.data)):ui.notifications.warn(game.i18n.localize(l.error));if(l===!1)return A.warn("wrongCustom")}}Oe(e,t)}a(Sn,"onDropSpell");function ce(e,t){return t.map(s=>game.i18n.localize(CONFIG.PF2E[e][s])).join(", ")}a(ce,"localizeAll");function Oe(e,t){t.value=e.name,t.dataset.uuid=e.uuid,t.nextElementSibling.nextElementSibling.classList.remove("disabled")}a(Oe,"onDropItem");async function wn(){let e=this.actor,t=this.dailies,n=_s.call(this),s=[],r=new Map,[o,i]=Xe(),l={},u=N("message"),c=!1,d="",p=a(g=>{let b=g.id,x=r.get(b);if(x)return x;let I=deepClone(g._source.system.rules);for(let h=I.length-1;h>=0;h--)S.id in I[h]&&I.splice(h,1);return r.set(b,I),I},"getRules"),m={languages:{order:80,messages:[]},skills:{order:70,messages:[]},resistances:{order:60,messages:[]},feats:{order:50,messages:[]},spells:{order:40,messages:[]},scrolls:{order:30,messages:[]}},f=[],y={add:(g,b)=>{m[g]??={order:0,messages:[]},m[g].messages.push(b)},addGroup:(g,b,x)=>{m[g]??={label:x,order:b??1,messages:[]}},addRaw:(g,b=1)=>{f.push({order:b,message:g})}};if(e.familiar&&n["dailies.familiar"]){let g=e.familiar,b=Ve(),x=[],I=g.itemTypes.action.map(h=>h.id);I.length&&g.deleteEmbeddedDocuments("Item",I),y.addGroup("familiar",20);for(let h of Object.values(n["dailies.familiar"])){let k=h.value,w=k.includes("."),E=await(w?fromUuid(k):b.getDocument(k));if(!E||!E.isOfType("action"))continue;let C=E.toObject();C&&(x.push(C),y.add("familiar",{uuid:w?k:mn(k)}))}x.length&&g.createEmbeddedDocuments("Item",x)}if(n["dailies.staff"]){let g=n["dailies.staff"],b=g.staffID.value,x=e.items.get(b),I=g.staffID.makeshift==="true",h=Ee(e);if(x&&(h||I)){let k=[],w=P("staff-regex").trim()||We,E=new RegExp(`<strong>\\s*(?<rank>(?:${w}))\\s*</strong>.+?(?<uuids>@(?:UUID|Compendium)[[a-zA-Z0-9-.]+].+?)
`,"gi"),C=E.exec(x.description);for(;C!==null;){let G=C.groups.rank.trim().replace(/\D+/,"")||"0",O=Math.clamped(parseInt(G),0,10),Q=/@(?<protocole>UUID|Compendium)\[(?<uuid>[a-zA-Z0-9-.]+)\]/g,q=Q.exec(C.groups.uuids);for(;q!==null;){let M=q.groups.uuid;q.groups.protocole==="Compendium"&&(M.startsWith("Compendium.")||(M=`Compendium.${M}`)),fromUuidSync(M)&&k.push({rank:O,uuid:M}),q=Q.exec(C.groups.uuids)}C=E.exec(x.description)}if(k.length){let G=0,O=[],Q=I?[1,2,3]:[1],q=v("interface.staves.flexible"),M=v("interface.staves.empty"),De={};for(let Ze of Q){let J=g[`expend${Ze}`]?.optionData;if(!J)continue;let W=J.entry,Pe=e.items.get(W);if(!Pe)continue;let F=Number(J.rank),_=Pe._source.system.slots[`slot${F}`];if(J.type==="spell"){let U=deepClone(_.prepared),pe=U[J.index];if(_.max<1||pe.expended)return;G+=F,pe.expended=!0,i({_id:W,[`system.slots.slot${F}.prepared`]:U});let fe=e.items.get(pe.id);O.push({uuid:fe?.uuid,name:fe?.name??M,rank:F})}else{if(_.max<1||_.value<1)continue;De[W]??={},De[W][F]??=_.value;let U=De[W][F];if(U<1)continue;G+=F,i({_id:W,[`system.slots.slot${F}.value`]:U-1}),De[W][F]-=1,O.push({name:q,rank:F})}}let St=tn(e);if(St){let{ability:Ze,tradition:wt,proficiency:J}=St,W=(()=>{let{min:F,max:_}=on(e);return P("staff-sort")==="bottom"?_+1e4:F-1e4})(),Pe={type:"spellcastingEntry",name:x.name,sort:W,system:{ability:Ze,prepared:{value:"charge"},showSlotlessLevels:{value:!1},showUnpreparedSpells:{value:!1},proficiency:J,tradition:wt},flags:{[S.id]:{type:"staff",staff:{charges:h+G,staveID:b,overcharge:G,makeshift:I}}}};s.push(Pe),await Promise.all(k.map(async({rank:F,uuid:_})=>{let U=await D.createSpellSource(_);setProperty(U,`flags.${S.id}.entry`,{level:F,type:"staff"}),s.push(U)})),y.addGroup("staff",45,v(`staves.message.${G?"withExpend":"noExpend"}`,{makeshift:I?v("staves.makeshift"):""})),y.add("staff",{uuid:x.uuid});for(let{uuid:F,name:_,rank:U}of O){let pe=D.spellRankLabel(U),fe=`${_} (${pe})`;y.add("staff",{uuid:F,label:F?fe:`<span class="fake-link">
									<i class='fa-solid fa-sparkles'></i>
									${fe}
								</span>`})}}}}}for(let{item:g,key:b,process:x}of t){if(!n[b])continue;let I=this.dailyArgs[b];try{await x({...I,fields:n[b],messages:y,addItem:h=>s.push(h),updateItem:i,removeRule:(h,k)=>{let w=p(k??g);for(let E=w.length-1;E>=0;E--){let C=w[E];h(C)&&w.splice(E,1)}},addRule:(h,k)=>{h[S.id]=!0,p(k??g).push(h)},addFeat:(h,k)=>{let w=k??g;if(w.isOfType("feat")){let E=w.id;setProperty(h,"flags.pf2e.grantedBy",{id:E,onDelete:"cascade"}),setProperty(h,`flags.${S.id}.grantedBy`,E)}s.push(h)},addSpell:(h,k)=>{setProperty(h,`flags.${S.id}.entry`,{level:k,type:"fallback"}),s.push(h),c=!0}})}catch(h){j("error.unexpected"),console.error(h),console.error(`The error occured during processing of ${b}`)}}for(let[g,b]of Object.entries(n)){let x=this.rows[g];if(x)for(let{row:I,type:h,input:k,value:w,uuid:E}of Object.values(b)){if(h==="random"||x[I]?.save===!1)continue;l[g]??={};let C=l[g];h==="combo"?C[I]={input:k==="true",selected:w}:h==="drop"?C[I]={uuid:E,name:w}:C[I]=w}}for(let[g,b]of r)i({_id:g,"system.rules":b});if(c){let g={type:"spellcastingEntry",name:v("spellEntry.name"),system:{prepared:{value:"innate"},showSlotlessLevels:{value:!1},showUnpreparedSpells:{value:!1},proficiency:{value:1,slug:e.classDC?.slug||e.class?.slug||void 0}},flags:{[S.id]:{type:"fallback"}}};s.push(g)}for(let g of s)getProperty(g,"system.temporary")===!0||setProperty(g,`flags.${S.id}.temporary`,!0);if(s.length){let g=await e.createEmbeddedDocuments("Item",s);for(let b of g)if(b.isOfType("feat")){let x=T(b,"grantedBy");if(x){let h=`flags.pf2e.itemGrants.${H(b.name,{camel:"dromedary"})}`;i({_id:x,[h]:{id:b.id,onDelete:"detach"}})}}else if(b.isOfType("spellcastingEntry")){let x=T(b,"type"),I=g.filter(h=>h.isOfType("spell")&&T(h,"entry")?.type===x);for(let h of I){let{level:k}=T(h,"entry"),w={_id:h.id,"system.location.value":b.id};k!==void 0&&(w["system.location.heightenedLevel"]=k),i(w)}}}await e.update({[`flags.${S.id}`]:{...expandObject(l),rested:!1}}),o.size&&await e.updateEmbeddedDocuments("Item",o.contents),f.sort((g,b)=>b.order-g.order);for(let{message:g}of f)d+=`${g}<hr />`;d+=await Ns(m,d),d=d?`${u("changes")}<hr />${d}`:u("noChanges"),ChatMessage.create({content:`<div class="pf2e-dailies-summary">${d}</div>`,speaker:ChatMessage.getSpeaker({actor:e})})}a(wn,"processData");async function Ns(e){let t=N("message"),n=Object.entries(e).map(([r,o])=>(o.label??=t.has(r)?t(r):t("gained",{type:r}),o));n.sort((r,o)=>o.order-r.order);let s="";for(let{label:r,messages:o}of n)if(o.length){s&&(s+="<hr />"),r&&(s+=`<p><strong>${r}</strong></p>`);for(let{uuid:i,selected:l,label:u,random:c}of o){let d=`label.${u}`;u=u&&ge(d)?v(d):u||"",s+="<p>",s+=i?`${await he(i,{label:u})}`:` ${u}`,l&&(s+=`<i class="fa-solid fa-caret-right"></i>${l}`),c&&(s+='<i class="fa-solid fa-dice-d20"></i>'),s+="</p>"}}return s}a(Ns,"parseMessages");function _s(){let e=this.element.find(".window-content .content").find("input:not(.alert), select[data-type]").toArray(),t={};for(let n of e){let s={...n.dataset,value:n.value};if(s.type==="combo"&&s.input==="false"){let r=n.previousElementSibling;s.value=r.value,s.optionData=r.selectedOptions[0].dataset}s.type==="select"&&(s.optionData=n.selectedOptions[0].dataset),t[s.daily]??={},t[s.daily][s.row]=s}return t}a(_s,"getFields");var K=N("interface"),$s="Compendium.pf2e.classfeatures.Item.Klb35AwlkNrq1gpB",Qe=class extends Application{static{a(this,"DailiesInterface")}constructor(t,n,s){super(n),this._actor=t,this._dailies=[],this._dailyArgs={},this._saved={},this._children={},this._custom={},this._predicate={},this._rows={},this._message=s}static get defaultOptions(){return mergeObject(Application.defaultOptions,{id:"pf2e-dailies-interface",template:me("interface"),height:"auto",width:400,submitOnClose:!1,submitOnChange:!1,dragDrop:[{dropSelector:'[data-droppable="true"]'}]})}get actor(){return this._actor}get dailies(){return this._dailies}get dailyArgs(){return this._dailyArgs}get saved(){return this._saved}get children(){return this._children}get custom(){return this._custom}get predicate(){return this._predicate}get rows(){return this._rows}async getData(t){let n=[],s=this._actor;if(this._dailies=pn(s),s.familiar&&!le.includes("dailies.familiar")){let i="dailies.familiar",l=N("label"),u=s.attributes.familiarAbilities.value,c=Ve(),d=T(s,i)??{},p={label:l("familiar"),rows:[]},m=c.index.map(({_id:y,name:g})=>({value:y,label:g})),f=P("familiar").split(",");for(let y of f){y=y.trim();let g=await fromUuid(y);g?.isOfType("action")&&m.push({value:y,label:g.name})}m.sort((y,g)=>y.label.localeCompare(g.label));for(let y=0;y<u;y++)p.rows.push({label:l("ability",{nb:y+1}),value:d[`${y}`]??"",order:100,options:m,data:{type:"select",daily:i,row:y.toString(),unique:"ability"}});p.rows.length&&(this._rows[i]=p.rows.reduce((y,{data:g})=>(y[g.row]={save:!0},y),{}),n.push(p))}if(!le.includes("dailies.staves")&&!Y()){let i=en(s);if(i.length&&Ee(s)){let u="dailies.staff",c=T(s,u)??{},d=i.map(y=>({value:y.id,label:y.name}));d.sort((y,g)=>y.label.localeCompare(g.label));let p={label:K("staves.staff"),value:c.staffID??"",order:100,options:d,data:{type:"select",daily:u,row:"staffID"}},m={label:K("staves.prepare"),rows:[p]};this._rows[u]={staffID:{save:!0}};let f=nn(s);if(f.length){let y=[{value:"",label:""}],g=K("staves.flexible"),b=K("staves.emty");for(let h of f){let k=h.id;y.push({groupStart:!0,label:h.name});for(let w of h.spells??[]){let E=w.name??b,C=`${w.rank}.${w.index}`;y.push({value:C,label:`${E} (${D.spellRankLabel(w.rank)})`,data:{type:"spell",rank:w.rank,index:w.index,unique:C,entry:k}})}for(let w of h.slots??[]){let E=D.spellRankLabel(w.rank),C={type:"slot",rank:w.rank,entry:k};w.value>1?C.skipUnique=!0:C.unique=`${k}.${w.rank}`,y.push({value:w.rank,label:`${g} ${w.value}/${w.max} (${E})`,data:C})}y.push({groupEnd:!0})}let x=B(s,$s,"feat"),I=x&&s.level>=8?s.level>=16?3:2:1;x&&(p.data.makeshift=!0);for(let h=1;h<=I;h++)m.rows.push({label:K("staves.expend"),value:"",order:100,options:y,data:{type:"select",daily:u,row:`expend${h}`,unique:"expend"}}),this._rows[u][`expend${h}`]={save:!1}}n.push(m)}}for(let i of this._dailies)try{let l=await yn.call(this,i);n.push(l)}catch(l){K.error("error.unexpected"),console.error(l),console.error(`The error occured during templating of ${i.key}`)}let r=[],o=[];for(let i of n)i.rows.length>1?o.push(i):i.rows.length&&r.push(i);return r.sort((i,l)=>l.rows[0].order-i.rows[0].order),o.sort((i,l)=>i.rows.length-l.rows.length),mergeObject(super.getData(t),{i18n:K.template,dump:({value:i,placeholder:l,data:u})=>{let c="";if(i&&(c+=` value="${i}"`),l&&(c+=` placeholder="${l}"`),typeof u=="object")for(let[d,p]of Object.entries(u)){let m=d.replace(/[A-Z]/g,f=>`-${f}`);c+=` data-${m}="${p}"`}return c&&(c+=" "),c},rows:r,groups:o,hasDailies:r.length||o.length})}render(t,n){return this._randomInterval&&clearInterval(this._randomInterval),this.element.find("select.random")&&(this._randomInterval=setInterval(()=>{this.element.find("select.random").each((r,o)=>{o.selectedIndex=(o.selectedIndex+1)%o.options.length})},2e3)),super.render(t,n)}close(t){return this._randomInterval&&clearInterval(this._randomInterval),super.close(t)}activateListeners(t){super.activateListeners(t),t.find("[data-action=clear]").on("click",this.#u.bind(this)),t.find("[data-action=accept]").on("click",this.#c.bind(this)),t.find("[data-action=cancel]").on("click",this.#d.bind(this)),t.find(".combo select").on("change",this.#r.bind(this)),t.find(".combo input").on("change",this.#o.bind(this)),t.find("[data-action=search]").on("click",this.#s.bind(this)),t.find("[data-action=alert]").on("click",this.#e.bind(this));let n=t.find("select[data-unique]");n.on("change",s=>this.#a(s.currentTarget,!0));{let s=[];for(let r of n){let{unique:o,daily:i}=r.dataset,l=`${i}.${o}`;s.includes(l)||(s.push(l),this.#a(r,!1))}}}_canDragDrop(t){return!0}async _onDrop(t){let n=N("interface.error.drop"),s=t.target;s instanceof HTMLLabelElement&&(s=s.nextElementSibling);try{let r=t.dataTransfer?.getData("text/plain"),o=JSON.parse(r);if(!o||o.type!=="Item"||typeof o.uuid!="string")return n.warn("wrongDataType");let i=await fromUuid(o.uuid);if(!i)return n.warn("wrongDataType");let l=await this.#n(s);if(!l)return Oe(i,s);l.type==="feat"?vn.call(this,i,s,l):l.type==="spell"?Sn.call(this,i,s,l):Oe(i,s)}catch(r){n.error("error.unexpected"),console.error(r),console.error("The error occured during _onDrop")}}async#e(t){t.preventDefault(),this.#t();let n=t.currentTarget.dataset,s=this.rows[n.daily][n.row],r=this.dailyArgs[n.daily],o;try{o=await s.fix(r)}catch(i){K.error("error.unexpected"),console.error(i),console.error(`The error occured during an alert fix of '${n.daily}'`)}this.#i(),o&&this.render()}async#s(t){t.preventDefault();let n=await this.#n(t.currentTarget,!0);n?game.pf2e.compendiumBrowser.openTab(n.type,n.search):game.pf2e.compendiumBrowser.render(!0)}async#n(t,n){let{daily:s,row:r}=t.dataset,o=this.rows[s]?.[r]?.filter,i=this.dailyArgs[s];if(!(!i||!o))return typeof o.search=="function"&&(o.search=await o.search(i)),n?hn.call(this,o):o}#r(t){let n=t.currentTarget,s=n.nextElementSibling;s.dataset.input="false",s.value=n.options[n.selectedIndex].text}#o(t){let n=t.currentTarget,s=n.previousElementSibling,r=n.value.toLowerCase(),i=Array.from(s.options).map(l=>l.value).indexOf(r);i!==-1?(s.value=r,n.value=s.options[i].text,n.dataset.input="false"):(s.value="",n.dataset.input="true")}#t(){this.element.addClass("disabled")}#i(){this.element.removeClass("disabled")}#l(){let t=[],n=this.element,s=n.find("input").filter((o,i)=>!i.value),r=n.find("input.alert");s.length&&t.push("error.empty"),r.length&&t.push("error.unattended"),n.find("label").removeClass("empty");for(let o of s){let i=o.parentElement;(i.classList.contains("combo")?i:o).previousElementSibling.classList.add("empty")}for(let o of t)K.warn(o);return!t.length}async#c(t){t.preventDefault(),this.#l()&&(this.#t(),await wn.call(this),this._message&&Z(this._message,"prepared",!0),this.close())}#u(t){t.preventDefault();let n=$(t.currentTarget),s=n.prevAll("input").first();s.val(""),s.attr("value",""),s.attr("data-uuid",""),n.addClass("disabled")}#d(t){t.preventDefault(),this.close()}#a(t,n){let s=t.dataset.unique,r=n?[t,...js(t,`select[data-unique="${s}"]`)]:t.parentElement.querySelectorAll(`:scope > select[data-unique="${s}"]`),o=new Set;for(let i of r){let l=i.selectedIndex,u=i.options,c=a(()=>{let f=u[l];return f.dataset.skipUnique?void 0:f.dataset.unique??f.value},"optionUniqueValue"),d=a(()=>{let f=c();return f&&o.has(f)},"optionExists");for(;d()&&l>0;)l-=1;let p=i.options.length-1;for(;d()&&l<p;)l+=1;if(d())continue;let m=c();m&&o.add(m),i.selectedIndex!==l&&(i.selectedIndex=l)}for(let i of r){let l=i.selectedIndex,u=i.options;for(let c=0;c<u.length;c++){if(c===l)continue;let d=u[c];d.disabled=o.has(d.dataset.unique??d.value)}}}};function js(e,t){let n=[],s=e.parentElement;if(!s)return n;let r=t?s.querySelectorAll(`:scope > ${t}`):s.children;for(let o of r)o!==e&&n.push(o);return n}a(js,"getSiblings");var xn="max(1,floor(@actor.level/2))",Us=["propertyRune1","propertyRune2","propertyRune3","propertyRune4"],kn,En,D={get skillNames(){return kn??=Object.keys(CONFIG.PF2E.skillList).filter(e=>e!=="lore"),kn.slice()},skillLabel:e=>game.i18n.localize(CONFIG.PF2E.skillList[e]),createSkillRuleElement:({skill:e,value:t,mode:n="upgrade",predicate:s})=>{let r={key:"ActiveEffectLike",mode:n,path:`system.skills.${e}.rank`,value:t};return s?.length&&(r.predicate=s),r},createLoreSource:({name:e,rank:t})=>({type:"lore",img:"systems/pf2e/icons/default-icons/lore.svg",name:e,system:{proficient:{value:t}}}),getTranslatedSkills:(e=!1)=>Object.entries(CONFIG.PF2E.skillList).reduce((t,[n,s])=>{let r=game.i18n.localize(s);return t[n]=e?r.toLocaleLowerCase(game.i18n.lang):r,t},{}),get languageNames(){return En??=Object.keys(CONFIG.PF2E.languages),En.slice()},languageLabel:e=>game.i18n.localize(CONFIG.PF2E.languages[e]),createLanguageRuleElement:({language:e,mode:t="add",predicate:n})=>{let s={key:"ActiveEffectLike",mode:t,path:"system.build.languages.granted",value:{slug:e,source:"{item|name}"}};return n?.length&&(s.predicate=n),s},resistanceLabel:(e,t)=>{let n=game.i18n.localize(`PF2E.Trait${Me(e)}`);return t&&(n+=` ${t}`),n},createResistanceRuleElement:({type:e,value:t,predicate:n})=>{t==="half"&&(t=xn);let s={key:"Resistance",type:e,value:t};return n?.length&&(s.predicate=n),s},createFeatSource:async e=>{let t=(await fromUuid(e))?.toObject();if(!t)throw new Error(`An error occured while trying to create a feat source with uuid: ${e}`);return t},createSpellScrollSource:async e=>In("scroll",e),createWandSource:async e=>In("wand",e),createSpellSource:async e=>{let t=(await fromUuid(e))?.toObject();if(!t)throw new Error(`An error occured while trying to create a spell source with uuid: ${e}`);return t},spellRankLabel:e=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:Pt(e)}),get halfLevelString(){return xn},getChoiSetRuleSelection:(e,t)=>e._source.system.rules.find(r=>r.key==="ChoiceSet"&&(!t||r.rollOption===t))?.selection,proficiencyLabel:e=>game.i18n.localize(CONFIG.PF2E.proficiencyLevels[e]),randomOption:async e=>{let t=(await new Roll(`1d${e.length}`).evaluate({async:!0})).total,n=e[t-1];return typeof n=="string"?n:n.value},halfLevelValue:e=>Math.max(1,Math.floor(e.level/2)),sequenceArray:Re,damageLabel:e=>game.i18n.localize(CONFIG.PF2E.damageTypes[e]),weaponTraitLabel:e=>game.i18n.localize(CONFIG.PF2E.weaponTraits[e]),weaponPropertyRunesLabel:e=>{let t=`PF2E.WeaponPropertyRune.${e}.Name`;return game.i18n.localize(t)},hasFreePropertySlot:e=>{let t=e.system.runes.potency;return t>0&&e.system.runes.property.length<t},getFreePropertyRuneSlot:e=>{let t=e.system.potencyRune.value;if(t===null)return null;for(let n=0;n<t;n++){let s=Us[n];if(!e.system[s].value)return s}return null},getPlayersActors:(e,...t)=>{let n=t.length?t:["creature"],s=e instanceof Actor,r=game.actors;return s&&e.parties.size&&P("members")?(r=Array.from(e.parties??[]).flatMap(o=>o.members),r=Array.from(new Set(r))):r=r.filter(o=>o.hasPlayerOwner),r.filter(o=>o.isOfType(...n)&&(!s||o!==e))}};async function In(e,{uuid:t,level:n,itemName:s,itemImg:r}){let o=await fromUuid(t);if(!o)throw new Error(`An error occured while trying to create a spell scroll source with uuid: ${t}`);return _t(o,{type:e,heightenedLevel:n,temp:!0,itemName:s,itemImg:r})}a(In,"createSpellConsumableSource");function ue(e,t){let n=e;if((!n||!n.isOfType("character")||!n.isOwner)&&(n=canvas.tokens.controlled.find(r=>r.actor?.isOfType("character")&&r.actor.isOwner)?.actor,n||(n=game.user.character)),!n||!n.isOfType("character")||!n.isOwner)return warn("error.noCharacterSelected");if(!Fe(n))return warn("error.unrested");new Qe(n,{title:v("interface.title",{name:n.name})},t).render(!0)}a(ue,"openDailiesInterface");function Xe(){let e=new Collection;return[e,t=>{let n=t._id;if(!n)return;let s=e.get(n)??{};e.set(n,mergeObject(s,t))}]}a(Xe,"createUpdateCollection");async function Cn(){let e=(await this.getCraftingEntries()).filter(o=>o.isDailyPrep),n=e.filter(o=>o.isAlchemical).reduce((o,i)=>o+i.reagentCost,0),s=(this.system.resources.crafting.infusedReagents.value||0)-n;if(s<0){ui.notifications.warn(game.i18n.localize("PF2E.CraftingTab.Alerts.MissingReagents"));return}await this.update({"system.resources.crafting.infusedReagents.value":s});let r=n===0?"ZeroConsumed":n===1?"OneConsumed":"NConsumed";ui.notifications.info(game.i18n.format(`PF2E.Actor.Character.Crafting.Daily.Complete.${r}`,{quantity:n}));for(let o of e)for(let i of o.preparedCraftingFormulas){let l=i.item.toObject();l.system.quantity=i.quantity,l.system.temporary=!0,l.system.size=this.ancestry?.size==="tiny"?"tiny":"med",o.isAlchemical&&Mt(l,"consumable","equipment","weapon")&&l.system.traits.value.push("infused"),await this.addToInventory(l)}}a(Cn,"performDailyCrafting");function Tn(e,t){let n=e.actor;if(!n.isOwner)return;let s=Fe(n),r=s?"":" disabled",o=v(s?"sheet.title":"sheet.unrested"),i=`<a class="roll-icon dailies${r}" data-tooltip="${o}">
	<i class="fas fa-mug-saucer"></i>
</a>`,l=t.find("aside .sidebar .hitpoints .hp-small");l.append(i),s&&l.find(".dailies").on("click",()=>ue(n)),Y()||zs(t,n)}a(Tn,"renderCharacterSheetPF2e");function zs(e,t){let s=e.find(".sheet-body .sheet-content [data-tab=spellcasting] [data-tab=known-spells] .spellcastingEntry-list").find("[data-container-type=spellcastingEntry]");for(let r of s){let o=r.dataset.containerId,i=t.spellcasting.get(o),l=xe(i);if(!l)continue;let u=v("staves.label"),c=$(`<div class="pf2e-dailies-charges"><label>${u}</label></div>`),d=$(`<input type="number" min="0" max="${l.max}" value="${l.charges}">`);d.on("change",f=>qs(f,t));let p=$('<a><i class="fas fa-redo"></i></a>');p.on("click",f=>Gs(f,t)),c.append(d),c.append(p),r.querySelector(".spell-ability-data .statistic-values").after(c[0]);let m=r.querySelectorAll('.spell-list .spell:not([data-group-id="cantrips"]');for(let f of m){let y=f.dataset.castRank;l.canPayCost(y)||(f.dataset.slotExpended="")}}}a(zs,"renderStavesEntries");function An(e,t){let{itemId:n}=e.currentTarget.closest(".spellcasting-entry").dataset;return t.spellcasting.get(n)}a(An,"getEntryDataFromEvent");async function Gs(e,t){let n=An(e,t);ke(n,9999)}a(Gs,"onStaffChargesReset");async function qs(e,t){let n=An(e,t);ke(n,e.currentTarget.valueAsNumber)}a(qs,"onStaffChargesChange");function Fe(e){return T(e,"rested")!==!1}a(Fe,"canPrepDailies");function On(e,t,n,s){return{key:e,label:s,item:{uuid:t},rows:[{type:"drop",slug:"feat",filter:{type:"feat",search:n??{}}}],process:async({utils:o,fields:i,addFeat:l,messages:u})=>{let c=i.feat.uuid,d=await o.createFeatSource(c);l(d),u.add("feats",{uuid:c})}}}a(On,"createFeatDaily");var Fn=["/** @typedef {'flexibility' | 'improved'} FlexibilityRow */","/** @typedef {'improved'} FlexibilityChild */","/** @typedef {[FlexibilityRow, {}, FlexibilityChild]} FlexibilityGenerics */","","/**"," * @param {FlexibilityRow} slug"," * @param {number} level"," * @param {FlexibilityChild} [child]"," */","function createRow(slug, level, child) {","    /** @type {DailyRowDrop<FlexibilityGenerics>} */","    const row = {","        type: 'drop',","        label: `PF2E.Level${level}`,","        slug,","        filter: {","            type: 'feat',","            search: {","                category: ['class'],","                traits: {","                    values: ['fighter'],","                },","                level,","            },","        },","    }","    if (child) row.childPredicate = [child]","    return row","}","","/** @type {Daily<FlexibilityGenerics>} */","const combatFlexibility = {","    key: 'flexibility',","    item: {","        uuid: 'Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8', // Combat Flexibility","    },","    children: [","        {","            slug: 'improved',","            uuid: 'Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX', // Improved Flexibility","        },","    ],","    rows: [","        createRow('flexibility', 8), //","        createRow('improved', 14, 'improved'),","    ],","    process: async ({ utils, fields, addFeat, messages, children }) => {","        const uuid = fields.flexibility.uuid","        const source = await utils.createFeatSource(uuid)","        addFeat(source)","        messages.add('feats', { uuid })","","        if (children.improved) {","            const uuid = fields.improved.uuid","            const source = await utils.createFeatSource(uuid)","            addFeat(source, children.improved)","            messages.add('feats', { uuid })","        }","    },","}","","return combatFlexibility"].join(`
`);var Dn=["/** @typedef {'alert' | 'smith' | 'mental' | 'runic' | 'advanced'} MindRow */","/** @typedef {'weapon' | 'mental' | 'runic' | 'advanced'} MindChild */","/** @typedef {[MindRow, {}, MindChild]} MindGenerics */","","const MIND_WEAPON_UUID = 'Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P'","","const WEAPON_BASE_TYPES = {","    0: { die: 'd4', traits: ['finesse', 'agile'], usage: 'held-in-one-hand' },","    1: { die: 'd6', traits: ['finesse'], usage: 'held-in-one-hand' },","    2: { die: 'd8', traits: [], usage: 'held-in-one-hand' },","    3: { die: 'd10', traits: ['reach'], usage: 'held-in-two-hands' },","}","","const WEAPON_GROUPS = /** @type {Record<WeaponDamage, string>} */ {","    slashing: 'sword',","    piercing: 'spear',","    bludgeoning: 'club',","}","","const WEAPON_TRAITS = ['grapple', 'nonlethal', 'shove', 'trip', 'modular']","","const WEAPON_DAMAGE_TYPES = Object.keys(WEAPON_GROUPS)","","const WEAPON_RUNES = ['corrosive', 'disrupting', 'flaming', 'frost', 'shock', 'thundering']","","const WEAPON_GREATER_RUNES = [","    'anarchic',","    'axiomatic',","    'greaterCorrosive',","    'greaterDisrupting',","    'greaterFlaming',","    'greaterFrost',","    'greaterShock',","    'greaterThundering',","    'holy',","    'unholy',","]","","/** @type {Daily<MindGenerics>} */","const mindSmith = {","    key: 'mindsmith',","    item: {","        uuid: 'Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY', // Mind Smith Dedication","    },","    children: [","        {","            slug: 'weapon',","            uuid: MIND_WEAPON_UUID, // Mind Weapon","        },","        {","            slug: 'mental',","            uuid: 'Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky', // Malleable Mental Forge","        },","        {","            slug: 'runic',","            uuid: 'Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp', // Runic Mind Smithing","        },","        {","            slug: 'advanced',","            uuid: 'Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD', // Advanced Runic Mind Smithing","        },","    ],","    rows: [","        {","            type: 'alert',","            slug: 'alert',","            message: 'Missing Mind Weapon',","            fix,","            childPredicate: [{ not: 'weapon' }],","        },","        {","            type: 'select',","            slug: 'smith',","            label: 'Mind Smith',","            options: WEAPON_DAMAGE_TYPES,","            labelizer: ({ utils }) => utils.damageLabel,","            childPredicate: ['weapon'],","        },","        {","            type: 'select',","            slug: 'mental',","            label: 'Mental Forge',","            options: WEAPON_TRAITS,","            labelizer: ({ utils }) => utils.weaponTraitLabel,","            childPredicate: ['weapon', 'mental'],","        },","        {","            type: 'select',","            slug: 'runic',","            label: 'Runic Smithing',","            options: WEAPON_RUNES,","            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,","            childPredicate: ['weapon', 'runic', { not: 'advanced' }],","            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),","        },","        {","            type: 'select',","            slug: 'advanced',","            label: 'Runic Smithing',","            options: WEAPON_GREATER_RUNES,","            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,","            childPredicate: ['weapon', 'advanced'],","            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),","        },","    ],","    process: ({ children, updateItem, fields, messages, item, utils }) => {","        const weapon = children.weapon","        if (!weapon) return","","        messages.addGroup('mindsmith')","","        const selected = /** @type {WeaponDamage} */ fields.smith.value","        updateItem({ _id: weapon.id, 'system.damage.damageType': selected, 'system.group': WEAPON_GROUPS[selected] })","        messages.add('mindsmith', { selected: utils.damageLabel(selected), uuid: item.uuid, label: 'mindsmith' })","","        if (children.mental) {","            const selected = fields.mental.value","            const traits = deepClone(weapon._source.system.traits?.value ?? [])","            if (!traits.includes(selected)) traits.push(selected)","            updateItem({ _id: weapon.id, 'system.traits.value': traits })","            messages.add('mindsmith', {","                selected: utils.weaponTraitLabel(selected),","                uuid: children.mental.uuid,","                label: 'mentalforge',","            })","        }","","        if ((children.advanced || children.runic) && utils.hasFreePropertySlot(weapon)) {","            const child = children.advanced ?? children.runic","            const freeSlot = utils.getFreePropertyRuneSlot(weapon)","            const field = fields.advanced ?? fields.runic","            const selected = field.value","","            if (!weapon.system.runes.property.includes(selected)) {","                updateItem({ _id: weapon.id, [`system.${freeSlot}.value`]: selected, [`flags.world.runeSlot`]: freeSlot })","                messages.add('mindsmith', {","                    selected: utils.weaponPropertyRunesLabel(selected),","                    uuid: child.uuid,","                    label: 'runicmind',","                })","            }","        }","    },","    rest: ({ item, sourceId, updateItem }) => {","        if (sourceId !== MIND_WEAPON_UUID) return","","        let traits = item._source.system.traits?.value ?? []","        traits = traits.filter(trait => !WEAPON_TRAITS.includes(trait))","        updateItem({ _id: item.id, 'system.traits.value': traits })","","        const runeSlot = item.getFlag('world', 'runeSlot')","        if (runeSlot) {","            updateItem({ _id: item.id, [`system.${runeSlot}.value`]: null, [`flags.world.-=runeSlot`]: true })","        }","    },","}","","const OPTIONS = {","    0: 'A one-handed weapon that deals <strong>1d4</strong> damage and has the <strong>agile</strong> and <strong>finesse</strong> traits',","    1: 'A one-handed weapon that deals <strong>1d6</strong> damage and has the <strong>finesse</strong> trait',","    2: 'A one-handed weapon that deals <strong>1d8</strong> damage',","    3: 'A two-handed weapon that deals <strong>1d10</strong> damage and has the <strong>reach</strong> trait',","}","","/** * @param {DailyValueArgs<MindGenerics>} args */","async function fix({ actor }) {","    let content =","        `<p>This character doesn't have a mind weapon in their inventory.</p><p>Please select one of the following options to create one.</p>`","","    for (const [key, label] of Object.entries(OPTIONS)) {","        content += `<label><input type='radio' name='type' value='${key}'>${label}</label>`","    }","","    const weapon = await Dialog.wait(","        {","            title: 'Mind Weapon',","            content,","            buttons: {","                yes: {","                    icon: `<i class='fas fa-save'></i>`,","                    label: 'Accept',","                    callback: onWeaponSelected,","                },","                no: {","                    icon: `<i class='fas fa-times'></i>`,","                    label: 'Cancel',","                    callback: () => null,","                },","            },","            close: () => null,","        },","        {},","        { id: 'pf2e-dailies-weapon', width: 600 }","    )","","    if (weapon) {","        await actor.createEmbeddedDocuments('Item', [weapon])","        return true","    }","","    return false","}","","/** @params {JQuery} html */","async function onWeaponSelected(html) {","    const selection = html.find('[name=type]:checked').val()","    if (!selection) {","        ui.notifications.warn('You must select one weapon base type.')","        return","    }","","    const weapon = (await fromUuid(MIND_WEAPON_UUID))?.toObject()","    if (!weapon) {","        ui.notifications.warn(`The weapon couldn't be found in the compendium.`)","        return","    }","","    const stats = WEAPON_BASE_TYPES[selection]","","    setProperty(weapon, 'system.damage.die', stats.die)","    setProperty(weapon, 'system.traits.value', stats.traits.slice())","    setProperty(weapon, 'system.usage.value', stats.usage)","","    return weapon","}","","return mindSmith"].join(`
`);var Pn=["/** @typedef {'first' | 'second' | 'third' | 'fourth'} SavantRow */","/** @typedef {Record<SavantRow, { level: number; condition: boolean }>} SavantCustom */","/** @typedef {[SavantRow, SavantCustom, '']} SavantGenerics */","","const ROWS = /** @type {const} */ (['first', 'second', 'third', 'fourth'])","","/**"," * @param {CharacterPF2e} actor"," * @param {MagicTradition} tradition"," */","function getSpellcastingTraditionDetails(actor, tradition) {","    let maxSlot = 1","    let maxTradition = 0","","    for (const entry of actor.spellcasting.regular) {","        if ('pf2e-staves' in entry.flags) continue // we skip staff entries","","        const slots = entry.system.slots","        for (const key in slots) {","            const slot = slots[key]","            if (slot.max) maxSlot = Math.max(maxSlot, Number(key.slice(4)))","        }","","        if (entry.tradition === tradition) maxTradition = Math.max(maxTradition, entry.rank)","    }","","    return { maxSlot: Math.min(maxSlot, 10), maxTradition }","}","","/** @type {Daily<SavantGenerics>} */","const scrollSavant = {","    key: 'savant',","    item: {","        uuid: 'Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ', // Scroll Savant","    },","    prepare: ({ actor }) => {","        const { maxSlot, maxTradition } = getSpellcastingTraditionDetails(actor, 'arcane')","        return {","            first: { level: maxSlot - 2, condition: true },","            second: { level: maxSlot - 3, condition: true },","            third: { level: maxSlot - 4, condition: maxTradition >= 3 && maxSlot >= 5 },","            fourth: { level: maxSlot - 5, condition: maxTradition >= 4 && maxSlot >= 6 },","        }","    },","    rows: ROWS.map(rowName => {","        /** @type {DailyRowDrop<SavantGenerics>} */","        const row = {","            type: 'drop',","            slug: rowName,","            label: ({ custom }) => `PF2E.SpellLevel${custom[rowName].level}`,","            filter: {","                type: 'spell',","                search: ({ custom }) => ({","                    category: ['spell'],","                    traditions: ['arcane'],","                    level: custom[rowName].level,","                }),","            },","            condition: ({ custom }) => custom[rowName].condition,","        }","        return row","    }),","    process: async ({ utils, fields, custom, addItem, messages }) => {","        for (const field of Object.values(fields)) {","            const uuid = field.uuid","            const source = await utils.createSpellScrollSource({ uuid, level: custom[field.row].level })","            addItem(source)","            messages.add('scrolls', { uuid, label: source.name })","        }","    },","}","","return scrollSavant"].join(`
`);var Rn=["/** @typedef {typeof ROWS[number]} TomeRow */","/** @typedef {'adept' | 'second' | 'intense' | 'paragon'} TomeChild */","/** @typedef {Record<TomeRow, { rank: OneToFour; options: string[] }>} TomeCustom */","/** @typedef {[TomeRow, TomeCustom, TomeChild]} TomeGenerics */","","const ROWS = /** @type {const} */ (['first', 'second'])","","/** @param {'adept' | 'paragon'} option */","function createChildCondition(option) {","    /** @type { BaseDailyConditionFunction<TomeGenerics>} */","    const condition = ({ item, utils }) => {","        return utils.getChoiSetRuleSelection(item, option) === 'tome'","    }","    return condition","}","","/** @type {Daily<TomeGenerics>} */","const thaumaturgeTome = {","    key: 'tome',","    item: {","        uuid: 'Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e', // Tome","    },","    children: [","        {","            slug: 'adept',","            uuid: 'Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO', // Implement Adept","            condition: createChildCondition('adept'),","        },","        {","            slug: 'second',","            uuid: 'Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5', // Second Adept","            condition: createChildCondition('adept'),","        },","        {","            slug: 'intense',","            uuid: 'Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC', // Intense Implement","        },","        {","            slug: 'paragon',","            uuid: 'Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI', // Implement Paragon","            condition: createChildCondition('paragon'),","        },","    ],","    prepare: ({ utils, actor, children }) => {","        const skillNames = utils.skillNames","        const actorLevel = actor.level","        const actorSkills = /** @type {Record<SkillLongForm, { rank: ZeroToFour }>} */ (actor.skills)","","        /** @type {TomeCustom} */","        const custom = {","            first: { options: [], rank: 1 },","            second: { options: [], rank: 1 },","        }","","        // Implement Paragon","        if (children.paragon) {","            const skills = skillNames.filter(x => actorSkills[x].rank < 4)","            custom.first = { rank: 4, options: skills }","            custom.second = { rank: 4, options: skills }","        }","        // Intense Implement or Second Adept or Implement Adept","        else if (children.intense || children.adept || children.second) {","            const masters = skillNames.filter(x => actorSkills[x].rank < 3)","","            if (actorLevel >= 9) {","                custom.first = { rank: 3, options: masters }","                custom.second = { rank: 3, options: masters }","            } else {","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 2, options: experts }","                custom.second = { rank: 3, options: masters }","            }","        }","        // Tome","        else {","            if (actorLevel >= 5) {","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 2, options: experts }","                custom.second = { rank: 2, options: experts }","            } else if (actorLevel >= 3) {","                const trained = skillNames.filter(x => actorSkills[x].rank < 1)","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 1, options: trained }","                custom.second = { rank: 2, options: experts }","            } else {","                const trained = skillNames.filter(x => actorSkills[x].rank < 1)","                custom.first = { rank: 1, options: trained }","                custom.second = { rank: 1, options: trained }","            }","        }","","        return custom","    },","    rows: ROWS.map(rowName => {","        /** @type {DailyRowCombo<TomeGenerics>} */","        const row = {","            type: 'combo',","            slug: rowName,","            label: ({ custom, utils }) => utils.proficiencyLabel(custom[rowName].rank),","            options: ({ custom }) => custom[rowName].options,","            labelizer: ({ utils }) => utils.skillLabel,","        }","        return row","    }),","    process: ({ custom, fields, utils, messages, addItem, addRule }) => {","        messages.addGroup('tome', 65)","","        for (const rowName of ROWS) {","            const rank = custom[rowName].rank","            let value = fields[rowName].value","","            if (fields[rowName].input === 'true') {","                const source = utils.createLoreSource({ name: value, rank })","                addItem(source)","            } else {","                const source = utils.createSkillRuleElement({ skill: value, value: rank })","                value = utils.skillLabel(value)","                addRule(source)","            }","","            messages.add('tome', { label: utils.proficiencyLabel(rank), selected: value })","        }","    },","}","","return thaumaturgeTome"].join(`
`);var X=N("customs"),Ws=["default","trainedSkill","trainedLore","language","resistance","feat","spell"],ht=["flexibility","savant","tome","mind"],Je=class extends FormApplication{static{a(this,"DailyCustoms")}static get defaultOptions(){return mergeObject(FormApplication.defaultOptions,{id:"pf2e-dailies-customs",title:X("title"),template:me("customs"),submitOnChange:!1,submitOnClose:!1,closeOnSubmit:!1,scrollY:[".left .list"]})}async _updateObject(t,n){}async getData(t){let n=P("customDailies"),s=n.find(l=>l.key===this._selectedDaily)?.code,r=this._selectedTemplate,o=game.modules.get("pf2e-dailies-ext"),i=o?.active&&isNewerVersion(vt,o.version)?{version:vt}:"";return mergeObject(super.getData(t),{i18n:X.template,template:r,templates:Ws,daily:this._selectedDaily,code:s,customs:n,examples:ht,isExample:ht.includes(r),monaco:o?.active,newVersion:i})}activateListeners(t){super.activateListeners(t),this._monaco?.dispose();let n=game.modules.get("pf2e-dailies-ext")?.api,s=t.find(".code")[0];if(n&&s){let r=t.find(".monaco .placeholder")[0];this._monaco=n.createEditor(r,s.value),this._monaco.onDidChangeModelContent(debounce(()=>{s.value=this._monaco.getValue()},200))}else this._monaco=null;t.find("[data-action=select-template]").on("change",this.#i.bind(this)),t.find("[data-action=create-template]").on("click",this.#o.bind(this)),t.find("[data-action=create-daily]").on("click",this.#n.bind(this)),t.find(".row[data-key]").on("click",this.#r.bind(this)),t.find("[data-action=delete-daily]").on("click",this.#s.bind(this)),t.find("[data-action=save-code]").on("click",this.#e.bind(this))}get code(){return this.form.querySelector(".window-content .code")?.value}async#e(t){t.preventDefault();let n=this.code,s=this._selectedDaily;if(!s||!n)return;let r=P("customDailies"),o=r.filter(i=>i.key!==s);try{let u=(await new Le(n)()).key;if(typeof u!="string")return L("invalidKey");if(o.find(d=>d.key===u))return L("duplicate");let c=r.findIndex(d=>d.key===s);if(c<0)return;r.splice(c,1,{key:u,code:n}),await _e("customDailies",r),X.info("saved",{daily:u}),this._selectedDaily=u,this.render()}catch(i){j("error.unexpected"),console.error(i),console.error(`The error occured while testing the custom daily ${s}`)}}async#s(t){if(t.preventDefault(),t.stopPropagation(),!await Dialog.confirm({title:X("delete.title"),content:X("delete.content")}))return;let s=t.currentTarget.dataset.key,r=P("customDailies").filter(o=>o.key!==s);await _e("customDailies",r),X.info("deleted",{daily:s}),this.#n()}#n(){this._selectedDaily="",this._selectedTemplate="default",this.render()}#r(t){t.preventDefault(),this._selectedDaily=t.currentTarget.dataset.key,this.render()}async#o(t){t.preventDefault();let n=this._selectedTemplate,s=P("customDailies"),r=new FormData(this.form),o=Object.fromEntries(r),i=ht.includes(n),{key:l,uuid:u,label:c}=o;if(i)l=n;else if(!l||!u)return X.warn("template.noEmpty");if(s.find(p=>p.key===l))return L("error.duplicate");let d;if(n==="trainedSkill"){let p=ae(l,u,c);d=this.#t(p,{key:l,uuid:u,label:c},"SkillGenerics")}else if(n==="trainedLore"){let p=qe(l,u,c);d=this.#t(p,{key:l,uuid:u,label:c},"SkillGenerics")}else if(n==="language"){let p=ve(l,u,c);d=this.#t(p,{key:l,uuid:u,label:c},"LanguageGenerics")}else if(n==="resistance"){let p=bt(o.resistance),m=de(o.resistances);if(p===""||!m.length)return X.warn("template.noEmpty");if(typeof p=="number"&&p<1)return X.warn("template.badResistance");let f=Se(l,u,m,p,c);d=this.#t(f,{key:l,uuid:u,label:c,resistance:p,resistances:m},"ResistanceGenerics")}else if(n==="feat"){let p=de(o.traits),m={category:de(o.category),level:bt(o.level)||{min:0,max:20}};p.length&&(m.traits=p);let f=On(l,u,m,c);d=this.#t(f,{key:l,uuid:u,label:c},"FeatGenerics")}else if(n==="spell"){let p=Number(o.level)||void 0,m=de(o.traits),f=o.levels.split(",").map(b=>b.trim());f.length===1?f=bt(f[0]):f=f.filter(b=>b).map(b=>Number(b)).filter(b=>!Number.isNaN(b));let y={category:de(o.category),traditions:de(o.traditions),level:f||[]};m.length&&(y.traits=m);let g=ze(l,u,y,p,c);d=this.#t(g,{key:l,uuid:u,label:c,level:p},"SpellGenerics")}else if(n==="tome")d=Rn;else if(n==="flexibility")d=Fn;else if(n==="savant")d=Pn;else if(n==="mind")d=Dn;else{let p={key:l,label:c,item:{uuid:u},rows:[],process:()=>{}};d=this.#t(p,{key:l,uuid:u,label:c})}s.push({key:l,code:d}),await _e("customDailies",s),this._selectedDaily=l,this.render()}#t(t,n,s){let r="____PLACEHOLDER____",o=[],i=JSON.stringify(t,(c,d)=>typeof d=="function"?(o.push(d),r):d,4);i=i.replace(new RegExp(`"${r}"`,"g"),()=>o.shift()?.toString()?.replace(/( {5,})/g,d=>d.slice(4))??"");let l="";for(let[c,d]of Object.entries(n))typeof d=="string"?l+=`const ${c} = '${d}';
`:typeof d=="object"?l+=`const ${c} = ${JSON.stringify(d)};
`:l+=`const ${c} = ${d};
`;let u=s?`Daily<${s}>`:"Daily";return`${l}
/** @type {${u}} */
const daily = ${i};

return daily;`}#i(t){t.preventDefault(),this._selectedDaily="",this._selectedTemplate=t.currentTarget.value,this.render()}};function de(e){return e.split(",").map(t=>t.trim()).filter(t=>t)}a(de,"splitList");function bt(e){if(typeof e=="number")return e;let t=e.trim();if(t==="level"||t==="half")return t;let n=Number(t);return Number.isNaN(n)?"":n}a(bt,"simplyfiable");function Ln(e,t,n){n.restForTheNight&&Et(e,"restForTheNight",!0)}a(Ln,"preCreateChatMessage");function Mn(e,t){T(e,"restForTheNight")&&Bs(e,t)}a(Mn,"renderChatMessage");function Bs(e,t){let n=e.actor;if(!n.isOwner)return;let s=Fe(n),r=T(e,"prepared"),o=v(`message.dailiesRequest.${!s&&r===void 0?"cleaning":s?"button":"prepared"}`),i=$(`<button type="button">${o}</button>`);t.find(".message-content").append(i),s?i.on("click",()=>ue(n,e)):i.prop("disabled",!0)}a(Bs,"renderRestMessage");async function Nn(e,...t){let n=await e(...t);return await Promise.all(n.map(async s=>{let r=s.actor;r?.isOwner&&(await Hs(r),await Z(r,"rested",!0),await Z(s,"prepared",!1))})),n}a(Nn,"restForTheNightAll");async function Hs(e){let t=[],[n,s]=Xe(),r=Y();for(let o of e.items){if(T(o,"temporary")){if(t.push(o.id),o.isOfType("feat")){let c=T(o,"grantedBy");if(c){let p=`flags.pf2e.itemGrants.-=${H(o.name,{camel:"dromedary"})}`;s({_id:c,[p]:!0})}}continue}if(!r&&o.isOfType("spellcastingEntry")&&o.system.prepared.value==="charge"){t.push(o.id);continue}let i=ne(o);if(i){let c=fn(i);c?.rest&&await c.rest({item:o,sourceId:i,updateItem:s,actor:e})}let l=deepClone(o._source.system.rules),u=!1;for(let c=l.length-1;c>=0;c--)S.id in l[c]&&(l.splice(c,1),u=!0);u&&s({_id:o.id,"system.rules":l})}n.size&&await e.updateEmbeddedDocuments("Item",n.contents),t.length&&await e.deleteEmbeddedDocuments("Item",t)}a(Hs,"onRestForTheNight");Tt("pf2e-dailies");var vt="1.3.0",Vs="CONFIG.PF2E.Item.documentClasses.spellcastingEntry.prototype.cast",Ys="CONFIG.PF2E.Actor.documentClasses.character.prototype.performDailyCrafting",Ks="game.pf2e.actions.restForTheNight";Hooks.once("setup",()=>{ee({name:"customDailies",type:Array,default:[],config:!1,onChange:dt}),ee({name:"familiar",type:String,default:""}),ee({name:"staff-regex",type:String,default:We}),ee({name:"members",type:Boolean,default:!0,scope:"client"}),ee({name:"staff-sort",type:String,default:"top",choices:["top","bottom"],scope:"client"}),ee({name:"filters",type:String,default:"",scope:"client",onChange:pt}),Ot({name:"customs",type:Je}),At().api={openDailiesInterface:e=>ue(e),getBuiltinDailies:()=>deepClone(Ae),getCustomDailies:()=>deepClone(Te),getBuiltinDailyKeys:()=>[un.map(e=>`dailies.${e}`),Ae.map(e=>`dailies.${e.key}`)].flat(),getBuiltinDailyKey:e=>{let t=Ae.find(n=>n.item.uuid===e||n.children?.some(s=>s.uuid===e));if(t)return`dailies.${t.key}`},prepareDailies:He,checkCustomDaily:ft,getUtils:()=>deepClone(D),getSpellcastingEntryStaffFlags:we,getSpellcastingEntryStaffData:xe,updateEntryCharges:ke},Y()||(CONFIG.PF2E.preparationType.charge="Charge",Ne(Vs,rn,"MIXED"))});Hooks.once("ready",async()=>{if(Y()&&L("staves.conflict",!0),await pt(),!game.modules.get("lib-wrapper")?.active&&game.user.isGM){L("error.noLibwrapper",!0);return}Ne(Ys,Cn,"OVERRIDE"),Ne(Ks,Nn)});Hooks.on("renderCharacterSheetPF2e",Tn);Hooks.on("preCreateChatMessage",Ln);Hooks.on("renderChatMessage",Mn);})();
//# sourceMappingURL=main.js.map
