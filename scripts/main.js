(()=>{var _n=Object.defineProperty;var a=(e,t)=>_n(e,"name",{value:t,configurable:!0});function ne(e){return e.getFlag("core","sourceId")}a(ne,"getSourceId");function $n(e,t){let n=ne(e);return n?t.includes(n):!1}a($n,"includesSourceId");function wt(e){return Array.isArray(e)?t=>$n(t,e):t=>ne(t)===e}a(wt,"getSourceIdCondition");function kt(e,t,n){let r={};for(let s of e){let o=Array.isArray(s)?s[n??0]:typeof s=="object"&&n!=null?s[n]:s;r[o]=t(s)}return r}a(kt,"arrayToObject");function Pe(e,t){let n=[];if(e<=t)for(let r=e;r<=t;r++)n.push(r);else for(let r=e;r>=t;r--)n.push(r);return n}a(Pe,"sequenceArray");var Re=(async()=>{}).constructor;function Je(e,t){if(typeof e!="object")return!1;let n=Reflect.getPrototypeOf(e);for(;n;){if(n.constructor.name===t)return!0;n=Reflect.getPrototypeOf(n)}return!1}a(Je,"isInstanceOf");function re(e,...t){return(Array.isArray(t[0])?t[0]:t).filter(r=>typeof r=="string").join(e)}a(re,"joinStr");function Le(e){return e?e[0].toUpperCase()+e.slice(1):""}a(Le,"capitalize");function jn(...e){return`flags.${S.id}.${re(".",e)}`}a(jn,"flagPath");function T(e,...t){return e.getFlag(S.id,t.join("."))}a(T,"getFlag");function J(e,...t){let n=t.splice(-1)[0];return e.setFlag(S.id,t.join("."),n)}a(J,"setFlag");function Et(e,...t){let n=t.splice(-1)[0];return e.updateSource({[jn(...t)]:n})}a(Et,"updateSourceFlag");function It(...e){let t=typeof e.at(-1)=="object"?e.splice(-1)[0]:{},n=me(...e);return renderTemplate(n,t)}a(It,"render");function me(...e){return`modules/${S.id}/templates/${re("/",e)}.hbs`}a(me,"templatePath");function Un(e,t=[]){let n=typeof t=="string"?[t]:t;return n.length?n.flatMap(r=>e.itemTypes[r]):e.items}a(Un,"getItems");function B(e,t,n){return Un(e,n).find(wt(t))}a(B,"getItemWithSourceId");function Me(e,t,n="WRAPPER"){return libWrapper.register(S.id,e,t,n)}a(Me,"registerWrapper");function v(...e){e.unshift(S.id);let t=typeof e.at(-1)=="object"?e.splice(-1)[0]:void 0;return game.i18n[t?"format":"localize"](re(".",e),t)}a(v,"localize");function ge(...e){return game.i18n.has(`${S.id}.${e.join(".")}`,!1)}a(ge,"hasLocalization");function et(...e){return`${S.id}.${e.join(".")}`}a(et,"localizePath");function N(e){let t=a((...n)=>v(e,...n),"fn");return Object.defineProperties(t,{warn:{value:(n,r,s)=>P(`${e}.${n}`,r,s),enumerable:!1,configurable:!1},info:{value:(n,r,s)=>Ct(`${e}.${n}`,r,s),enumerable:!1,configurable:!1},error:{value:(n,r,s)=>j(`${e}.${n}`,r,s),enumerable:!1,configurable:!1},has:{value:n=>ge(e,n),enumerable:!1,configurable:!1},path:{value:n=>et(e,n),enumerable:!1,configurable:!1},template:{value:(n,{hash:r})=>t(n,r),enumerable:!1,configurable:!1},i18n:{get(){return{i18n:this.template,i18Path:this.path}},enumerable:!1,configurable:!1}}),t}a(N,"subLocalize");var tt=null,S={get id(){if(!tt)throw new Error("Module id needs to be registered.");return tt},error(e){throw new Error(`[${this.id}] ${e}`)}};function Tt(e){tt=e}a(Tt,"registerModule");function Dt(e){return game.modules.get(e??S.id)}a(Dt,"getModule");function nt(e,t,n,r){let s=typeof t=="string"?t:"info",o=typeof t=="object"?t:typeof n=="object"?n:void 0,i=typeof t=="boolean"?t:typeof n=="boolean"?n:r??!1;ui.notifications.notify(v(e,o),s,{permanent:i})}a(nt,"notify");function P(e,t,n){nt(e,"warning",t,n)}a(P,"warn");function Ct(e,t,n){nt(e,"info",t,n)}a(Ct,"info");function j(e,t,n){nt(e,"error",t,n)}a(j,"error");function ee(e){e.key??=e.name,Array.isArray(e.choices)&&(e.choices=kt(e.choices,t=>se(e.key,`choices.${t}`))),e.name??=se(e.key,"name"),e.hint??=se(e.key,"hint"),e.scope??="world",e.config??=!0,game.settings.register(S.id,e.key,e)}a(ee,"registerSetting");function Ot(e){e.key??=e.name,e.name=se("menus",e.key,"name"),e.label=se("menus",e.key,"label"),e.hint=se("menus",e.key,"hint"),e.restricted??=!0,e.icon??="fas fa-cogs",game.settings.registerMenu(S.id,e.key,e)}a(Ot,"registerSettingMenu");function se(...e){return`${S.id}.settings.${e.join(".")}`}a(se,"settingPath");function L(e){return game.settings.get(S.id,e)}a(L,"getSetting");function Ne(e,t){return game.settings.set(S.id,e,t)}a(Ne,"setSetting");var zn=function(e,t,n){if(n||arguments.length===2)for(var r=0,s=t.length,o;r<s;r++)(o||!(r in t))&&(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))};function At(e,t,n){var r=e.length-t.length,s=Array.from(t);if(r===0)return e.apply(void 0,s);if(r===1){var o=a(function(i){return e.apply(void 0,zn([i],s,!1))},"ret");return(n||e.lazy)&&(o.lazy=n||e.lazy,o.lazyArgs=t),o}throw new Error("Wrong number of arguments")}a(At,"purry");function Ft(e,t,n){for(var r=[],s=0;s<e.length;s++){var o=e[s],i=n?t(o,s,e):t(o);i.hasMany===!0?r.push.apply(r,i.next):i.hasNext&&r.push(i.next)}return r}a(Ft,"_reduceLazy");function oe(){return At(Gn,arguments,oe.lazy)}a(oe,"uniq");function Gn(e){return Ft(e,oe.lazy())}a(Gn,"_uniq");(function(e){function t(){var n=new Set;return function(r){return n.has(r)?{done:!1,hasNext:!1}:(n.add(r),{done:!1,hasNext:!0,next:r})}}a(t,"lazy"),e.lazy=t})(oe||(oe={}));function Pt(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}a(Pt,"ordinalString");function _e(e){return Error(`PF2e System | ${e}`)}a(_e,"ErrorPF2e");function Q(e,t){return game.pf2e.system.sluggify(e,t)}a(Q,"sluggify");function ie(e,t){return e.has(t)}a(ie,"setHasElement");function rt(e){return typeof e=="object"&&e!==null}a(rt,"isObject");function ye(e,{async:t=!0,label:n}={}){let r=e instanceof foundry.abstract.Document?e.link:`@UUID[${e}]`;return n&&(r=r.replace(/\{.+?\}$/,""),r=`${r}{${n}}`),TextEditor.enrichHTML(r,{async:t})}a(ye,"createFancyLink");var qn=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),Wn=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function st(e,{pwol:t,rarity:n="common"}={}){t??=game.pf2e.settings.variants.pwol.enabled;let r=Wn.get(e)??14;return $e(t?r-Math.max(e,0):r,n)}a(st,"calculateDC");function $e(e,t="common"){return Bn(e,Hn(t))}a($e,"adjustDCByRarity");function Bn(e,t="normal"){return e+(qn.get(t)??0)}a(Bn,"adjustDC");function Hn(e="common"){switch(e){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}a(Hn,"rarityToDCAdjustment");var he=new Set(["arcane","divine","occult","primal"]);var Rt=class extends FormApplication{static{a(this,"IdentifyItemPopup")}static get defaultOptions(){return{...FormApplication.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}dcs=Vn(this.object,{pwol:game.pf2e.settings.variants.pwol.enabled,notMatchingTraditionModifier:game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier")});async getData(){let t=this.object;return{...await super.getData(),isMagic:t.isMagical,isAlchemical:t.isAlchemical,dcs:this.dcs}}activateListeners(t){let n=t[0],r=n.querySelector<HTMLButtonElement>"button.update-identification";r?.addEventListener("click",()=>{this.submit({updateData:{status:r.value}})}),n.querySelector("button.post-skill-checks")?.addEventListener("click",async()=>{let s=this.object,o=s.system.identification.identified.name,i=this.dcs,l=s.isMagical?"identify-magic":s.isAlchemical?"identify-alchemy":"recall-knowledge",u=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{identifiedName:o,action:l,skills:R.omit(i,["dc"]),unidentified:s.system.identification.unidentified,uuid:s.uuid});await ChatMessage.implementation.create({user:game.user.id,content:u})})}async _updateObject(t,n){let r=n.status;if(r==="identified")return this.object.setIdentificationStatus(r)}};function Vn(e,{pwol:t=!1,notMatchingTraditionModifier:n}){let r=st(e.level,{pwol:t}),s=Yn(e),o=$e(r,s);return e.isMagical?Kn(e,o,n):{crafting:o}}a(Vn,"getItemIdentificationDCs");function Yn(e){return e.traits.has("cursed")?"unique":e.rarity}a(Yn,"getDcRarity");function Kn(e,t,n){let r={occult:t,primal:t,divine:t,arcane:t},s=Xn(e);for(let o of he)s.size>0&&!s.has(o)&&(r[o]=t+n);return{arcana:r.arcane,nature:r.primal,religion:r.divine,occultism:r.occult}}a(Kn,"getIdentifyMagicDCs");function Xn(e){let t=e.system.traits.value;return new Set(t.filter(n=>ie(he,n)))}a(Xn,"getMagicTraditions");var Lt=class extends FormApplication{static{a(this,"MoveLootPopup")}constructor(t,n,r){super(t,n),this.onSubmitCallback=r}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),quantity:{default:this.options.quantity.default,max:this.options.quantity.max},newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...FormApplication.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",quantity:{default:1,max:1},newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};function Mt(e,...t){return typeof e.name=="string"&&t.some(n=>n==="physical"?ie(PHYSICAL_ITEM_TYPES,e.type):e.type===n)}a(Mt,"itemIsOfType");var je=class e extends Array{static{a(this,"PredicatePF2e")}constructor(...t){super(...Array.isArray(t[0])?t[0]:t),this.isValid=e.isValid(this),Object.defineProperty(this,"isValid",{enumerable:!1})}static isValid(t){return Array.isArray(t)}static isArray(t){return Array.isArray(t)&&t.every(n=>H(n))}static test(t=[],n=[]){return t instanceof e?t.test(n):new e(...t).test(n)}test(t){if(this.length===0)return!0;if(!this.isValid)return console.warn("PF2e System | The provided predicate set is malformed."),!1;let n=t instanceof Set?t:new Set(t);return this.every(r=>this.#e(r,n))}toObject(){return deepClone([...this])}clone(){return new e(this.toObject())}#e(t,n){return typeof t=="string"&&n.has(t)||ot(t)&&this.#r(t,n)||Nt(t)&&this.#n(t,n)}#r(t,n){if("eq"in t)return n.has(`${t.eq[0]}:${t.eq[1]}`);let r=Object.keys(t)[0],[s,o]=Object.values(t)[0],i=Array.from(n),l=a(d=>{let p=Number(d);if(!Number.isNaN(p))return[p];let y=new RegExp(String.raw`^${d}:([^:]+)$`),f=i.map(m=>Number(y.exec(m)?.[1]||NaN)).filter(m=>!Number.isNaN(m));return f.length>0?f:[NaN]},"getValues"),u=l(s),c=l(o);switch(r){case"gt":return u.some(d=>c.every(p=>d>p));case"gte":return u.some(d=>c.every(p=>d>=p));case"lt":return u.some(d=>c.every(p=>d<p));case"lte":return u.some(d=>c.every(p=>d<=p));default:return console.warn("PF2e System | Malformed binary operation encountered"),!1}}#n(t,n){return"and"in t&&t.and.every(r=>this.#e(r,n))||"nand"in t&&!t.nand.every(r=>this.#e(r,n))||"or"in t&&t.or.some(r=>this.#e(r,n))||"xor"in t&&t.xor.filter(r=>this.#e(r,n)).length===1||"nor"in t&&!t.nor.some(r=>this.#e(r,n))||"not"in t&&!this.#e(t.not,n)||"if"in t&&!(this.#e(t.if,n)&&!this.#e(t.then,n))}};function H(e){return e instanceof Object?Nt(e)||ot(e):typeof e=="string"?Qn(e):!1}a(H,"isStatement");function Qn(e){return typeof e=="string"&&e.length>0||ot(e)}a(Qn,"isAtomic");var Zn=new Set(["eq","gt","gte","lt","lte"]);function ot(e){if(!rt(e))return!1;let t=Object.entries(e);if(t.length>1)return!1;let[n,r]=t[0];return Zn.has(n)&&Array.isArray(r)&&r.length===2&&typeof r[0]=="string"&&["string","number"].includes(typeof r[1])}a(ot,"isBinaryOp");function Nt(e){return rt(e)&&(Jn(e)||tr(e)||er(e)||nr(e)||rr(e)||sr(e)||or(e))}a(Nt,"isCompound");function Jn(e){return Object.keys(e).length===1&&Array.isArray(e.and)&&e.and.every(t=>H(t))}a(Jn,"isAnd");function er(e){return Object.keys(e).length===1&&Array.isArray(e.nand)&&e.nand.every(t=>H(t))}a(er,"isNand");function tr(e){return Object.keys(e).length===1&&Array.isArray(e.or)&&e.or.every(t=>H(t))}a(tr,"isOr");function nr(e){return Object.keys(e).length===1&&Array.isArray(e.xor)&&e.xor.every(t=>H(t))}a(nr,"isXor");function rr(e){return Object.keys(e).length===1&&Array.isArray(e.nor)&&e.nor.every(t=>H(t))}a(rr,"isNor");function sr(e){return Object.keys(e).length===1&&!!e.not&&H(e.not)}a(sr,"isNot");function or(e){return Object.keys(e).length===2&&H(e.if)&&H(e.then)}a(or,"isIf");var ar="tLa4bewBhyqzi6Ow",lr={1:"RjuupS9xyXDLgyIr",2:"Y7UD64foDbDMV9sx",3:"ZmefGBXGJF3CFDbn",4:"QSQZJ5BC3DeHv153",5:"tjLvRWklAylFhBHQ",6:"4sGIy77COooxhQuC",7:"fomEZZ4MxVVK3uVu",8:"iPki3yuoucnj7bIt",9:"cFHomF3tty8Wi1e5",10:"o1XIHJ4MJyroAHfF"};var cr={cantripDeck5:"PF2E.Item.Physical.FromSpell.CantripDeck5",scroll:"PF2E.Item.Physical.FromSpell.Scroll",wand:"PF2E.Item.Physical.FromSpell.Wand"},ur={1:"UJWiN0K3jqVjxvKk",2:"vJZ49cgi8szuQXAD",3:"wrDmWkGxmwzYtfiA",4:"Sn7v9SsbEDMUIwrO",5:"5BF7zMnrPYzyigCs",6:"kiXh4SUWKr166ZeM",7:"nmXPj9zuMRQBNT60",8:"Qs8RgNH6thRPv2jt",9:"Fgv722039TVM5JTc"};async function _t(e,{type:t,heightenedLevel:n=e.baseRank,mystified:r=!1,temp:s=!1,itemImg:o,itemName:i=t}){let l=game.packs.find(f=>f.collection==="pf2e.equipment-srd"),u=dr(t,n),c=await l?.getDocument(u??"");if(!Je(c,"ConsumablePF2e"))throw _e("Failed to retrieve consumable item");let d={...c.toObject(),_id:null},{traits:p}=d.system;p.value=oe([...p.value,...e.traits]),p.rarity=e.rarity,p.value.includes("magical")&&p.value.some(f=>ie(he,f))&&p.value.splice(p.value.indexOf("magical"),1),p.value.sort(),d.name=pr(i,e.name,n);let y=d.system.description.value;return d.system.description.value=(()=>{let f=document.createElement("p");f.append(e.sourceId?`@UUID[${e.sourceId}]{${e.name}}`:e.description);let m=document.createElement("div"),g=document.createElement("hr");return m.append(f,g),g.insertAdjacentHTML("afterend",y),m.innerHTML})(),t!=="cantripDeck5"&&(d.system.spell=e.clone({_id:randomID(),"system.location.heightenedLevel":n},{keepId:!0}).toObject()),r&&(d.system.identification.status="unidentified"),typeof o=="string"&&(d.img=o),s&&(d.system.temporary=!0),d}a(_t,"createConsumableFromSpell");function dr(e,t){switch(e){case"cantripDeck5":return ar;case"scroll":return lr[t]??null;default:return ur[t]??null}}a(dr,"getIdForSpellConsumable");function pr(e,t,n){let r=cr[e]||`${e} of {name} (Level {level})`;return game.i18n.format(r,{name:t,level:n})}a(pr,"getNameForSpellConsumable");function Ue(e,t,n,r,s){return{key:e,label:s,item:{uuid:t},rows:[{type:"drop",slug:"spell",filter:{type:"spell",search:n??{}}}],process:async({addSpell:i,utils:l,fields:u,messages:c})=>{let d=u.spell.uuid,p=await l.createSpellSource(d),y=r??p.system.level.value,f=`${p.name} (Level ${y})`;i(p,r),c.add("spells",{uuid:d,label:f})}}}a(Ue,"createSpellDaily");function $t(){let e=Ue("ace","Compendium.pf2e.feats-srd.Item.POrE3ZgBRdBL9MsW",{category:[],level:4},4),t=e.rows[0];return t.filter.drop=n=>{let r=n.system.time.value;return r.includes("hour")||r.includes("min")&&parseInt(r)>10?{error:et("interface.error.drop.wrongSpellTime"),data:{time:"10 min"}}:!0},e}a($t,"tricksterAce");var Ut={key:"blade",item:{uuid:"Compendium.pf2e.classfeatures.Item.EtltLdiy9kNfHU0c"},children:[{slug:"good",uuid:"Compendium.pf2e.classfeatures.Item.nxZYP3KGfTSkaW6J"},{slug:"evil",uuid:"Compendium.pf2e.classfeatures.Item.JiY2ZB4FkK8RJm4T"},{slug:"liberator",uuid:"Compendium.pf2e.classfeatures.Item.FCoMFUsth4xB4veC"},{slug:"paladin",uuid:"Compendium.pf2e.classfeatures.Item.peEXunfbSD8WcMFk"},{slug:"antipaladin",uuid:"Compendium.pf2e.classfeatures.Item.EQ6DVIQHAUXUhY6Y"},{slug:"tyrant",uuid:"Compendium.pf2e.classfeatures.Item.HiIvez0TqESbleB5"},{slug:"spirit",uuid:"Compendium.pf2e.feats-srd.Item.h5ksUZlrVGBjq6p4"},{slug:"master",uuid:"Compendium.pf2e.feats-srd.Item.jYEMVfrXJLpXS6aC"}],rows:[{type:"select",slug:"weapon",label:()=>v("label.blade.weapon"),options:({actor:e})=>e.itemTypes.weapon.filter(t=>!t.isAlchemical).map(t=>({value:t.id,label:t.name}))},{type:"select",slug:"rune",label:()=>v("label.blade.rune"),options:({children:e})=>{let t=["returning","shifting"],{antipaladin:n,evil:r,good:s,liberator:o,master:i,paladin:l,spirit:u,tyrant:c}=e;return u&&(t.push("flaming"),s&&t.push("holy"),r&&t.push("unholy"),(o||n)&&t.push("anarchic"),(l||c)&&t.push("axiomatic")),s&&t.push("disrupting","ghost-touch"),i&&t.push("greater-disrupting","keen"),r&&t.push("fearsome"),t.map(d=>({value:d,label:jt(d)}))},condition:({actor:e})=>e.itemTypes.weapon.filter(t=>!t.isAlchemical).length}],process:async({actor:e,fields:t,addRule:n,messages:r})=>{let s=t.weapon.value,o=t.rune.value,i=e.items.get(s);if(!i)return;n({definition:[`item:id:${s}`],key:"AdjustStrike",mode:"add",property:"property-runes",value:o},i),n({key:"CriticalSpecialization",predicate:[{or:[`item:category:${i.category}`,`item:id:${s}`]}]},i);let l=i.name!==i._source.name?`... ${i._source.name}`:i.name;r.addGroup("blade"),r.add("blade",{uuid:i.uuid,label:l,selected:jt(o)})}};function jt(e){let t=e.replace(/-\w/,n=>n[1].toUpperCase());return game.i18n.localize(`PF2E.WeaponPropertyRune.${t}.Name`)}a(jt,"localizeRune");var fr="systems/pf2e/icons/equipment/weapons/wish-knife.webp",zt={key:"ceremonial",item:{uuid:"Compendium.pf2e.feats-srd.Item.78pkCdFaY8hI07Lj",condition:({actor:e})=>e.itemTypes.weapon.some(t=>t.group==="knife")},rows:[{type:"drop",slug:"spell",label:({utils:e,actor:t})=>e.spellRankLabel(it(t)),filter:{type:"spell",search:({actor:e})=>({category:["spell"],level:it(e)})}}],process:async({actor:e,fields:t,utils:n,item:r,addItem:s,messages:o})=>{let i=t.spell.uuid,l=it(e),u=await n.createWandSource({uuid:i,level:l,itemName:r.name,itemImg:fr});s(u),o.addGroup("ceremonial"),o.add("ceremonial",{uuid:i,label:u.name})}};function it(e){return Math.ceil((e.level-5)/2)}a(it,"calculateRank");var mr=["first","second","third","fourth","fifth","sixth","seventh"];function at(e,t,n){return{key:e,label:n,item:{uuid:t[0]},children:[{slug:"expert",uuid:t[1]},{slug:"master",uuid:t[2]}],rows:[te("first",1),te("second",2,8),te("third",3,void 0,"expert"),te("fourth",4,14,"expert"),te("fifth",5,16,"expert"),te("sixth",6,void 0,"master"),te("seventh",7,20,"master")],process:async({utils:s,fields:o,addItem:i,messages:l})=>{for(let u of Object.values(o)){let c=u.uuid,d=mr.indexOf(u.row)+1,p=await s.createSpellScrollSource({uuid:c,level:d});i(p),l.add("scrolls",{uuid:c,label:p.name})}}}}a(at,"createScrollChain");function te(e,t,n,r){let s={type:"drop",slug:e,label:({utils:o})=>o.spellRankLabel(t),filter:{type:"spell",search:{category:["spell"],level:t}}};return n&&(s.condition=({actor:o})=>o.level>=n),r&&(s.childPredicate=[r]),s}a(te,"createRow");var qt={key:"flexibility",item:{uuid:"Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8"},children:[{slug:"improved",uuid:"Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX"}],rows:[Gt("flexibility",8),Gt("improved",14,"improved")],process:async({utils:e,fields:t,addFeat:n,messages:r,children:s})=>{let o=t.flexibility.uuid,i=await e.createFeatSource(o);if(n(i),r.add("feats",{uuid:o}),s.improved){let l=t.improved.uuid,u=await e.createFeatSource(l);n(u,s.improved),r.add("feats",{uuid:l})}}};function Gt(e,t,n){let r={type:"drop",label:`PF2E.Level${t}`,slug:e,filter:{type:"feat",search:{category:["class"],traits:["fighter"],level:t}}};return n&&(r.childPredicate=[n]),r}a(Gt,"createRow");function be(e,t,n){return{key:e,label:n,item:{uuid:t},rows:[{type:"select",slug:"language",options:({actor:r,utils:s})=>{let o=r.system.details.languages.value;return s.languageNames.filter(i=>!o.includes(i)).sort()},labelizer:({utils:r})=>r.languageLabel}],process:({addRule:r,utils:s,fields:o,messages:i})=>{let l=o.language.value,u=s.createLanguageRuleElement({language:l});r(u),i.add("languages",{uuid:t,selected:s.languageLabel(l),label:n})}}}a(be,"createLanguageDaily");function ae(e,t,n){return{key:e,label:n,item:{uuid:t},rows:[ze("skill",0)],process:s=>{lt(s,{uuid:t,label:n})}}}a(ae,"createTrainedSkillDaily");function lt({fields:e,addItem:t,addRule:n,utils:r,messages:s,removeRule:o},{field:i="skill",uuid:l,label:u,rank:c=1,parent:d}){o(y=>y.key==="ActiveEffectLike"&&y.mode==="upgrade"&&y.phase==="beforeDerived"&&y.path?.startsWith("system.skills."),d),o(y=>y.key==="RollOption"&&y.toggleable&&y.alwaysActive&&y.phase==="beforeDerived"&&y.suboptions.some(f=>f.label==="PF2E.SkillAcr"),d);let p=e[i].value;if(e[i].input==="true"){let y=r.createLoreSource({name:p,rank:c});t(y)}else{let y=r.createSkillRuleElement({skill:p,value:c});p=r.skillLabel(p),n(y,d)}s.add("skills",{uuid:l,selected:p,label:u})}a(lt,"processComboSkill");function ze(e,t,n={}){return{type:"combo",slug:e,options:({actor:r,utils:s})=>{let o=r.skills;return s.skillNames.filter(i=>o[i].rank===t)},labelizer:({utils:r})=>r.skillLabel,...n}}a(ze,"createComboSkillRow");function Ge(e,t,n){return{key:e,label:n,item:{uuid:t},rows:[{type:"input",slug:"skill"}],process:({addItem:s,utils:o,fields:i,messages:l})=>{let u=i.skill.value,c=o.createLoreSource({name:u,rank:1});s(c),l.add("skills",{uuid:t,selected:u,label:n})}}}a(Ge,"createTrainedLoreDaily");var Wt={key:"longevities",item:{uuid:"Compendium.pf2e.feats-srd.Item.WoLh16gyDp8y9WOZ"},children:[{slug:"expert",uuid:"Compendium.pf2e.feats-srd.Item.vfuHVSuExvtyajkW"}],rows:[ze("ancestral",0,{label:({item:e})=>e.name}),ze("expert",1,{label:({children:e})=>e.expert?.name,childPredicate:["expert"]})],process:async e=>{let t=[{field:"ancestral",rank:1,item:e.item},{field:"expert",rank:2,item:e.children.expert}];for(let{field:n,rank:r,item:s}of t)e.fields[n]&&lt(e,{label:s.name,uuid:s.uuid,field:n,rank:r,parent:s})}};var ct="Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P",Bt="Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky",gr={0:{die:"d4",traits:["finesse","agile"],usage:"held-in-one-hand"},1:{die:"d6",traits:["finesse"],usage:"held-in-one-hand"},2:{die:"d8",traits:[],usage:"held-in-one-hand"},3:{die:"d10",traits:["reach"],usage:"held-in-two-hands"}},Vt={slashing:"sword",piercing:"spear",bludgeoning:"club"},Ht=["grapple","nonlethal","shove","trip","modular"],yr=Object.keys(Vt),hr=["corrosive","disrupting","flaming","frost","shock","thundering"],br=["greaterCorrosive","greaterDisrupting","greaterFlaming","greaterFrost","greaterShock","greaterThundering","holy","unholy"],Yt={key:"mindsmith",item:{uuid:"Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY"},children:[{slug:"weapon",uuid:ct},{slug:"mental",uuid:Bt},{slug:"runic",uuid:"Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp"},{slug:"advanced",uuid:"Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD"}],rows:[{type:"alert",slug:"alert",message:()=>v("interface.alert.weapon"),fix:vr,childPredicate:[{not:"weapon"}]},{type:"select",slug:"smith",label:()=>v("label.mindsmith"),options:yr,labelizer:({utils:e})=>e.damageLabel,childPredicate:["weapon"]},...[1,2].map(e=>({type:"select",slug:`mental${e}`,label:()=>v("label.mentalforge",{nb:e}),options:Ht,labelizer:({utils:t})=>t.weaponTraitLabel,unique:"mental",childPredicate:["weapon","mental"]})),{type:"select",slug:"runic",label:()=>v("label.runicmind"),options:hr,labelizer:({utils:e})=>e.weaponPropertyRunesLabel,childPredicate:["weapon","runic",{not:"advanced"}],condition:({children:e,utils:t})=>t.hasFreePropertySlot(e.weapon)},{type:"select",slug:"advanced",label:()=>v("label.runicmind"),options:br,labelizer:({utils:e})=>e.weaponPropertyRunesLabel,childPredicate:["weapon","advanced"],condition:({children:e,utils:t})=>t.hasFreePropertySlot(e.weapon)}],process:({children:e,updateItem:t,fields:n,messages:r,item:s,utils:o})=>{let i=e.weapon;if(!i)return;r.addGroup("mindsmith");let l=n.smith.value;if(t({_id:i.id,"system.damage.damageType":l,"system.group":Vt[l]}),r.add("mindsmith",{selected:o.damageLabel(l),uuid:s.uuid,label:"mindsmith"}),e.mental){let u=deepClone(i._source.system.traits?.value??[]);for(let c of[1,2]){let d=n[`mental${c}`].value;u.includes(d)||u.push(d),t({_id:i.id,"system.traits.value":u}),r.add("mindsmith",{selected:o.weaponTraitLabel(d),uuid:e.mental.uuid,label:v("label.mentalforge",{nb:c})})}}if((e.advanced||e.runic)&&o.hasFreePropertySlot(i)){let u=e.advanced??e.runic,c=o.getFreePropertyRuneSlot(i),p=(n.advanced??n.runic).value;c&&!i.system.runes.property.includes(p)&&(t({_id:i.id,[`system.${c}.value`]:p,[`flags.${S.id}.runeSlot`]:c}),r.add("mindsmith",{selected:o.weaponPropertyRunesLabel(p),uuid:u.uuid,label:"runicmind"}))}},rest:({item:e,sourceId:t,updateItem:n,actor:r})=>{if(t!==ct)return;if(B(r,Bt)){let i=e._source.system.traits?.value??[];i=i.filter(l=>!Ht.includes(l)),n({_id:e.id,"system.traits.value":i})}let o=T(e,"runeSlot");o&&n({_id:e.id,[`system.${o}.value`]:null,[`flags.${S.id}.-=runeSlot`]:!0})}};async function vr({actor:e}){let t=N("dialog.weapon"),n=t("flavor");for(let s of["0","1","2","3"]){let o=t(`option.${s}`);n+=`<label><input type="radio" name="type" value="${s}">${o}</label>`}let r=await Dialog.wait({title:t("title"),content:n,buttons:{yes:{icon:'<i class="fas fa-save"></i>',label:t("accept"),callback:Sr},no:{icon:'<i class="fas fa-times"></i>',label:t("cancel"),callback:()=>null}},close:()=>null},{},{id:"pf2e-dailies-weapon",width:600});return r?(await e.createEmbeddedDocuments("Item",[r]),!0):!1}a(vr,"fix");async function Sr(e){let t=N("dialog.weapon"),n=e.find("[name=type]:checked").val();if(!n){t.warn("error.noSelection");return}let r=(await fromUuid(ct))?.toObject();if(!r){t.warn("error.missing");return}let s=gr[n];return setProperty(r,"system.damage.die",s.die),setProperty(r,"system.traits.value",s.traits.slice()),setProperty(r,"system.usage.value",s.usage),r}a(Sr,"onWeaponSelected");var Xt="Compendium.pf2e.equipment-srd.Item.L9ZV076913otGtiB";function Kt(e){return B(e,Xt,"consumable")}a(Kt,"getRations");var Qt={key:"rations",item:{uuid:"Compendium.pf2e.equipment-srd.Item.L9ZV076913otGtiB"},rows:[{type:"select",slug:"rations",save:!1,order:200,options:({actor:e})=>{let t=Kt(e),{value:n,max:r}=t.uses,o=(t.quantity-1)*r+n,i=o<=1;return[{value:"false",label:v("interface.rations.no")},{value:"true",label:i?v("interface.rations.last"):v("interface.rations.yes",{nb:o})}]}}],process:async({fields:e,updateItem:t,messages:n,actor:r})=>{if(e.rations.value!=="true")return;let s=Kt(r);if(!s?.uses.value)return;let o=s.quantity,{value:i,max:l}=s.uses;i<=1?o<=1?s.delete():t({_id:s.id,"system.quantity":Math.max(s.quantity-1,0),"system.uses.value":l}):t({_id:s.id,"system.uses.value":Math.max(i-1,0)});let u=(o-1)*l+i,c=u<=1?await ye(Xt,{label:s.name}):await ye(s),d=u<=1?v("message.rations.last",{name:c}):u<=3?v("message.rations.almost",{name:c,nb:u-1}):v("message.rations.used",{name:c,nb:u-1});n.addRaw(d,200)}};function ve(e,t,n,r,s,o){return{key:e,label:s,item:{uuid:t},rows:[{type:o?"random":"select",slug:"resistance",options:n,labelizer:({utils:l})=>l.resistanceLabel}],process:async({utils:l,fields:u,actor:c,addRule:d,messages:p})=>{let y=o?await l.randomOption(n):u.resistance.value,f=typeof r=="number"?r:r==="half"?l.halfLevelValue(c):c.level,m=l.createResistanceRuleElement({type:y,value:f});d(m),p.add("resistances",{uuid:t,selected:l.resistanceLabel(y,f),label:s,random:o})}}}a(ve,"createResistancelDaily");var xr="Compendium.pf2e.feat-effects.Item.jO7wMhnjT7yoAtQg",Zt={key:"root",item:{uuid:"Compendium.pf2e.feats-srd.Item.22P7IFyhrF7Fbw8B"},rows:[{type:"select",slug:"target",options:({actor:e,utils:t})=>t.getPlayersActors(e).map(r=>({value:r.id,label:r.name}))}],process:({fields:e,messages:t})=>{let n=e.target.value,r=game.actors.get(n);r&&(t.addGroup("root"),t.add("root",{uuid:xr,selected:r.name}))}};var qe=["cantrips?","1st","2nd","3rd","4th","5th","6th","7th","8th","9th","10th"].join("|"),Jt="Compendium.pf2e.feats-srd.Item.NV9H39kbkbjhAK6X";function V(){return game.modules.get("pf2e-staves")?.active}a(V,"isPF2eStavesActive");function Se(e){if(!e)return;let t=T(e,"staff")??getProperty(e,"flags.pf2e-staves");if(t)return delete t.prevDescription,deepClone(t)}a(Se,"getSpellcastingEntryStaffFlags");function xe(e){let t=Se(e);if(!t)return;t.overcharge??=0,t.max=ke(e.actor)+t.overcharge;let n=(()=>{let r=e.actor;return!t.charges||t.overcharge||t.makeshift||!r?{}:r.spellcasting.filter(s=>s.isSpontaneous).reduce((s,o)=>{for(let i=1;i<=10;i++){let l=o.system.slots[`slot${i}`];l.max&&l.value&&(s[i]=!0)}return s},{})})();return t.canPayCost=r=>!!t.charges&&(r<=t.charges||n[r]),t}a(xe,"getSpellcastingEntryStaffData");async function we(e,t){let n=xe(e);if(!n)return;let r=Math.clamped(t,0,n.max);if(r!==n.charges)return n.charges=r,J(e,"staff",n)}a(we,"updateEntryCharges");function en(e){return[{type:"weapon",trait:"magical"},{type:"equipment",trait:"coda"}].flatMap(({type:t,trait:n})=>e.itemTypes[t].filter(r=>{let s=r.system.traits?.value;return s?.includes("staff")&&s.includes(n)}))}a(en,"getStaves");function ke(e){let t=0,n=Math.ceil(e.level/2),r=Ee(e);for(let o of r){let i=We(o);i>t&&(t=i)}return B(e,Jt,"feat")&&n>t&&(t=n),Math.min(n,t)}a(ke,"getMaxSlotRankForStaves");function tn(e){let t=rn(e);if(B(e,Jt,"feat")){let r=t?.mod??0,s=e.classDCs.kineticist??e.classDCs.find(i=>i.mod>=r),o=s.mod;if(o>=r)return{ability:{value:s.attribute},tradition:{value:"primal"},proficiency:{value:s.rank,slug:s.slug},mod:o}}return t}a(tn,"getBestSpellcastingEntryForStaves");function nn(e){let t={};for(let n of e.spellcasting.filter(r=>r.isPrepared)){let r=n.id,s=n.isFlexible;for(let o=1;o<=10;o++){let i=n.system.slots[`slot${o}`];if(!(i.max<1))if(s){if(i.value<1)continue;t[r]??={id:r,name:n.name,slots:[]},t[r].slots.push({rank:o,value:i.value,max:i.max})}else for(let[l,{id:u,prepared:c,expended:d}]of Object.entries(i.prepared)){if(c===!1||d)continue;let p=n.spells.get(u);t[r]??={id:r,name:n.name,spells:[]},t[r].spells.push({name:p?.name??"Empty Slot",rank:o,index:l})}}t[r]?.spells?.sort((o,i)=>o.rank-i.rank)}return Object.values(t)}a(nn,"getPreparedSpellcastingEntriesForStaves");async function sn(e,...t){let[n,{rank:r,staffChargeEntryId:s}]=t;if(n.isCantrip)return e(...t);let o=Se(this);if(!o)return e(...t);let i=this.actor;if(!i.items.get(o.staveID)?.isEquipped){P("staves.noStaff");return}let u=n.computeCastRank(r);if(!r||r==="0")return n.toMessage(void 0,{data:{castRank:u}});if(o.charges<1||o.charges<u&&o.overcharge){P("staves.noCharge");return}let c=[];if(!o.overcharge){let d=i.spellcasting.filter(m=>m.isSpontaneous&&m.system.slots[`slot${u}`].value),p=d.findIndex(m=>m._id===s),y=!1,f=a(m=>m.system.slots[`slot${u}`].value,"entryRankValue");if(d.length===1){let m=d[0],g=v("staves.spontaneous.one",{rank:F.spellRankLabel(u),entry:m.name,remaining:f(m)});y=p>=0?!0:await Dialog.confirm({title:v("staves.spontaneous.title"),defaultYes:!1,content:`<div class="pf2e-dailies-spontaneous">${g}</div>`}),y&&(y=0)}else if(d.length>1){let m=d.map((h,x)=>({index:x,name:h.name,remaining:f(h)})),g=await It("staves-spontaneous",{entries:m,castRank:F.spellRankLabel(u),i18n:(h,{hash:x})=>v(`staves.spontaneous.${h}`,x)});y=p>=0?p:await Dialog.wait({title:v("staves.spontaneous.title"),content:g,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:game.i18n.localize("Yes"),callback:h=>{let x=h.find("input[name=entry]:checked").val();return Number(x)}},no:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("No"),callback:()=>!1}},close:()=>null})}if(y===null)return;if(console.log(y),typeof y=="number"){let m=d[y],g=m.system.slots[`slot${u}`].value;c.push({_id:m.id,[`system.slots.slot${u}.value`]:g-1}),o.charges-=1}}if(!c.length){if(o.charges<u){P("staves.noCharge");return}o.charges-=u}c.push({_id:this.id,[`flags.${S.id}.staff`]:o}),await i.updateEmbeddedDocuments("Item",c),await n.toMessage(void 0,{data:{castRank:u}})}a(sn,"onSpellcastingEntryCast");function Ee(e,{itemOnly:t,innate:n,focus:r}={}){return e.spellcasting.regular.filter(s=>!(s.flags?.["pf2e-staves"]||T(s,"staff")||!n&&s.isInnate||!r&&s.isFocusPool||s.system.prepared.value==="items"&&(!t||t==="scroll"&&s.system.prepared.validItems!=="scroll")))}a(Ee,"getValidSpellcastingList");function We(e){let t=0;if(e.system.prepared.value==="items"){let n=Math.ceil(e.actor.level/2);n>t&&(t=n)}else for(let n=0;n<=10;n++)e.system.slots[`slot${n}`].max&&(t=Math.max(t,n));return t}a(We,"getSpellcastingEntryMaxSlotRank");function rn(e){let t=Ee(e),n=0,r=[];for(let c of t){let d=c.statistic.mod;d>n?(r=[c],n=d):d===n&&r.push(c)}if(r.length===0)return;let s=a(c=>{let{ability:d,tradition:p,proficiency:y}=c.system;return{ability:d,tradition:p,proficiency:y,mod:n}},"returnedEntry");if(r.length===1)return s(r[0]);let o=e.classDC.attribute,i=r.filter(c=>c.attribute===o);if(i===1)return s(i[0]);let l=0,u;for(let c of r){let d=wr(c);d>l&&(l=d,u=c)}return s(u??r[0])}a(rn,"getBestSpellcastingEntry");function wr(e){return e.isSpontaneous?e.spells.size:e.isPrepared?Object.values(e.system.slots).flatMap(r=>Object.values(r.prepared)).filter(r=>r.id).length:0}a(wr,"getPreparedCount");function on(e){let t=0,n=0;for(let r of e.spellcasting)r.sort>n?n=r.sort:r.sort<t&&(t=r.sort);return{min:t,max:n}}a(on,"getSpellcastingEntriesSortBounds");var an={key:"savant",item:{uuid:"Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ"},prepare:({actor:e})=>{let{maxSlot:t,maxTradition:n}=kr(e,"arcane");return{first:{level:t-2,condition:!0},second:{level:t-3,condition:!0},third:{level:t-4,condition:n>=3&&t>=5},fourth:{level:t-5,condition:n>=4&&t>=6}}},rows:["first","second","third","fourth"].map(e=>({type:"drop",slug:e,label:({custom:n,utils:r})=>r.spellRankLabel(n[e].level),filter:{type:"spell",search:({custom:n})=>({category:["spell"],traditions:["arcane"],level:n[e].level})},condition:({custom:n})=>n[e].condition})),process:async({utils:e,fields:t,custom:n,addItem:r,messages:s})=>{for(let o of Object.values(t)){let i=o.uuid,l=await e.createSpellScrollSource({uuid:i,level:n[o.row].level});r(l),s.add("scrolls",{uuid:i,label:l.name})}}};function kr(e,t){let n=1,r=0,s=Ee(e);for(let o of s){let i=We(o);i>n&&(n=i),o.tradition===t&&(r=Math.max(r,o.rank))}return{maxSlot:Math.min(n,10),maxTradition:r}}a(kr,"getSpellcastingTraditionDetails");var ln={key:"metamagical",item:{uuid:"Compendium.pf2e.classfeatures.Item.89zWKD2CN7nRu2xp",condition:({actor:e})=>e.level>=4},rows:[{type:"drop",slug:"feat",filter:{type:"feat",search:{category:["class"],traits:{selected:["spellshape","wizard"],conjunction:"and"},level:"half"}}}],process:async({utils:e,fields:t,addFeat:n,messages:r})=>{let s=t.feat.uuid,o=await e.createFeatSource(s);n(o),r.add("feats",{uuid:s})}};var cn={key:"tome",item:{uuid:"Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e"},children:[{slug:"adept",uuid:"Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO",condition:ut("adept")},{slug:"second",uuid:"Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5",condition:ut("adept")},{slug:"intense",uuid:"Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC"},{slug:"paragon",uuid:"Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI",condition:ut("paragon")}],prepare:({utils:e,actor:t,children:n})=>{let r=e.skillNames,s=t.level,o=t.skills,i={first:{options:[],rank:1},second:{options:[],rank:1}};if(n.paragon){let l=r.filter(u=>o[u].rank<4);i.first={rank:4,options:l},i.second={rank:4,options:l}}else if(n.intense||n.adept||n.second){let l=r.filter(u=>o[u].rank<3);if(s>=9)i.first={rank:3,options:l},i.second={rank:3,options:l};else{let u=r.filter(c=>o[c].rank<2);i.first={rank:2,options:u},i.second={rank:3,options:l}}}else if(s>=5){let l=r.filter(u=>o[u].rank<2);i.first={rank:2,options:l},i.second={rank:2,options:l}}else if(s>=3){let l=r.filter(c=>o[c].rank<1),u=r.filter(c=>o[c].rank<2);i.first={rank:1,options:l},i.second={rank:2,options:u}}else{let l=r.filter(u=>o[u].rank<1);i.first={rank:1,options:l},i.second={rank:1,options:l}}return i},rows:["first","second"].map(e=>({type:"combo",slug:e,label:({custom:n,utils:r})=>r.proficiencyLabel(n[e].rank),options:({custom:n})=>n[e].options,labelizer:({utils:n})=>n.skillLabel})),process:({custom:e,fields:t,utils:n,messages:r,addItem:s,addRule:o})=>{r.addGroup("tome",65);for(let i of["first","second"]){let l=e[i].rank,u=t[i].value;if(t[i].input==="true"){let c=n.createLoreSource({name:u,rank:l});s(c)}else{let c=n.createSkillRuleElement({skill:u,value:l});u=n.skillLabel(u),o(c)}r.add("tome",{label:n.proficiencyLabel(l),selected:u})}}};function ut(e){return({item:t,utils:n,actor:r})=>{let s=n.getChoiSetRuleSelection(t);return r.items.get(s)?.slug==="tome"}}a(ut,"createChildCondition");var Er=["root-magic"],un=["familiar","staves"],Te=[cn,Wt,ae("ageless","Compendium.pf2e.feats-srd.Item.wylnETwIz32Au46y"),ae("memories","Compendium.pf2e.feats-srd.Item.ptEOt3lqjxUnAW62"),ae("studies","Compendium.pf2e.feats-srd.Item.9bgl6qYWKHzqWZj0"),Ge("study","Compendium.pf2e.feats-srd.Item.aLJsBBZzlUK3G8MW"),be("linguistics","Compendium.pf2e.feats-srd.Item.eCWQU16hRLfN1KaX"),be("borts","Compendium.pf2e.equipment-srd.Item.iS7hAQMAaThHYE8g"),ve("elementalist","Compendium.pf2e.feats-srd.Item.tx9pkrpmtqe4FnvS",["air","earth","fire","water"],"half","elementalist"),ve("ganzi","Compendium.pf2e.heritages.Item.3reGfXH0S82hM7Gp",["acid","electricity","sonic"],"half","ganzi",!0),ln,qt,an,at("esoterica",["Compendium.pf2e.feats-srd.Item.OqObuRB8oVSAEKFR","Compendium.pf2e.feats-srd.Item.nWd7m0yRcIEVUy7O","Compendium.pf2e.feats-srd.Item.LHjPTV5vP3MOsPPJ"]),at("trickster",["Compendium.pf2e.feats-srd.Item.ROAUR1GhC19Pjk9C","Compendium.pf2e.feats-srd.Item.UrOj9TROtn8nuxPf","Compendium.pf2e.feats-srd.Item.lIg5Gzz7W70jfbk1"]),$t(),Yt,Ut,Zt,zt,Qt],le=[],dn,Ie=new Map;function Be(e,t){let n=new Map;for(let r of e){let s=deepClone(r);try{let o=`${t}.${s.key}`;if(le.includes(o))continue;if(n.set(s.item.uuid,{daily:s,condition:s.item.condition}),s.key=o,s.children)for(let i=0;i<s.children.length;i++){let{uuid:l,condition:u}=s.children[i];n.set(l,{daily:s,index:i,condition:u})}}catch(o){j("error.unexpected"),console.error(o),console.error(`The error occured during data gathering of ${t}.${s.key}`)}}return n}a(Be,"prepareDailies");function Ir(){dn=Be(Te,"dailies")}a(Ir,"prepareBaseDailies");var Ce=[];async function dt(){Ie.clear(),Ce=[];let e=L("customDailies");for(let{key:n,code:r}of e)try{let o=await new Re(r)();if(!ft(o,!0))continue;Ce.push(o)}catch(s){j("error.unexpected"),console.error(s),console.error(`The error occured during call of custom function for ${n}`)}for(let[n,r]of dn.entries())Ie.set(n,r);let t=Be(Ce,"custom");for(let[n,r]of t.entries())Ie.set(n,r)}a(dt,"parseCustomDailies");function Cr(){let e=L("filters").trim();e||(le=[]);try{le=e.split(",").map(t=>t.trim()).filter(Boolean)}catch(t){j("error.unexpected"),console.error(t),console.error("The error occured while trying to parse the daily filters")}}a(Cr,"prepareDailyFilters");async function pt(){Cr(),Ir(),await dt()}a(pt,"prepareAllDailies");function ft(e,t=!1){return Er.includes(e.key)?(t&&game.user.isGM&&P("deprecated.custom.key",{name:e.label.trim()||e.key},!0),!1):!0}a(ft,"checkCustomDaily");function pn(e){let t={};for(let n of e.items){let r=ne(n);if(!r||n.isOfType("physical")&&n.isInvested===!1)continue;let s=Ie.get(r);if(!s)continue;let{daily:o,index:i,condition:l}=s;try{if(typeof l=="function"&&!l({actor:e,item:n,utils:F}))continue;t[o.key]??=deepClone(o),i===void 0?t[o.key].item=n:t[o.key].children[i].item=n}catch(u){j("error.unexpected"),console.error(u),console.error(`The error occured during data gathering of ${o.key}`)}}return Object.values(t).filter(n=>n.item&&n.item instanceof Item)}a(pn,"getDailies");function fn(e){return Ie.get(e)?.daily}a(fn,"getDailyFromSourceId");function He(){return game.packs.get("pf2e.familiar-abilities")}a(He,"getFamiliarPack");function mn(e){return`Compendium.pf2e.familiar-abilities.Item.${e}`}a(mn,"familiarUUID");var Tr={select:100,combo:80,random:60,alert:40,input:20,drop:0};async function yn({children:e=[],key:t,item:n,prepare:r,label:s,rows:o=[]}){let i=this.actor;this.saved[t]=T(i,t)??{},this.rows[t]={},this.children[t]=e.reduce((f,{slug:m,item:g})=>(f[m]=g,f),{});let l={actor:i,item:n,children:this.children[t],utils:F};this.custom[t]=await r?.(l)||{};let u=this.custom[t];this.dailyArgs[t]={...l,custom:u};let c=this.dailyArgs[t],d=await mt(s,c),p=d?`label.${d}`:t.startsWith("dailies.")?`label.${t.slice(8)}`:void 0;p&&ge(p)&&(d=v(p)),this.predicate[t]=e.filter(f=>f.item).map(f=>f.slug);let y={label:d?game.i18n.localize(d):n.name,rows:[]};for(let f of o){this.rows[t][f.slug]=f;let{type:m,slug:g,childPredicate:h=[],condition:x,label:I,save:b,unique:k,order:w}=f;if(h.length&&!je.test(h,this.predicate[t])||x&&!await x(c))continue;let E=b===!1||m==="random"?void 0:this.saved[t][g],C=await mt(I,c),G=E===void 0?"":typeof E!="object"?E:"name"in E?E.name:E.selected,O={label:C?game.i18n.localize(C):"",value:G,order:w??Tr[m],data:{type:m,daily:t,row:g,...k?{unique:k}:""}};if(gn(f)||Dr(f)||Or(f)){let X=await mt(f.options,c)??[];if(m!=="combo"&&!X.length)continue;let q=typeof f.labelizer=="function"&&f.labelizer(c)||(M=>Le(M));O.options=X.map(M=>typeof M=="string"?{value:M,label:q(M)}:M),gn(f)&&(O.selected=O.value,O.data.input=E?.input??!0,!O.data.input&&X.includes(O.selected)&&(O.value=q(O.selected)))}else Ar(f)?O.data.uuid=E?.uuid??"":Fr(f)&&(O.value=typeof f.message=="function"?await f.message(c):f.message);y.rows.push(O)}return y}a(yn,"getTemplate");async function mt(e,t){return typeof e=="function"?await e(t):e}a(mt,"getProcessedValue");function gn(e){return e.type==="combo"}a(gn,"isComboRow");function Dr(e){return e.type==="select"}a(Dr,"isSelectRow");function Or(e){return e.type==="random"}a(Or,"isRandomRow");function Ar(e){return e.type==="drop"}a(Ar,"isDropRow");function Fr(e){return e.type==="alert"}a(Fr,"isAlerRow");function Ve(e,t,n){if(t===void 0)return n;if(typeof t=="number")return t;if(t==="level")return e.level;if(t==="half")return Math.max(1,Math.floor(e.level/2));let r=Number(t);return Number.isNaN(r)?n:r}a(Ve,"getSimplifiableValue");async function hn(e){return{type:e.type,search:await(e.type==="feat"?Rr(this.actor,e.search):Pr(this.actor,e.search)),drop:e.drop}}a(hn,"parseFilter");function z(e,t){if(e?.length){t.selected=e,t.isExpanded=!0;for(let n of e)t.options[n].selected=!0}}a(z,"checkFilter");function bn(e,t){let n=Ye(e);n?.selected.length&&(t.conjunction=n.conjunction,t.selected=n.selected)}a(bn,"setTraits");function Ye(e){if(!e)return;let t=Array.isArray(e)?e:e.selected;if(t?.length)return{selected:t.map(n=>typeof n=="string"?{value:n}:n),conjunction:!Array.isArray(e)&&e.conjunction||"and"}}a(Ye,"getFilterTraits");async function Pr(e,t){let n=await game.pf2e.compendiumBrowser.tabs.spell.getFilterData();z(t.category,n.checkboxes.category),z(t.school,n.checkboxes.school),z(t.traditions,n.checkboxes.traditions),z(t.rarity,n.checkboxes.rarity),z(t.source,n.checkboxes.source),bn(t.traits,n.multiselects.traits);let r=gt(e,t.level);return r?.length&&z(r,n.checkboxes.rank),n}a(Pr,"parseSpellFilter");async function Rr(e,t){let n=await game.pf2e.compendiumBrowser.tabs.feat.getFilterData();z(t.category,n.checkboxes.category),z(t.skills,n.checkboxes.skills),z(t.rarity,n.checkboxes.rarity),z(t.source,n.checkboxes.source),bn(t.traits,n.multiselects.traits);let r=yt(e,t.level);return r&&(n.sliders.level.values.min=r.min,n.sliders.level.values.max=r.max,n.sliders.level.isExpanded=!0),n}a(Rr,"parseFeatFilter");function gt(e,t){if(Array.isArray(t))return t;let n=Ve(e,t);if(n)return Pe(1,n)}a(gt,"getSpellFilterLevel");function yt(e,t){if(t!==void 0)return typeof t=="object"?{min:Ve(e,t.min,0),max:Ve(e,t.min,20)}:{min:0,max:Ve(e,t,20)}}a(yt,"getFeatFilterLevel");var D=N("interface.error.drop");async function vn(e,t,n){if(!e.isOfType("feat"))return D("notFeat");let{search:r,drop:s}=n;if(r.category?.length&&!r.category.includes(e.category))return D.warn("wrongType",{types:ce("featCategories",r.category)});if(r.traits){let i=Ye(r.traits);if(i?.selected.length){let l=i.conjunction==="or"?"some":"every";if(!i.selected[l](c=>Number(c.not??!1)-Number(e.traits.has(c.value))))return D.warn("wrongTraits")}}if(r.skills?.length){let i=F.getTranslatedSkills(!0),l=e.system.prerequisites.value.map(c=>c.value.toLocaleLowerCase());if(!r.skills.some(c=>l.some(d=>d.includes(c)||d.includes(i[c]))))return D.warn("wrongSkill",{skills:ce("skillList",r.skills)})}if(r.rarity?.length&&!r.rarity.includes(e.system.traits.rarity))return D.warn("wrongRarity",{rarities:ce("rarityTraits",r.rarity)});if(r.source?.length&&!r.source.includes(Q(e.system.source.value)))return D.warn("wrongSource",{sources:r.source.join(", ")});let o=yt(this.actor,r.level);if(o){let i=e.level;if(i<o.min)return D.warn("wrongLevelLow",{level:`min: ${o.min}`});if(i>o.max)return D.warn("wrongLevelHigh",{level:`max: ${o.max}`})}if(s){let i=this.dailyArgs[t.dataset.daily];if(i){let l=await s(e,i);if(typeof l=="object")return l.data?game.i18n.format(l.error,l.data):game.i18n.localize(l.error);if(l===!1)return D.warn("wrongCustom")}}De(e,t)}a(vn,"onDropFeat");async function Sn(e,t,n){if(!e.isOfType("spell"))return D("notSpell");let{search:r,drop:s}=n;if(r.category?.length){let i=r.category.map(l=>game.i18n.localize(l==="cantrip"?"PF2E.SpellCantripLabel":CONFIG.PF2E.preparationType[l])).join(", ");if(e.isCantrip&&!r.category.includes("cantrip")||e.isFocusSpell&&!r.category.includes("focus")||e.isRitual&&!r.category.includes("ritual")||!e.isCantrip&&!e.isFocusSpell&&!e.isRitual&&!r.category.includes("spell"))return D.warn("wrongCategory",{categories:i})}if(r.traits){let i=Ye(r.traits);if(i?.selected.length){let l=i.conjunction==="or"?"some":"every";if(!i.selected[l](c=>Number(c.not??!1)-Number(e.traits.has(c.value))))return D.warn("wrongTraits")}}if(r.traditions?.length&&!r.traditions.some(i=>e.traditions.has(i)))return D.warn("wrongTradition",{traditions:ce("magicTraditions",r.traditions)});let o=gt(this.actor,r.level);if(o?.length&&!o.includes(e.level))return D.warn("wrongLevel",{levels:o.join(", ")});if(r.school?.length&&!r.school.includes(e.school))return D.warn("wrongSchool",{schools:ce("magicSchools",r.school)});if(r.rarity?.length&&!r.rarity.includes(e.system.traits.rarity))return D.warn("wrongRarity",{rarities:ce("rarityTraits",r.rarity)});if(r.source?.length&&!r.source.includes(Q(e.system.source.value)))return D.warn("wrongSource",{sources:r.source.join(", ")});if(s){let i=this.dailyArgs[t.dataset.daily];if(i){let l=await s(e,i);if(typeof l=="object")return l.data?ui.notifications.warn(game.i18n.format(l.error,l.data)):ui.notifications.warn(game.i18n.localize(l.error));if(l===!1)return D.warn("wrongCustom")}}De(e,t)}a(Sn,"onDropSpell");function ce(e,t){return t.map(r=>game.i18n.localize(CONFIG.PF2E[e][r])).join(", ")}a(ce,"localizeAll");function De(e,t){t.value=e.name,t.dataset.uuid=e.uuid,t.nextElementSibling.nextElementSibling.classList.remove("disabled")}a(De,"onDropItem");async function xn(){let e=this.actor,t=this.dailies,n=Mr.call(this),r=[],s=new Map,[o,i]=Ke(),l={},u=N("message"),c=!1,d="",p=a(g=>{let h=g.id,x=s.get(h);if(x)return x;let I=deepClone(g._source.system.rules);for(let b=I.length-1;b>=0;b--)S.id in I[b]&&I.splice(b,1);return s.set(h,I),I},"getRules"),y={languages:{order:80,messages:[]},skills:{order:70,messages:[]},resistances:{order:60,messages:[]},feats:{order:50,messages:[]},spells:{order:40,messages:[]},scrolls:{order:30,messages:[]}},f=[],m={add:(g,h)=>{y[g]??={order:0,messages:[]},y[g].messages.push(h)},addGroup:(g,h,x)=>{y[g]??={label:x,order:h??1,messages:[]}},addRaw:(g,h=1)=>{f.push({order:h,message:g})}};if(e.familiar&&n["dailies.familiar"]){let g=e.familiar,h=He(),x=[],I=g.itemTypes.action.map(b=>b.id);I.length&&g.deleteEmbeddedDocuments("Item",I),m.addGroup("familiar",20);for(let b of Object.values(n["dailies.familiar"])){let k=b.value,w=k.includes("."),E=await(w?fromUuid(k):h.getDocument(k));if(!E||!E.isOfType("action"))continue;let C=E.toObject();C&&(x.push(C),m.add("familiar",{uuid:w?k:mn(k)}))}x.length&&g.createEmbeddedDocuments("Item",x)}if(n["dailies.staff"]){let g=n["dailies.staff"],h=g.staffID.value,x=e.items.get(h),I=g.staffID.makeshift==="true",b=ke(e);if(x&&(b||I)){let k=[],w=L("staff-regex").trim()||qe,E=new RegExp(`<strong>\\s*(?<rank>(?:${w}))\\s*</strong>.+?(?<uuids>@(?:UUID|Compendium)[[a-zA-Z0-9-.]+].+?)
`,"gi"),C=E.exec(x.description);for(;C!==null;){let G=C.groups.rank.trim().replace(/\D+/,"")||"0",O=Math.clamped(parseInt(G),0,10),X=/@(?<protocole>UUID|Compendium)\[(?<uuid>[a-zA-Z0-9-.]+)\]/g,q=X.exec(C.groups.uuids);for(;q!==null;){let M=q.groups.uuid;q.groups.protocole==="Compendium"&&(M.startsWith("Compendium.")||(M=`Compendium.${M}`)),fromUuidSync(M)&&k.push({rank:O,uuid:M}),q=X.exec(C.groups.uuids)}C=E.exec(x.description)}if(k.length){let G=0,O=[],X=I?[1,2,3]:[1],q=v("interface.staves.flexible"),M=v("interface.staves.empty"),Ae={};for(let Ze of X){let Z=g[`expend${Ze}`]?.optionData;if(!Z)continue;let W=Z.entry,Fe=e.items.get(W);if(!Fe)continue;let A=Number(Z.rank),_=Fe._source.system.slots[`slot${A}`];if(Z.type==="spell"){let U=deepClone(_.prepared),pe=U[Z.index];if(_.max<1||pe.expended)return;G+=A,pe.expended=!0,i({_id:W,[`system.slots.slot${A}.prepared`]:U});let fe=e.items.get(pe.id);O.push({uuid:fe?.uuid,name:fe?.name??M,rank:A})}else{if(_.max<1||_.value<1)continue;Ae[W]??={},Ae[W][A]??=_.value;let U=Ae[W][A];if(U<1)continue;G+=A,i({_id:W,[`system.slots.slot${A}.value`]:U-1}),Ae[W][A]-=1,O.push({name:q,rank:A})}}let St=tn(e);if(St){let{ability:Ze,tradition:xt,proficiency:Z}=St,W=(()=>{let{min:A,max:_}=on(e);return L("staff-sort")==="bottom"?_+1e4:A-1e4})(),Fe={type:"spellcastingEntry",name:x.name,sort:W,system:{ability:Ze,prepared:{value:"charge"},showSlotlessLevels:{value:!1},showUnpreparedSpells:{value:!1},proficiency:Z,tradition:xt},flags:{[S.id]:{type:"staff",staff:{charges:b+G,staveID:h,overcharge:G,makeshift:I}}}};r.push(Fe),await Promise.all(k.map(async({rank:A,uuid:_})=>{let U=await F.createSpellSource(_);setProperty(U,`flags.${S.id}.entry`,{level:A,type:"staff"}),r.push(U)})),m.addGroup("staff",45,v(`staves.message.${G?"withExpend":"noExpend"}`,{makeshift:I?v("staves.makeshift"):""})),m.add("staff",{uuid:x.uuid});for(let{uuid:A,name:_,rank:U}of O){let pe=F.spellRankLabel(U),fe=`${_} (${pe})`;m.add("staff",{uuid:A,label:A?fe:`<span class="fake-link">
									<i class='fa-solid fa-sparkles'></i>
									${fe}
								</span>`})}}}}}for(let{item:g,key:h,process:x}of t){if(!n[h])continue;let I=this.dailyArgs[h];try{await x({...I,fields:n[h],messages:m,addItem:b=>r.push(b),updateItem:i,removeRule:(b,k)=>{let w=p(k??g);for(let E=w.length-1;E>=0;E--){let C=w[E];b(C)&&w.splice(E,1)}},addRule:(b,k)=>{b[S.id]=!0,p(k??g).push(b)},addFeat:(b,k)=>{let w=k??g;if(w.isOfType("feat")){let E=w.id;setProperty(b,"flags.pf2e.grantedBy",{id:E,onDelete:"cascade"}),setProperty(b,`flags.${S.id}.grantedBy`,E)}r.push(b)},addSpell:(b,k)=>{setProperty(b,`flags.${S.id}.entry`,{level:k,type:"fallback"}),r.push(b),c=!0}})}catch(b){j("error.unexpected"),console.error(b),console.error(`The error occured during processing of ${h}`)}}for(let[g,h]of Object.entries(n)){let x=this.rows[g];if(x)for(let{row:I,type:b,input:k,value:w,uuid:E}of Object.values(h)){if(b==="random"||x[I]?.save===!1)continue;l[g]??={};let C=l[g];b==="combo"?C[I]={input:k==="true",selected:w}:b==="drop"?C[I]={uuid:E,name:w}:C[I]=w}}for(let[g,h]of s)i({_id:g,"system.rules":h});if(c){let g={type:"spellcastingEntry",name:v("spellEntry.name"),system:{prepared:{value:"innate"},showSlotlessLevels:{value:!1},showUnpreparedSpells:{value:!1},proficiency:{value:1,slug:e.classDC?.slug||e.class?.slug||void 0}},flags:{[S.id]:{type:"fallback"}}};r.push(g)}for(let g of r)getProperty(g,"system.temporary")===!0||setProperty(g,`flags.${S.id}.temporary`,!0);if(r.length){let g=await e.createEmbeddedDocuments("Item",r);for(let h of g)if(h.isOfType("feat")){let x=T(h,"grantedBy");if(x){let b=`flags.pf2e.itemGrants.${Q(h.name,{camel:"dromedary"})}`;i({_id:x,[b]:{id:h.id,onDelete:"detach"}})}}else if(h.isOfType("spellcastingEntry")){let x=T(h,"type"),I=g.filter(b=>b.isOfType("spell")&&T(b,"entry")?.type===x);for(let b of I){let{level:k}=T(b,"entry"),w={_id:b.id,"system.location.value":h.id};k!==void 0&&(w["system.location.heightenedLevel"]=k),i(w)}}}await e.update({[`flags.${S.id}`]:{...expandObject(l),rested:!1}}),o.size&&await e.updateEmbeddedDocuments("Item",o.contents),f.sort((g,h)=>h.order-g.order);for(let{message:g}of f)d+=`${g}<hr />`;d+=await Lr(y,d),d=d?`${u("changes")}<hr />${d}`:u("noChanges"),ChatMessage.create({content:`<div class="pf2e-dailies-summary">${d}</div>`,speaker:ChatMessage.getSpeaker({actor:e})})}a(xn,"processData");async function Lr(e){let t=N("message"),n=Object.entries(e).map(([s,o])=>(o.label??=t.has(s)?t(s):t("gained",{type:s}),o));n.sort((s,o)=>o.order-s.order);let r="";for(let{label:s,messages:o}of n)if(o.length){r&&(r+="<hr />"),s&&(r+=`<p><strong>${s}</strong></p>`);for(let{uuid:i,selected:l,label:u,random:c}of o){let d=`label.${u}`;u=u&&ge(d)?v(d):u||"",r+="<p>",r+=i?`${await ye(i,{label:u})}`:` ${u}`,l&&(r+=`<i class="fa-solid fa-caret-right"></i>${l}`),c&&(r+='<i class="fa-solid fa-dice-d20"></i>'),r+="</p>"}}return r}a(Lr,"parseMessages");function Mr(){let e=this.element.find(".window-content .content").find("input:not(.alert), select[data-type]").toArray(),t={};for(let n of e){let r={...n.dataset,value:n.value};if(r.type==="combo"&&r.input==="false"){let s=n.previousElementSibling;r.value=s.value,r.optionData=s.selectedOptions[0].dataset}r.type==="select"&&(r.optionData=n.selectedOptions[0].dataset),t[r.daily]??={},t[r.daily][r.row]=r}return t}a(Mr,"getFields");var Y=N("interface"),Nr="Compendium.pf2e.classfeatures.Item.Klb35AwlkNrq1gpB",Xe=class extends Application{static{a(this,"DailiesInterface")}constructor(t,n,r){super(n),this._actor=t,this._dailies=[],this._dailyArgs={},this._saved={},this._children={},this._custom={},this._predicate={},this._rows={},this._message=r}static get defaultOptions(){return mergeObject(Application.defaultOptions,{id:"pf2e-dailies-interface",template:me("interface"),height:"auto",width:400,submitOnClose:!1,submitOnChange:!1,dragDrop:[{dropSelector:'[data-droppable="true"]'}]})}get actor(){return this._actor}get dailies(){return this._dailies}get dailyArgs(){return this._dailyArgs}get saved(){return this._saved}get children(){return this._children}get custom(){return this._custom}get predicate(){return this._predicate}get rows(){return this._rows}async getData(t){let n=[],r=this._actor;if(this._dailies=pn(r),r.familiar&&!le.includes("dailies.familiar")){let i="dailies.familiar",l=N("label"),u=r.attributes.familiarAbilities.value,c=He(),d=T(r,i)??{},p={label:l("familiar"),rows:[]},y=c.index.map(({_id:m,name:g})=>({value:m,label:g})),f=L("familiar").split(",");for(let m of f){m=m.trim();let g=await fromUuid(m);g?.isOfType("action")&&y.push({value:m,label:g.name})}y.sort((m,g)=>m.label.localeCompare(g.label));for(let m=0;m<u;m++)p.rows.push({label:l("ability",{nb:m+1}),value:d[`${m}`]??"",order:100,options:y,data:{type:"select",daily:i,row:m.toString(),unique:"ability"}});p.rows.length&&(this._rows[i]=p.rows.reduce((m,{data:g})=>(m[g.row]={save:!0},m),{}),n.push(p))}if(!le.includes("dailies.staves")&&!V()){let i=en(r);if(i.length&&ke(r)){let u="dailies.staff",c=T(r,u)??{},d=i.map(m=>({value:m.id,label:m.name}));d.sort((m,g)=>m.label.localeCompare(g.label));let p={label:Y("staves.staff"),value:c.staffID??"",order:100,options:d,data:{type:"select",daily:u,row:"staffID"}},y={label:Y("staves.prepare"),rows:[p]};this._rows[u]={staffID:{save:!0}};let f=nn(r);if(f.length){let m=[{value:"",label:""}],g=Y("staves.flexible"),h=Y("staves.emty");for(let b of f){let k=b.id;m.push({groupStart:!0,label:b.name});for(let w of b.spells??[]){let E=w.name??h,C=`${w.rank}.${w.index}`;m.push({value:C,label:`${E} (${F.spellRankLabel(w.rank)})`,data:{type:"spell",rank:w.rank,index:w.index,unique:C,entry:k}})}for(let w of b.slots??[]){let E=F.spellRankLabel(w.rank),C={type:"slot",rank:w.rank,entry:k};w.value>1?C.skipUnique=!0:C.unique=`${k}.${w.rank}`,m.push({value:w.rank,label:`${g} ${w.value}/${w.max} (${E})`,data:C})}m.push({groupEnd:!0})}let x=B(r,Nr,"feat"),I=x&&r.level>=8?r.level>=16?3:2:1;x&&(p.data.makeshift=!0);for(let b=1;b<=I;b++)y.rows.push({label:Y("staves.expend"),value:"",order:100,options:m,data:{type:"select",daily:u,row:`expend${b}`,unique:"expend"}}),this._rows[u][`expend${b}`]={save:!1}}n.push(y)}}for(let i of this._dailies)try{let l=await yn.call(this,i);n.push(l)}catch(l){Y.error("error.unexpected"),console.error(l),console.error(`The error occured during templating of ${i.key}`)}let s=[],o=[];for(let i of n)i.rows.length>1?o.push(i):i.rows.length&&s.push(i);return s.sort((i,l)=>l.rows[0].order-i.rows[0].order),o.sort((i,l)=>i.rows.length-l.rows.length),mergeObject(super.getData(t),{i18n:Y.template,dump:({value:i,placeholder:l,data:u})=>{let c="";if(i&&(c+=` value="${i}"`),l&&(c+=` placeholder="${l}"`),typeof u=="object")for(let[d,p]of Object.entries(u)){let y=d.replace(/[A-Z]/g,f=>`-${f}`);c+=` data-${y}="${p}"`}return c&&(c+=" "),c},rows:s,groups:o,hasDailies:s.length||o.length})}render(t,n){return this._randomInterval&&clearInterval(this._randomInterval),this.element.find("select.random")&&(this._randomInterval=setInterval(()=>{this.element.find("select.random").each((s,o)=>{o.selectedIndex=(o.selectedIndex+1)%o.options.length})},2e3)),super.render(t,n)}close(t){return this._randomInterval&&clearInterval(this._randomInterval),super.close(t)}activateListeners(t){super.activateListeners(t),t.find("[data-action=clear]").on("click",this.#u.bind(this)),t.find("[data-action=accept]").on("click",this.#c.bind(this)),t.find("[data-action=cancel]").on("click",this.#d.bind(this)),t.find(".combo select").on("change",this.#s.bind(this)),t.find(".combo input").on("change",this.#o.bind(this)),t.find("[data-action=search]").on("click",this.#r.bind(this)),t.find("[data-action=alert]").on("click",this.#e.bind(this));let n=t.find("select[data-unique]");n.on("change",r=>this.#a(r.currentTarget,!0));{let r=[];for(let s of n){let{unique:o,daily:i}=s.dataset,l=`${i}.${o}`;r.includes(l)||(r.push(l),this.#a(s,!1))}}}_canDragDrop(t){return!0}async _onDrop(t){let n=N("interface.error.drop"),r=t.target;r instanceof HTMLLabelElement&&(r=r.nextElementSibling);try{let s=t.dataTransfer?.getData("text/plain"),o=JSON.parse(s);if(!o||o.type!=="Item"||typeof o.uuid!="string")return n.warn("wrongDataType");let i=await fromUuid(o.uuid);if(!i)return n.warn("wrongDataType");let l=await this.#n(r);if(!l)return De(i,r);l.type==="feat"?vn.call(this,i,r,l):l.type==="spell"?Sn.call(this,i,r,l):De(i,r)}catch(s){n.error("error.unexpected"),console.error(s),console.error("The error occured during _onDrop")}}async#e(t){t.preventDefault(),this.#t();let n=t.currentTarget.dataset,r=this.rows[n.daily][n.row],s=this.dailyArgs[n.daily],o;try{o=await r.fix(s)}catch(i){Y.error("error.unexpected"),console.error(i),console.error(`The error occured during an alert fix of '${n.daily}'`)}this.#i(),o&&this.render()}async#r(t){t.preventDefault();let n=await this.#n(t.currentTarget,!0);n?game.pf2e.compendiumBrowser.openTab(n.type,n.search):game.pf2e.compendiumBrowser.render(!0)}async#n(t,n){let{daily:r,row:s}=t.dataset,o=this.rows[r]?.[s]?.filter,i=this.dailyArgs[r];if(!(!i||!o))return typeof o.search=="function"&&(o.search=await o.search(i)),n?hn.call(this,o):o}#s(t){let n=t.currentTarget,r=n.nextElementSibling;r.dataset.input="false",r.value=n.options[n.selectedIndex].text}#o(t){let n=t.currentTarget,r=n.previousElementSibling,s=n.value.toLowerCase(),i=Array.from(r.options).map(l=>l.value).indexOf(s);i!==-1?(r.value=s,n.value=r.options[i].text,n.dataset.input="false"):(r.value="",n.dataset.input="true")}#t(){this.element.addClass("disabled")}#i(){this.element.removeClass("disabled")}#l(){let t=[],n=this.element,r=n.find("input").filter((o,i)=>!i.value),s=n.find("input.alert");r.length&&t.push("error.empty"),s.length&&t.push("error.unattended"),n.find("label").removeClass("empty");for(let o of r){let i=o.parentElement;(i.classList.contains("combo")?i:o).previousElementSibling.classList.add("empty")}for(let o of t)Y.warn(o);return!t.length}async#c(t){t.preventDefault(),this.#l()&&(this.#t(),await xn.call(this),this._message&&J(this._message,"prepared",!0),this.close())}#u(t){t.preventDefault();let n=$(t.currentTarget),r=n.prevAll("input").first();r.val(""),r.attr("value",""),r.attr("data-uuid",""),n.addClass("disabled")}#d(t){t.preventDefault(),this.close()}#a(t,n){let r=t.dataset.unique,s=n?[t,..._r(t,`select[data-unique="${r}"]`)]:t.parentElement.querySelectorAll(`:scope > select[data-unique="${r}"]`),o=new Set;for(let i of s){let l=i.selectedIndex,u=i.options,c=a(()=>{let f=u[l];return f.dataset.skipUnique?void 0:f.dataset.unique??f.value},"optionUniqueValue"),d=a(()=>{let f=c();return f&&o.has(f)},"optionExists");for(;d()&&l>0;)l-=1;let p=i.options.length-1;for(;d()&&l<p;)l+=1;if(d())continue;let y=c();y&&o.add(y),i.selectedIndex!==l&&(i.selectedIndex=l)}for(let i of s){let l=i.selectedIndex,u=i.options;for(let c=0;c<u.length;c++){if(c===l)continue;let d=u[c];d.disabled=o.has(d.dataset.unique??d.value)}}}};function _r(e,t){let n=[],r=e.parentElement;if(!r)return n;let s=t?r.querySelectorAll(`:scope > ${t}`):r.children;for(let o of s)o!==e&&n.push(o);return n}a(_r,"getSiblings");var wn="max(1,floor(@actor.level/2))",$r=["propertyRune1","propertyRune2","propertyRune3","propertyRune4"],kn,En,F={get skillNames(){return kn??=Object.keys(CONFIG.PF2E.skillList).filter(e=>e!=="lore"),kn.slice()},skillLabel:e=>game.i18n.localize(CONFIG.PF2E.skillList[e]),createSkillRuleElement:({skill:e,value:t,mode:n="upgrade",predicate:r})=>{let s={key:"ActiveEffectLike",mode:n,path:`system.skills.${e}.rank`,value:t};return r?.length&&(s.predicate=r),s},createLoreSource:({name:e,rank:t})=>({type:"lore",img:"systems/pf2e/icons/default-icons/lore.svg",name:e,system:{proficient:{value:t}}}),getTranslatedSkills:(e=!1)=>Object.entries(CONFIG.PF2E.skillList).reduce((t,[n,r])=>{let s=game.i18n.localize(r);return t[n]=e?s.toLocaleLowerCase(game.i18n.lang):s,t},{}),get languageNames(){return En??=Object.keys(CONFIG.PF2E.languages),En.slice()},languageLabel:e=>game.i18n.localize(CONFIG.PF2E.languages[e]),createLanguageRuleElement:({language:e,mode:t="add",predicate:n})=>{let r={key:"ActiveEffectLike",mode:t,path:"system.build.languages.granted",value:{slug:e,source:"{item|name}"}};return n?.length&&(r.predicate=n),r},resistanceLabel:(e,t)=>{let n=game.i18n.localize(`PF2E.Trait${Le(e)}`);return t&&(n+=` ${t}`),n},createResistanceRuleElement:({type:e,value:t,predicate:n})=>{t==="half"&&(t=wn);let r={key:"Resistance",type:e,value:t};return n?.length&&(r.predicate=n),r},createFeatSource:async e=>{let t=(await fromUuid(e))?.toObject();if(!t)throw new Error(`An error occured while trying to create a feat source with uuid: ${e}`);return t},createSpellScrollSource:async e=>In("scroll",e),createWandSource:async e=>In("wand",e),createSpellSource:async e=>{let t=(await fromUuid(e))?.toObject();if(!t)throw new Error(`An error occured while trying to create a spell source with uuid: ${e}`);return t},spellRankLabel:e=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:Pt(e)}),get halfLevelString(){return wn},getChoiSetRuleSelection:(e,t)=>e._source.system.rules.find(s=>s.key==="ChoiceSet"&&(!t||s.rollOption===t))?.selection,proficiencyLabel:e=>game.i18n.localize(CONFIG.PF2E.proficiencyLevels[e]),randomOption:async e=>{let t=(await new Roll(`1d${e.length}`).evaluate({async:!0})).total,n=e[t-1];return typeof n=="string"?n:n.value},halfLevelValue:e=>Math.max(1,Math.floor(e.level/2)),sequenceArray:Pe,damageLabel:e=>game.i18n.localize(CONFIG.PF2E.damageTypes[e]),weaponTraitLabel:e=>game.i18n.localize(CONFIG.PF2E.weaponTraits[e]),weaponPropertyRunesLabel:e=>{let t=`PF2E.WeaponPropertyRune.${e}.Name`;return game.i18n.localize(t)},hasFreePropertySlot:e=>{let t=e.system.runes.potency;return t>0&&e.system.runes.property.length<t},getFreePropertyRuneSlot:e=>{let t=e.system.potencyRune.value;if(t===null)return null;for(let n=0;n<t;n++){let r=$r[n];if(!e.system[r].value)return r}return null},getPlayersActors:(e,...t)=>{let n=t.length?t:["creature"],r=e instanceof Actor,s=game.actors;return r&&e.parties.size&&L("members")?(s=Array.from(e.parties??[]).flatMap(o=>o.members),s=Array.from(new Set(s))):s=s.filter(o=>o.hasPlayerOwner),s.filter(o=>o.isOfType(...n)&&(!r||o!==e))}};async function In(e,{uuid:t,level:n,itemName:r,itemImg:s}){let o=await fromUuid(t);if(!o)throw new Error(`An error occured while trying to create a spell scroll source with uuid: ${t}`);return _t(o,{type:e,heightenedLevel:n,temp:!0,itemName:r,itemImg:s})}a(In,"createSpellConsumableSource");function ue(e,t){let n=e;if((!n||!n.isOfType("character")||!n.isOwner)&&(n=canvas.tokens.controlled.find(s=>s.actor?.isOfType("character")&&s.actor.isOwner)?.actor,n||(n=game.user.character)),!n||!n.isOfType("character")||!n.isOwner)return warn("error.noCharacterSelected");if(!Oe(n))return warn("error.unrested");new Xe(n,{title:v("interface.title",{name:n.name})},t).render(!0)}a(ue,"openDailiesInterface");function Ke(){let e=new Collection;return[e,t=>{let n=t._id;if(!n)return;let r=e.get(n)??{};e.set(n,mergeObject(r,t))}]}a(Ke,"createUpdateCollection");async function Cn(){let e=(await this.getCraftingEntries()).filter(o=>o.isDailyPrep),n=e.filter(o=>o.isAlchemical).reduce((o,i)=>o+i.reagentCost,0),r=(this.system.resources.crafting.infusedReagents.value||0)-n;if(r<0){ui.notifications.warn(game.i18n.localize("PF2E.CraftingTab.Alerts.MissingReagents"));return}await this.update({"system.resources.crafting.infusedReagents.value":r});let s=n===0?"ZeroConsumed":n===1?"OneConsumed":"NConsumed";ui.notifications.info(game.i18n.format(`PF2E.Actor.Character.Crafting.Daily.Complete.${s}`,{quantity:n}));for(let o of e)for(let i of o.preparedCraftingFormulas){let l=i.item.toObject();l.system.quantity=i.quantity,l.system.temporary=!0,l.system.size=this.ancestry?.size==="tiny"?"tiny":"med",o.isAlchemical&&Mt(l,"consumable","equipment","weapon")&&l.system.traits.value.push("infused"),await this.addToInventory(l)}}a(Cn,"performDailyCrafting");function Tn(e,t){let n=e.actor;if(!n.isOwner)return;let r=Oe(n),s=r?"":" disabled",o=v(r?"sheet.title":"sheet.unrested"),i=`<a class="roll-icon dailies${s}" data-tooltip="${o}">
	<i class="fas fa-mug-saucer"></i>
</a>`,l=t.find("aside .sidebar .hitpoints .hp-small");l.append(i),r&&l.find(".dailies").on("click",()=>ue(n)),V()||jr(t,n)}a(Tn,"renderCharacterSheetPF2e");function jr(e,t){let r=e.find(".sheet-body .sheet-content [data-tab=spellcasting] [data-tab=known-spells] .spellcastingEntry-list").find("[data-container-type=spellcastingEntry]");for(let s of r){let o=s.dataset.containerId,i=t.spellcasting.get(o),l=xe(i);if(!l)continue;let u=v("staves.label"),c=$(`<div class="pf2e-dailies-charges"><label>${u}</label></div>`),d=$(`<input type="number" min="0" max="${l.max}" value="${l.charges}">`);d.on("change",f=>zr(f,t));let p=$('<a><i class="fas fa-redo"></i></a>');p.on("click",f=>Ur(f,t)),c.append(d),c.append(p),s.querySelector(".spell-ability-data .statistic-values").after(c[0]);let y=s.querySelectorAll('.spell-list .spell:not([data-group-id="cantrips"]');for(let f of y){let m=f.dataset.castRank;l.canPayCost(m)||(f.dataset.slotExpended="")}}}a(jr,"renderStavesEntries");function Dn(e,t){let{itemId:n}=e.currentTarget.closest(".spellcasting-entry").dataset;return t.spellcasting.get(n)}a(Dn,"getEntryDataFromEvent");async function Ur(e,t){let n=Dn(e,t);we(n,9999)}a(Ur,"onStaffChargesReset");async function zr(e,t){let n=Dn(e,t);we(n,e.currentTarget.valueAsNumber)}a(zr,"onStaffChargesChange");function Oe(e){return T(e,"rested")!==!1}a(Oe,"canPrepDailies");function On(e,t,n,r){return{key:e,label:r,item:{uuid:t},rows:[{type:"drop",slug:"feat",filter:{type:"feat",search:n??{}}}],process:async({utils:o,fields:i,addFeat:l,messages:u})=>{let c=i.feat.uuid,d=await o.createFeatSource(c);l(d),u.add("feats",{uuid:c})}}}a(On,"createFeatDaily");var An=["/** @typedef {'flexibility' | 'improved'} FlexibilityRow */","/** @typedef {'improved'} FlexibilityChild */","/** @typedef {[FlexibilityRow, {}, FlexibilityChild]} FlexibilityGenerics */","","/**"," * @param {FlexibilityRow} slug"," * @param {number} level"," * @param {FlexibilityChild} [child]"," */","function createRow(slug, level, child) {","    /** @type {DailyRowDrop<FlexibilityGenerics>} */","    const row = {","        type: 'drop',","        label: `PF2E.Level${level}`,","        slug,","        filter: {","            type: 'feat',","            search: {","                category: ['class'],","                traits: {","                    values: ['fighter'],","                },","                level,","            },","        },","    }","    if (child) row.childPredicate = [child]","    return row","}","","/** @type {Daily<FlexibilityGenerics>} */","const combatFlexibility = {","    key: 'flexibility',","    item: {","        uuid: 'Compendium.pf2e.classfeatures.Item.8g6HzARbhfcgilP8', // Combat Flexibility","    },","    children: [","        {","            slug: 'improved',","            uuid: 'Compendium.pf2e.classfeatures.Item.W2rwudMNcAxs8VoX', // Improved Flexibility","        },","    ],","    rows: [","        createRow('flexibility', 8), //","        createRow('improved', 14, 'improved'),","    ],","    process: async ({ utils, fields, addFeat, messages, children }) => {","        const uuid = fields.flexibility.uuid","        const source = await utils.createFeatSource(uuid)","        addFeat(source)","        messages.add('feats', { uuid })","","        if (children.improved) {","            const uuid = fields.improved.uuid","            const source = await utils.createFeatSource(uuid)","            addFeat(source, children.improved)","            messages.add('feats', { uuid })","        }","    },","}","","return combatFlexibility"].join(`
`);var Fn=["/** @typedef {'alert' | 'smith' | 'mental' | 'runic' | 'advanced'} MindRow */","/** @typedef {'weapon' | 'mental' | 'runic' | 'advanced'} MindChild */","/** @typedef {[MindRow, {}, MindChild]} MindGenerics */","","const MIND_WEAPON_UUID = 'Compendium.pf2e-dailies.equipment.Item.VpmEozw21aRxX15P'","","const WEAPON_BASE_TYPES = {","    0: { die: 'd4', traits: ['finesse', 'agile'], usage: 'held-in-one-hand' },","    1: { die: 'd6', traits: ['finesse'], usage: 'held-in-one-hand' },","    2: { die: 'd8', traits: [], usage: 'held-in-one-hand' },","    3: { die: 'd10', traits: ['reach'], usage: 'held-in-two-hands' },","}","","const WEAPON_GROUPS = /** @type {Record<WeaponDamage, string>} */ {","    slashing: 'sword',","    piercing: 'spear',","    bludgeoning: 'club',","}","","const WEAPON_TRAITS = ['grapple', 'nonlethal', 'shove', 'trip', 'modular']","","const WEAPON_DAMAGE_TYPES = Object.keys(WEAPON_GROUPS)","","const WEAPON_RUNES = ['corrosive', 'disrupting', 'flaming', 'frost', 'shock', 'thundering']","","const WEAPON_GREATER_RUNES = [","    'anarchic',","    'axiomatic',","    'greaterCorrosive',","    'greaterDisrupting',","    'greaterFlaming',","    'greaterFrost',","    'greaterShock',","    'greaterThundering',","    'holy',","    'unholy',","]","","/** @type {Daily<MindGenerics>} */","const mindSmith = {","    key: 'mindsmith',","    item: {","        uuid: 'Compendium.pf2e.feats-srd.Item.juikoiIA0Jy8PboY', // Mind Smith Dedication","    },","    children: [","        {","            slug: 'weapon',","            uuid: MIND_WEAPON_UUID, // Mind Weapon","        },","        {","            slug: 'mental',","            uuid: 'Compendium.pf2e.feats-srd.Item.PccekOihIbRWdDky', // Malleable Mental Forge","        },","        {","            slug: 'runic',","            uuid: 'Compendium.pf2e.feats-srd.Item.2uQbQgz1AbjzcFSp', // Runic Mind Smithing","        },","        {","            slug: 'advanced',","            uuid: 'Compendium.pf2e.feats-srd.Item.fgnfXwFcn9jZlXGD', // Advanced Runic Mind Smithing","        },","    ],","    rows: [","        {","            type: 'alert',","            slug: 'alert',","            message: 'Missing Mind Weapon',","            fix,","            childPredicate: [{ not: 'weapon' }],","        },","        {","            type: 'select',","            slug: 'smith',","            label: 'Mind Smith',","            options: WEAPON_DAMAGE_TYPES,","            labelizer: ({ utils }) => utils.damageLabel,","            childPredicate: ['weapon'],","        },","        {","            type: 'select',","            slug: 'mental',","            label: 'Mental Forge',","            options: WEAPON_TRAITS,","            labelizer: ({ utils }) => utils.weaponTraitLabel,","            childPredicate: ['weapon', 'mental'],","        },","        {","            type: 'select',","            slug: 'runic',","            label: 'Runic Smithing',","            options: WEAPON_RUNES,","            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,","            childPredicate: ['weapon', 'runic', { not: 'advanced' }],","            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),","        },","        {","            type: 'select',","            slug: 'advanced',","            label: 'Runic Smithing',","            options: WEAPON_GREATER_RUNES,","            labelizer: ({ utils }) => utils.weaponPropertyRunesLabel,","            childPredicate: ['weapon', 'advanced'],","            condition: ({ children, utils }) => utils.hasFreePropertySlot(children.weapon),","        },","    ],","    process: ({ children, updateItem, fields, messages, item, utils }) => {","        const weapon = children.weapon","        if (!weapon) return","","        messages.addGroup('mindsmith')","","        const selected = /** @type {WeaponDamage} */ fields.smith.value","        updateItem({ _id: weapon.id, 'system.damage.damageType': selected, 'system.group': WEAPON_GROUPS[selected] })","        messages.add('mindsmith', { selected: utils.damageLabel(selected), uuid: item.uuid, label: 'mindsmith' })","","        if (children.mental) {","            const selected = fields.mental.value","            const traits = deepClone(weapon._source.system.traits?.value ?? [])","            if (!traits.includes(selected)) traits.push(selected)","            updateItem({ _id: weapon.id, 'system.traits.value': traits })","            messages.add('mindsmith', {","                selected: utils.weaponTraitLabel(selected),","                uuid: children.mental.uuid,","                label: 'mentalforge',","            })","        }","","        if ((children.advanced || children.runic) && utils.hasFreePropertySlot(weapon)) {","            const child = children.advanced ?? children.runic","            const freeSlot = utils.getFreePropertyRuneSlot(weapon)","            const field = fields.advanced ?? fields.runic","            const selected = field.value","","            if (!weapon.system.runes.property.includes(selected)) {","                updateItem({ _id: weapon.id, [`system.${freeSlot}.value`]: selected, [`flags.world.runeSlot`]: freeSlot })","                messages.add('mindsmith', {","                    selected: utils.weaponPropertyRunesLabel(selected),","                    uuid: child.uuid,","                    label: 'runicmind',","                })","            }","        }","    },","    rest: ({ item, sourceId, updateItem }) => {","        if (sourceId !== MIND_WEAPON_UUID) return","","        let traits = item._source.system.traits?.value ?? []","        traits = traits.filter(trait => !WEAPON_TRAITS.includes(trait))","        updateItem({ _id: item.id, 'system.traits.value': traits })","","        const runeSlot = item.getFlag('world', 'runeSlot')","        if (runeSlot) {","            updateItem({ _id: item.id, [`system.${runeSlot}.value`]: null, [`flags.world.-=runeSlot`]: true })","        }","    },","}","","const OPTIONS = {","    0: 'A one-handed weapon that deals <strong>1d4</strong> damage and has the <strong>agile</strong> and <strong>finesse</strong> traits',","    1: 'A one-handed weapon that deals <strong>1d6</strong> damage and has the <strong>finesse</strong> trait',","    2: 'A one-handed weapon that deals <strong>1d8</strong> damage',","    3: 'A two-handed weapon that deals <strong>1d10</strong> damage and has the <strong>reach</strong> trait',","}","","/** * @param {DailyValueArgs<MindGenerics>} args */","async function fix({ actor }) {","    let content =","        `<p>This character doesn't have a mind weapon in their inventory.</p><p>Please select one of the following options to create one.</p>`","","    for (const [key, label] of Object.entries(OPTIONS)) {","        content += `<label><input type='radio' name='type' value='${key}'>${label}</label>`","    }","","    const weapon = await Dialog.wait(","        {","            title: 'Mind Weapon',","            content,","            buttons: {","                yes: {","                    icon: `<i class='fas fa-save'></i>`,","                    label: 'Accept',","                    callback: onWeaponSelected,","                },","                no: {","                    icon: `<i class='fas fa-times'></i>`,","                    label: 'Cancel',","                    callback: () => null,","                },","            },","            close: () => null,","        },","        {},","        { id: 'pf2e-dailies-weapon', width: 600 }","    )","","    if (weapon) {","        await actor.createEmbeddedDocuments('Item', [weapon])","        return true","    }","","    return false","}","","/** @params {JQuery} html */","async function onWeaponSelected(html) {","    const selection = html.find('[name=type]:checked').val()","    if (!selection) {","        ui.notifications.warn('You must select one weapon base type.')","        return","    }","","    const weapon = (await fromUuid(MIND_WEAPON_UUID))?.toObject()","    if (!weapon) {","        ui.notifications.warn(`The weapon couldn't be found in the compendium.`)","        return","    }","","    const stats = WEAPON_BASE_TYPES[selection]","","    setProperty(weapon, 'system.damage.die', stats.die)","    setProperty(weapon, 'system.traits.value', stats.traits.slice())","    setProperty(weapon, 'system.usage.value', stats.usage)","","    return weapon","}","","return mindSmith"].join(`
`);var Pn=["/** @typedef {'first' | 'second' | 'third' | 'fourth'} SavantRow */","/** @typedef {Record<SavantRow, { level: number; condition: boolean }>} SavantCustom */","/** @typedef {[SavantRow, SavantCustom, '']} SavantGenerics */","","const ROWS = /** @type {const} */ (['first', 'second', 'third', 'fourth'])","","/**"," * @param {CharacterPF2e} actor"," * @param {MagicTradition} tradition"," */","function getSpellcastingTraditionDetails(actor, tradition) {","    let maxSlot = 1","    let maxTradition = 0","","    for (const entry of actor.spellcasting.regular) {","        if ('pf2e-staves' in entry.flags) continue // we skip staff entries","","        const slots = entry.system.slots","        for (const key in slots) {","            const slot = slots[key]","            if (slot.max) maxSlot = Math.max(maxSlot, Number(key.slice(4)))","        }","","        if (entry.tradition === tradition) maxTradition = Math.max(maxTradition, entry.rank)","    }","","    return { maxSlot: Math.min(maxSlot, 10), maxTradition }","}","","/** @type {Daily<SavantGenerics>} */","const scrollSavant = {","    key: 'savant',","    item: {","        uuid: 'Compendium.pf2e.feats-srd.Item.u5DBg0LrBUKP0JsJ', // Scroll Savant","    },","    prepare: ({ actor }) => {","        const { maxSlot, maxTradition } = getSpellcastingTraditionDetails(actor, 'arcane')","        return {","            first: { level: maxSlot - 2, condition: true },","            second: { level: maxSlot - 3, condition: true },","            third: { level: maxSlot - 4, condition: maxTradition >= 3 && maxSlot >= 5 },","            fourth: { level: maxSlot - 5, condition: maxTradition >= 4 && maxSlot >= 6 },","        }","    },","    rows: ROWS.map(rowName => {","        /** @type {DailyRowDrop<SavantGenerics>} */","        const row = {","            type: 'drop',","            slug: rowName,","            label: ({ custom }) => `PF2E.SpellLevel${custom[rowName].level}`,","            filter: {","                type: 'spell',","                search: ({ custom }) => ({","                    category: ['spell'],","                    traditions: ['arcane'],","                    level: custom[rowName].level,","                }),","            },","            condition: ({ custom }) => custom[rowName].condition,","        }","        return row","    }),","    process: async ({ utils, fields, custom, addItem, messages }) => {","        for (const field of Object.values(fields)) {","            const uuid = field.uuid","            const source = await utils.createSpellScrollSource({ uuid, level: custom[field.row].level })","            addItem(source)","            messages.add('scrolls', { uuid, label: source.name })","        }","    },","}","","return scrollSavant"].join(`
`);var Rn=["/** @typedef {typeof ROWS[number]} TomeRow */","/** @typedef {'adept' | 'second' | 'intense' | 'paragon'} TomeChild */","/** @typedef {Record<TomeRow, { rank: OneToFour; options: string[] }>} TomeCustom */","/** @typedef {[TomeRow, TomeCustom, TomeChild]} TomeGenerics */","","const ROWS = /** @type {const} */ (['first', 'second'])","","/** @param {'adept' | 'paragon'} option */","function createChildCondition(option) {","    /** @type { BaseDailyConditionFunction<TomeGenerics>} */","    const condition = ({ item, utils }) => {","        return utils.getChoiSetRuleSelection(item, option) === 'tome'","    }","    return condition","}","","/** @type {Daily<TomeGenerics>} */","const thaumaturgeTome = {","    key: 'tome',","    item: {","        uuid: 'Compendium.pf2e.classfeatures.Item.MyN1cQgE0HsLF20e', // Tome","    },","    children: [","        {","            slug: 'adept',","            uuid: 'Compendium.pf2e.classfeatures.Item.Obm4ItMIIr0whYeO', // Implement Adept","            condition: createChildCondition('adept'),","        },","        {","            slug: 'second',","            uuid: 'Compendium.pf2e.classfeatures.Item.ZEUxZ4Ta1kDPHiq5', // Second Adept","            condition: createChildCondition('adept'),","        },","        {","            slug: 'intense',","            uuid: 'Compendium.pf2e.feats-srd.Item.yRRM1dsY6jakEMaC', // Intense Implement","        },","        {","            slug: 'paragon',","            uuid: 'Compendium.pf2e.classfeatures.Item.QEtgbY8N2V4wTbsI', // Implement Paragon","            condition: createChildCondition('paragon'),","        },","    ],","    prepare: ({ utils, actor, children }) => {","        const skillNames = utils.skillNames","        const actorLevel = actor.level","        const actorSkills = /** @type {Record<SkillLongForm, { rank: ZeroToFour }>} */ (actor.skills)","","        /** @type {TomeCustom} */","        const custom = {","            first: { options: [], rank: 1 },","            second: { options: [], rank: 1 },","        }","","        // Implement Paragon","        if (children.paragon) {","            const skills = skillNames.filter(x => actorSkills[x].rank < 4)","            custom.first = { rank: 4, options: skills }","            custom.second = { rank: 4, options: skills }","        }","        // Intense Implement or Second Adept or Implement Adept","        else if (children.intense || children.adept || children.second) {","            const masters = skillNames.filter(x => actorSkills[x].rank < 3)","","            if (actorLevel >= 9) {","                custom.first = { rank: 3, options: masters }","                custom.second = { rank: 3, options: masters }","            } else {","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 2, options: experts }","                custom.second = { rank: 3, options: masters }","            }","        }","        // Tome","        else {","            if (actorLevel >= 5) {","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 2, options: experts }","                custom.second = { rank: 2, options: experts }","            } else if (actorLevel >= 3) {","                const trained = skillNames.filter(x => actorSkills[x].rank < 1)","                const experts = skillNames.filter(x => actorSkills[x].rank < 2)","                custom.first = { rank: 1, options: trained }","                custom.second = { rank: 2, options: experts }","            } else {","                const trained = skillNames.filter(x => actorSkills[x].rank < 1)","                custom.first = { rank: 1, options: trained }","                custom.second = { rank: 1, options: trained }","            }","        }","","        return custom","    },","    rows: ROWS.map(rowName => {","        /** @type {DailyRowCombo<TomeGenerics>} */","        const row = {","            type: 'combo',","            slug: rowName,","            label: ({ custom, utils }) => utils.proficiencyLabel(custom[rowName].rank),","            options: ({ custom }) => custom[rowName].options,","            labelizer: ({ utils }) => utils.skillLabel,","        }","        return row","    }),","    process: ({ custom, fields, utils, messages, addItem, addRule }) => {","        messages.addGroup('tome', 65)","","        for (const rowName of ROWS) {","            const rank = custom[rowName].rank","            let value = fields[rowName].value","","            if (fields[rowName].input === 'true') {","                const source = utils.createLoreSource({ name: value, rank })","                addItem(source)","            } else {","                const source = utils.createSkillRuleElement({ skill: value, value: rank })","                value = utils.skillLabel(value)","                addRule(source)","            }","","            messages.add('tome', { label: utils.proficiencyLabel(rank), selected: value })","        }","    },","}","","return thaumaturgeTome"].join(`
`);var K=N("customs"),Gr=["default","trainedSkill","trainedLore","language","resistance","feat","spell"],ht=["flexibility","savant","tome","mind"],Qe=class extends FormApplication{static{a(this,"DailyCustoms")}static get defaultOptions(){return mergeObject(FormApplication.defaultOptions,{id:"pf2e-dailies-customs",title:K("title"),template:me("customs"),submitOnChange:!1,submitOnClose:!1,closeOnSubmit:!1,scrollY:[".left .list"]})}async _updateObject(t,n){}async getData(t){let n=L("customDailies"),r=n.find(l=>l.key===this._selectedDaily)?.code,s=this._selectedTemplate,o=game.modules.get("pf2e-dailies-ext"),i=o?.active&&isNewerVersion(vt,o.version)?{version:vt}:"";return mergeObject(super.getData(t),{i18n:K.template,template:s,templates:Gr,daily:this._selectedDaily,code:r,customs:n,examples:ht,isExample:ht.includes(s),monaco:o?.active,newVersion:i})}activateListeners(t){super.activateListeners(t),this._monaco?.dispose();let n=game.modules.get("pf2e-dailies-ext")?.api,r=t.find(".code")[0];if(n&&r){let s=t.find(".monaco .placeholder")[0];this._monaco=n.createEditor(s,r.value),this._monaco.onDidChangeModelContent(debounce(()=>{r.value=this._monaco.getValue()},200))}else this._monaco=null;t.find("[data-action=select-template]").on("change",this.#i.bind(this)),t.find("[data-action=create-template]").on("click",this.#o.bind(this)),t.find("[data-action=create-daily]").on("click",this.#n.bind(this)),t.find(".row[data-key]").on("click",this.#s.bind(this)),t.find("[data-action=delete-daily]").on("click",this.#r.bind(this)),t.find("[data-action=save-code]").on("click",this.#e.bind(this))}get code(){return this.form.querySelector(".window-content .code")?.value}async#e(t){t.preventDefault();let n=this.code,r=this._selectedDaily;if(!r||!n)return;let s=L("customDailies"),o=s.filter(i=>i.key!==r);try{let u=(await new Re(n)()).key;if(typeof u!="string")return P("invalidKey");if(o.find(d=>d.key===u))return P("duplicate");let c=s.findIndex(d=>d.key===r);if(c<0)return;s.splice(c,1,{key:u,code:n}),await Ne("customDailies",s),K.info("saved",{daily:u}),this._selectedDaily=u,this.render()}catch(i){j("error.unexpected"),console.error(i),console.error(`The error occured while testing the custom daily ${r}`)}}async#r(t){if(t.preventDefault(),t.stopPropagation(),!await Dialog.confirm({title:K("delete.title"),content:K("delete.content")}))return;let r=t.currentTarget.dataset.key,s=L("customDailies").filter(o=>o.key!==r);await Ne("customDailies",s),K.info("deleted",{daily:r}),this.#n()}#n(){this._selectedDaily="",this._selectedTemplate="default",this.render()}#s(t){t.preventDefault(),this._selectedDaily=t.currentTarget.dataset.key,this.render()}async#o(t){t.preventDefault();let n=this._selectedTemplate,r=L("customDailies"),s=new FormData(this.form),o=Object.fromEntries(s),i=ht.includes(n),{key:l,uuid:u,label:c}=o;if(i)l=n;else if(!l||!u)return K.warn("template.noEmpty");if(r.find(p=>p.key===l))return P("error.duplicate");let d;if(n==="trainedSkill"){let p=ae(l,u,c);d=this.#t(p,{key:l,uuid:u,label:c},"SkillGenerics")}else if(n==="trainedLore"){let p=Ge(l,u,c);d=this.#t(p,{key:l,uuid:u,label:c},"SkillGenerics")}else if(n==="language"){let p=be(l,u,c);d=this.#t(p,{key:l,uuid:u,label:c},"LanguageGenerics")}else if(n==="resistance"){let p=bt(o.resistance),y=de(o.resistances);if(p===""||!y.length)return K.warn("template.noEmpty");if(typeof p=="number"&&p<1)return K.warn("template.badResistance");let f=ve(l,u,y,p,c);d=this.#t(f,{key:l,uuid:u,label:c,resistance:p,resistances:y},"ResistanceGenerics")}else if(n==="feat"){let p=de(o.traits),y={category:de(o.category),level:bt(o.level)||{min:0,max:20}};p.length&&(y.traits=p);let f=On(l,u,y,c);d=this.#t(f,{key:l,uuid:u,label:c},"FeatGenerics")}else if(n==="spell"){let p=Number(o.level)||void 0,y=de(o.traits),f=o.levels.split(",").map(h=>h.trim());f.length===1?f=bt(f[0]):f=f.filter(h=>h).map(h=>Number(h)).filter(h=>!Number.isNaN(h));let m={category:de(o.category),traditions:de(o.traditions),level:f||[]};y.length&&(m.traits=y);let g=Ue(l,u,m,p,c);d=this.#t(g,{key:l,uuid:u,label:c,level:p},"SpellGenerics")}else if(n==="tome")d=Rn;else if(n==="flexibility")d=An;else if(n==="savant")d=Pn;else if(n==="mind")d=Fn;else{let p={key:l,label:c,item:{uuid:u},rows:[],process:()=>{}};d=this.#t(p,{key:l,uuid:u,label:c})}r.push({key:l,code:d}),await Ne("customDailies",r),this._selectedDaily=l,this.render()}#t(t,n,r){let s="____PLACEHOLDER____",o=[],i=JSON.stringify(t,(c,d)=>typeof d=="function"?(o.push(d),s):d,4);i=i.replace(new RegExp(`"${s}"`,"g"),()=>o.shift()?.toString()?.replace(/( {5,})/g,d=>d.slice(4))??"");let l="";for(let[c,d]of Object.entries(n))typeof d=="string"?l+=`const ${c} = '${d}';
`:typeof d=="object"?l+=`const ${c} = ${JSON.stringify(d)};
`:l+=`const ${c} = ${d};
`;let u=r?`Daily<${r}>`:"Daily";return`${l}
/** @type {${u}} */
const daily = ${i};

return daily;`}#i(t){t.preventDefault(),this._selectedDaily="",this._selectedTemplate=t.currentTarget.value,this.render()}};function de(e){return e.split(",").map(t=>t.trim()).filter(t=>t)}a(de,"splitList");function bt(e){if(typeof e=="number")return e;let t=e.trim();if(t==="level"||t==="half")return t;let n=Number(t);return Number.isNaN(n)?"":n}a(bt,"simplyfiable");function Ln(e,t,n){n.restForTheNight&&Et(e,"restForTheNight",!0)}a(Ln,"preCreateChatMessage");function Mn(e,t){T(e,"restForTheNight")&&qr(e,t)}a(Mn,"renderChatMessage");function qr(e,t){let n=e.actor;if(!n.isOwner)return;let r=Oe(n),s=T(e,"prepared"),o=v(`message.dailiesRequest.${!r&&s===void 0?"cleaning":r?"button":"prepared"}`),i=$(`<button type="button">${o}</button>`);t.find(".message-content").append(i),r?i.on("click",()=>ue(n,e)):i.prop("disabled",!0)}a(qr,"renderRestMessage");async function Nn(e,...t){let n=await e(...t);return await Promise.all(n.map(async r=>{let s=r.actor;s?.isOwner&&(await Wr(s),await J(s,"rested",!0),await J(r,"prepared",!1))})),n}a(Nn,"restForTheNightAll");async function Wr(e){let t=[],[n,r]=Ke(),s=V();for(let o of e.items){if(T(o,"temporary")){if(t.push(o.id),o.isOfType("feat")){let c=T(o,"grantedBy");if(c){let p=`flags.pf2e.itemGrants.-=${Q(o.name,{camel:"dromedary"})}`;r({_id:c,[p]:!0})}}continue}if(!s&&o.isOfType("spellcastingEntry")&&o.system.prepared.value==="charge"){t.push(o.id);continue}let i=ne(o);if(i){let c=fn(i);c?.rest&&await c.rest({item:o,sourceId:i,updateItem:r,actor:e})}let l=deepClone(o._source.system.rules),u=!1;for(let c=l.length-1;c>=0;c--)S.id in l[c]&&(l.splice(c,1),u=!0);u&&r({_id:o.id,"system.rules":l})}n.size&&await e.updateEmbeddedDocuments("Item",n.contents),t.length&&await e.deleteEmbeddedDocuments("Item",t)}a(Wr,"onRestForTheNight");Tt("pf2e-dailies");var vt="1.3.0",Br="CONFIG.PF2E.Item.documentClasses.spellcastingEntry.prototype.cast",Hr="CONFIG.PF2E.Actor.documentClasses.character.prototype.performDailyCrafting",Vr="game.pf2e.actions.restForTheNight";Hooks.once("setup",()=>{ee({name:"customDailies",type:Array,default:[],config:!1,onChange:dt}),ee({name:"familiar",type:String,default:""}),ee({name:"staff-regex",type:String,default:qe}),ee({name:"members",type:Boolean,default:!0,scope:"client"}),ee({name:"staff-sort",type:String,default:"top",choices:["top","bottom"],scope:"client"}),ee({name:"filters",type:String,default:"",scope:"client",onChange:pt}),Ot({name:"customs",type:Qe}),Dt().api={openDailiesInterface:e=>ue(e),getBuiltinDailies:()=>deepClone(Te),getCustomDailies:()=>deepClone(Ce),getBuiltinDailyKeys:()=>[un.map(e=>`dailies.${e}`),Te.map(e=>`dailies.${e.key}`)].flat(),getBuiltinDailyKey:e=>{let t=Te.find(n=>n.item.uuid===e||n.children?.some(r=>r.uuid===e));if(t)return`dailies.${t.key}`},prepareDailies:Be,checkCustomDaily:ft,getUtils:()=>deepClone(F),getSpellcastingEntryStaffFlags:Se,getSpellcastingEntryStaffData:xe,updateEntryCharges:we},V()||(CONFIG.PF2E.preparationType.charge="Charge",Me(Br,sn,"MIXED"))});Hooks.once("ready",async()=>{if(V()&&P("staves.conflict",!0),await pt(),!game.modules.get("lib-wrapper")?.active&&game.user.isGM){P("error.noLibwrapper",!0);return}Me(Hr,Cn,"OVERRIDE"),Me(Vr,Nn)});Hooks.on("renderCharacterSheetPF2e",Tn);Hooks.on("preCreateChatMessage",Ln);Hooks.on("renderChatMessage",Mn);})();
//# sourceMappingURL=main.js.map
